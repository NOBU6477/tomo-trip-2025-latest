<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>スピン問題解決 - Loading防止対策</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 20px;
      background-color: #f9f9f9;
      color: #333;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      margin-top: 0;
      color: #0066cc;
    }
    button, .btn {
      background: #0066cc;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      margin-right: 10px;
      margin-bottom: 10px;
      text-decoration: none;
      display: inline-block;
    }
    button:hover, .btn:hover {
      background: #0055aa;
    }
    .options {
      margin: 20px 0;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    pre {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 0.9rem;
    }
    .success {
      color: #28a745;
      font-weight: bold;
    }
    .warning {
      color: #ffc107;
      font-weight: bold;
    }
  </style>
  
  <!-- スピナー排除スクリプト -->
  <script src="replit-spin-killer.js"></script>
  
  <script>
    // ダイアログ対策
    (function() {
      // ダイアログの自動クリック
      setInterval(() => {
        try {
          const buttons = document.querySelectorAll('button');
          buttons.forEach(button => {
            if (button && button.textContent) {
              const text = button.textContent.toLowerCase();
              if (text.includes('待機') || text.includes('wait') || 
                  text.includes('待つ') || text.includes('continue')) {
                console.log('「待機」ボタンを自動クリックします');
                setTimeout(() => button.click(), 10);
              }
            }
          });
        } catch (e) {
          // エラーを無視
        }
      }, 50);
    })();
  </script>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // ログ表示用関数
      function logAction(message, type) {
        const logContainer = document.getElementById('log');
        const entry = document.createElement('div');
        entry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
        if (type) entry.classList.add(type);
        logContainer.prepend(entry);
      }
      
      // スピン排除操作を実行
      window.killSpinners = function() {
        try {
          const spinners = document.querySelectorAll('iframe');
          spinners.forEach(iframe => {
            try {
              const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
              const spinnerElements = iframeDoc.querySelectorAll('.spinner, .loading, [role="progressbar"]');
              spinnerElements.forEach(el => {
                el.style.display = 'none';
                el.style.visibility = 'hidden';
              });
              
              // bodyを表示
              if (iframeDoc.body) {
                iframeDoc.body.style.visibility = 'visible';
                iframeDoc.body.style.display = 'block';
              }
              
              logAction(`iframe内の${spinnerElements.length}個のスピナーを非表示にしました`, 'success');
            } catch (e) {
              // クロスオリジンエラーは無視
            }
          });
          
          logAction('スピン排除処理を実行しました', 'success');
        } catch (e) {
          logAction(`エラー: ${e.message}`, 'warning');
        }
      };
      
      // 親フレーム操作
      window.fixParentFrame = function() {
        try {
          if (window.parent && window.parent !== window) {
            try {
              // 親フレームのスタイルにアクセス
              const parentStyle = document.createElement('style');
              parentStyle.textContent = `
                .spinner, .loading, [role="progressbar"], [aria-busy="true"],
                *[class*="spinner"], *[class*="loading"],
                *[id*="spinner"], *[id*="loading"],
                .progress, .progress-bar {
                  display: none !important;
                  visibility: hidden !important;
                  opacity: 0 !important;
                }
                iframe {
                  visibility: visible !important;
                  opacity: 1 !important;
                }
                body {
                  visibility: visible !important;
                  display: block !important;
                }
              `;
              
              window.parent.document.head.appendChild(parentStyle);
              logAction('親フレームにスタイルを注入しました', 'success');
            } catch (e) {
              logAction(`親フレーム操作エラー: ${e.message}`, 'warning');
            }
          } else {
            logAction('親フレームが存在しないか、同一オリジンではありません', 'warning');
          }
        } catch (e) {
          logAction(`エラー: ${e.message}`, 'warning');
        }
      };
      
      // 自動的に実行
      setTimeout(killSpinners, 500);
      setTimeout(fixParentFrame, 1000);
    });
  </script>
</head>
<body>
  <div class="container">
    <h1>Replit スピン問題解決ツール</h1>
    <p>このページは、Replitのプレビューで発生する「Loading your page...」と無限スピナーの問題を解決するためのツールです。</p>
    
    <div class="options">
      <button onclick="killSpinners()">スピナー排除を実行</button>
      <button onclick="fixParentFrame()">親フレーム修正</button>
      <a href="/emergency" class="btn">緊急スタンドアロンページへ</a>
      <a href="/" class="btn">トップページへ戻る</a>
    </div>
    
    <h2>アクションログ</h2>
    <div id="log" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-bottom: 20px;"></div>
    
    <h2>スピナー対策コード</h2>
    <pre>
// スピナーキラーコア処理
function killSpinners() {
  // スピナー要素を非表示
  var spinners = document.querySelectorAll('.spinner, .loading, [role="progressbar"]');
  for (var i = 0; i < spinners.length; i++) {
    spinners[i].style.display = 'none';
    spinners[i].style.visibility = 'hidden';
  }
  
  // body要素を強制表示
  document.body.style.visibility = 'visible';
  document.body.style.display = 'block';
}

// 定期的に実行
setInterval(killSpinners, 100);

// iframe内も処理
var iframes = document.querySelectorAll('iframe');
for (var i = 0; i < iframes.length; i++) {
  try {
    var iframe = iframes[i];
    var doc = iframe.contentDocument || iframe.contentWindow.document;
    var style = doc.createElement('style');
    style.textContent = '.spinner, .loading { display: none !important; }';
    doc.head.appendChild(style);
  } catch (e) {
    // クロスオリジンエラーは無視
  }
}
</pre>
  </div>
</body>
</html>