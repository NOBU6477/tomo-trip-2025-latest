<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>報酬ダッシュボード</title>
  <style>
    table {
      border-collapse: collapse;
      width: 100%;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #1e90ff;
      color: white;
    }
    .unclaimed {
      color: red;
    }
    .paid {
      color: green;
    }
  </style>
</head>
<body>
  <h2>報酬ダッシュボード</h2>

  <label><input type="checkbox" id="filter-current-month"> 今月のみ</label>
  <label><input type="checkbox" id="filter-target-store"> 特定店舗のみ（カフェ東京）</label>

  <table id="data-table">
    <thead>
      <tr>
        <th>店舗ID</th>
        <th>店舗名</th>
        <th>ガイドID</th>
        <th>ガイド名</th>
        <th>今月送客数</th>
        <th>累計送客数</th>
        <th>今月広告費</th>
        <th>ガイド紹介料</th>
        <th>運営利益</th>
        <th>請求ステータス</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>S001</td>
        <td>カフェ東京</td>
        <td>G001</td>
        <td>山田ガイド</td>
        <td>12</td>
        <td>98</td>
        <td></td> <!-- 自動計算 -->
        <td></td> <!-- 自動計算 -->
        <td></td> <!-- 自動計算 -->
        <td contenteditable="true">請求済み</td>
      </tr>
      <tr>
        <td>S002</td>
        <td>ナイト大阪</td>
        <td>G002</td>
        <td>田中ガイド</td>
        <td>9</td>
        <td>215</td>
        <td></td>
        <td></td>
        <td></td>
        <td contenteditable="true">未請求</td>
      </tr>
    </tbody>
  </table>

  <p style="margin-top:10px; font-size: 12px; color:#555;">
    ※CSVファイル名には今日の日付（例：2025-05-13）が付きます
  </p>

  <button onclick="setExportMode('ledger')">帳簿用出力</button>
  <button onclick="setExportMode('unclaimed')">未請求一覧出力</button>
  <button onclick="downloadCSV()">CSV出力</button>

  <script>
    const table = document.getElementById("data-table");
    const filterCurrentMonth = document.getElementById("filter-current-month");
    const filterTargetStore = document.getElementById("filter-target-store");

    // 各種記録保存
    window.addEventListener("load", () => {
      filterCurrentMonth.checked = localStorage.getItem("filter-current-month") === "true";
      filterTargetStore.checked = localStorage.getItem("filter-target-store") === "true";

      // 請求ステータス保存
      document.querySelectorAll("td[contenteditable='true']").forEach((cell, i) => {
        const saved = localStorage.getItem("cell-" + i);
        if (saved) cell.textContent = saved;
      });

      calculateRewards(); // ページ読み込み時に報酬再計算
    });

    filterCurrentMonth.addEventListener("change", () => {
      localStorage.setItem("filter-current-month", filterCurrentMonth.checked);
    });
    filterTargetStore.addEventListener("change", () => {
      localStorage.setItem("filter-target-store", filterTargetStore.checked);
    });

    document.querySelectorAll("td[contenteditable='true']").forEach((cell, i) => {
      cell.addEventListener("input", () => {
        localStorage.setItem("cell-" + i, cell.textContent);
      });
    });

    let exportMode = "ledger";
    function setExportMode(mode) {
      exportMode = mode;
      alert("出力モードが " + (mode === "ledger" ? "帳簿用" : "未請求一覧") + " に切り替わりました");
    }

    function downloadCSV() {
      calculateRewards(); // 出力前に再計算

      const rows = [];
      const trs = table.querySelectorAll("tbody tr");

      trs.forEach(tr => {
        const cells = tr.querySelectorAll("td");
        const thisMonth = parseInt(cells[4].textContent);
        const store = cells[1].textContent.trim();
        const status = cells[9].textContent.trim();

        if (filterCurrentMonth.checked && thisMonth === 0) return;
        if (filterTargetStore.checked && store !== "カフェ東京") return;
        if (exportMode === "unclaimed" && status !== "未請求") return;

        const row = Array.from(cells).map(c => `"${c.textContent.replace(/"/g, '""')}"`);
        rows.push(row.join(","));
      });

      const header = Array.from(table.querySelectorAll("thead th")).map(th => `"${th.textContent}"`).join(",");
      rows.unshift(header);

      const today = new Date().toISOString().split("T")[0];
      const filename = (exportMode === "ledger" ? "ledger_" : "unclaimed_") + today + ".csv";
      const BOM = "\uFEFF";
      const blob = new Blob([BOM + rows.join("\n")], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    function calculateRewards() {
      const rows = table.querySelectorAll("tbody tr");
      rows.forEach(tr => {
        const tds = tr.querySelectorAll("td");
        const sendCount = parseInt(tds[4].textContent) || 0;

        // 今月の広告費
        let baseFee = 0;
        if (sendCount === 0) baseFee = 0;
        else if (sendCount > 0 && sendCount <= 10) baseFee = sendCount <= 10 ? 7500 : 15000;
        else baseFee = 15000 + (sendCount - 10) * 100;

        // 紹介料ルール（10人送客以上のみ対象）
        const guideFee = sendCount >= 10 ? 5000 : 0;

        // 運営利益
        const adminFee = baseFee - guideFee;

        tds[6].textContent = "¥" + baseFee.toLocaleString();
        tds[7].textContent = guideFee > 0 ? "¥5,000" : "¥0";
        tds[8].textContent = "¥" + adminFee.toLocaleString();
      });
    }
  </script>
</body>
</html>










