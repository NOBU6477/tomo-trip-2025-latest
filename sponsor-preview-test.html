<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>協賛店プレビューテスト - TomoTrip</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .preview-card { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-radius: 20px; }
    </style>
</head>
<body>
    <div class="container my-4">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="preview-card p-4">
                    <h2 class="text-center mb-4">プレビューテスト</h2>
                    
                    <div class="alert alert-info">
                        <h5>テスト用データ作成</h5>
                        <button class="btn btn-primary" onclick="createTestData()">テストデータ作成</button>
                        <button class="btn btn-success ms-2" onclick="checkData()">データ確認</button>
                        <button class="btn btn-warning ms-2" onclick="clearData()">データクリア</button>
                    </div>
                    
                    <div class="alert alert-secondary">
                        <h5>ストレージ状況</h5>
                        <div id="storageInfo">読み込み中...</div>
                    </div>
                    
                    <div class="mt-4">
                        <h5>利用可能な協賛店ID</h5>
                        <div id="availableIds" class="mb-3">読み込み中...</div>
                        
                        <div class="input-group">
                            <input type="text" id="testId" class="form-control" placeholder="テスト用ID入力">
                            <button class="btn btn-primary" onclick="testPreview()">プレビューテスト</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function createTestData() {
            // 複数のテストデータを作成
            const testDataArray = [
                {
                    id: 'sponsor_1754226867590',  // 実際に不足していたID
                    storeName: '浅草老舗寿司店',
                    category: 'restaurant',
                    address: '東京都台東区浅草2-3-1',
                    phone: '03-3841-0001',
                    email: 'info@asakusa-sushi.jp',
                    website: 'https://asakusa-sushi.jp',
                    openTime: '11:00',
                    closeTime: '21:30',
                    holidays: '水曜日',
                    detailedDescription: '創業100年の老舗寿司店。新鮮な江戸前寿司をお楽しみいただけます。',
                    detailedDiscount: 'TomoTripユーザーには10%割引',
                    published: true,
                    status: 'active',
                    createdAt: new Date().toISOString(),
                    lastUpdated: new Date().toISOString()
                },
                {
                    id: 'sponsor_test_' + Date.now(),
                    storeName: '渋谷カフェ＆ギャラリー',
                    category: 'restaurant',
                    address: '東京都渋谷区道玄坂1-5-8',
                    phone: '03-5784-1234',
                    email: 'hello@shibuya-cafe.com',
                    website: 'https://shibuya-cafe.com',
                    openTime: '8:00',
                    closeTime: '23:00',
                    holidays: '無休',
                    detailedDescription: 'アートギャラリーを併設したモダンカフェ。自家焙煎コーヒーと手作りスイーツが自慢です。',
                    detailedDiscount: 'TomoTripユーザーにはドリンク1杯無料',
                    published: true,
                    status: 'active',
                    createdAt: new Date().toISOString(),
                    lastUpdated: new Date().toISOString()
                },
                {
                    id: 'sponsor_kyoto_' + Date.now(),
                    storeName: '京都伝統工芸館',
                    category: 'shopping',
                    address: '京都府京都市東山区清水2-208',
                    phone: '075-561-1234',
                    email: 'info@kyoto-craft.jp',
                    website: 'https://kyoto-craft.jp',
                    openTime: '9:00',
                    closeTime: '18:00',
                    holidays: '月曜日',
                    detailedDescription: '京都の伝統工芸品を展示・販売。職人による実演も見学できます。',
                    detailedDiscount: 'TomoTripユーザーには15%割引＋記念品プレゼント',
                    published: true,
                    status: 'active',
                    createdAt: new Date().toISOString(),
                    lastUpdated: new Date().toISOString()
                }
            ];
            
            try {
                let successCount = 0;
                
                testDataArray.forEach(testData => {
                    try {
                        // 複数の場所に保存
                        localStorage.setItem(`preview_${testData.id}`, JSON.stringify(testData));
                        localStorage.setItem(`store_${testData.id}`, JSON.stringify(testData));
                        localStorage.setItem(testData.id, JSON.stringify(testData));  // 直接IDキーでも保存
                        successCount++;
                    } catch (error) {
                        console.error('Failed to save test data:', testData.storeName, error);
                    }
                });
                
                // registeredSponsorsも更新
                const registeredSponsors = JSON.parse(localStorage.getItem('registeredSponsors') || '[]');
                testDataArray.forEach(testData => {
                    const existingIndex = registeredSponsors.findIndex(s => s.id === testData.id);
                    if (existingIndex !== -1) {
                        registeredSponsors[existingIndex] = testData;
                    } else {
                        registeredSponsors.push(testData);
                    }
                });
                
                // サイズチェック後に保存
                const dataSize = new Blob([JSON.stringify(registeredSponsors)]).size;
                if (dataSize < 2 * 1024 * 1024) { // 2MB未満なら保存
                    localStorage.setItem('registeredSponsors', JSON.stringify(registeredSponsors));
                }
                
                alert(`テストデータを${successCount}件作成しました`);
                updateDisplay();
            } catch (error) {
                alert('エラー: ' + error.message);
            }
        }
        
        function checkData() {
            const registeredSponsors = JSON.parse(localStorage.getItem('registeredSponsors') || '[]');
            console.log('Registered sponsors:', registeredSponsors);
            
            const keys = Object.keys(localStorage);
            const sponsorKeys = keys.filter(key => key.startsWith('sponsor_') || key.startsWith('preview_') || key.startsWith('store_'));
            console.log('Sponsor-related keys:', sponsorKeys);
            
            alert(`登録済み協賛店: ${registeredSponsors.length}件\nストレージキー: ${sponsorKeys.length}件`);
        }
        
        function clearData() {
            if (confirm('全ての協賛店データを削除しますか？')) {
                const keys = Object.keys(localStorage);
                keys.forEach(key => {
                    if (key.startsWith('sponsor_') || key.startsWith('preview_') || key.startsWith('store_') || key === 'registeredSponsors') {
                        localStorage.removeItem(key);
                    }
                });
                alert('データをクリアしました');
                updateDisplay();
            }
        }
        
        function updateDisplay() {
            // ストレージ情報更新
            const storageUsed = JSON.stringify(localStorage).length;
            const storageMax = 5 * 1024 * 1024; // 5MB
            const usagePercent = ((storageUsed / storageMax) * 100).toFixed(1);
            
            document.getElementById('storageInfo').innerHTML = `
                使用量: ${(storageUsed / 1024).toFixed(1)} KB / ${(storageMax / 1024).toFixed(0)} KB (${usagePercent}%)
            `;
            
            // 利用可能なID一覧
            const keys = Object.keys(localStorage);
            const sponsorIds = keys.filter(key => key.startsWith('sponsor_') || key.startsWith('preview_')).map(key => key.replace(/^(sponsor_|preview_)/, ''));
            const uniqueIds = [...new Set(sponsorIds)];
            
            document.getElementById('availableIds').innerHTML = uniqueIds.length > 0 
                ? uniqueIds.map(id => `<span class="badge bg-secondary me-1 mb-1">${id}</span>`).join('')
                : '<span class="text-muted">データがありません</span>';
        }
        
        function testPreview() {
            const testId = document.getElementById('testId').value.trim();
            if (!testId) {
                alert('IDを入力してください');
                return;
            }
            
            const previewUrl = `sponsor-preview.html?id=${testId}`;
            const previewWindow = window.open(previewUrl, '_blank', 'width=1200,height=800');
            
            if (!previewWindow) {
                window.location.href = previewUrl;
            }
        }
        
        // ページ読み込み時に表示更新
        document.addEventListener('DOMContentLoaded', updateDisplay);
    </script>
</body>
</html>