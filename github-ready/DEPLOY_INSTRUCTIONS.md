# ローカルガイドアプリケーション デプロイ手順

このドキュメントでは、ローカルガイドアプリケーションをReplitにデプロイする方法を説明します。

## 開発環境

- **フロントエンド**: HTML, CSS, JavaScript (Bootstrap 5)
- **バックエンド**: Node.js, Express 4.18.2
- **サーバー設定**: `index.js` (Expressサーバー)

## デプロイ前の準備

1. プロジェクトがNode.jsサーバーとして動作するように設定されていることを確認します。
2. バックアップを作成します: `bash backup-current-state.sh`
3. Node.jsサーバーが正常に動作することを確認します。

## Replitでのデプロイ手順

1. Replitダッシュボードにアクセスします。
2. プロジェクトページの「Deploy」ボタンをクリックします。
3. デプロイ設定を確認・修正します：
   - **Run command**: `node deploy_direct.js`（最も確実な解決策）
   - **Port**: 5000（重要：Replitのデプロイ環境では環境変数PORTに自動的に値が設定されます）
4. もし`.replit`ファイルに`[deployment]`セクションがある場合は、以下のように設定されていることを理想としますが、直接編集できない場合もあります：
   ```
   [deployment]
   run = ["sh", "-c", "node deploy_direct.js"]
   ```
5. 「Deploy to Production」ボタンをクリックします。
6. デプロイが完了すると、公開URLが表示されます。

## 重要な設定変更

最新の修正では、以下の変更を行いました：
- ポートは5000に設定済み（Replitのウェブプレビュー機能はポート5000のみにアクセス可能）
- Replitのヘルスチェックエンドポイント（`/.replit/health`）を追加しました
- 詳細なシステム情報ログを追加しました

## トラブルシューティング

デプロイに問題がある場合は、以下の点を確認してください：

1. **ポート設定**: アプリケーションは環境変数`PORT`の値を優先して使用します。ローカルでは5000をデフォルトとしています。
2. **Pythonサーバーの競合**: ログに`python -m http.server`というエラーが表示される場合、Pythonサーバーが競合している可能性があります。Replitのデプロイ設定で実行コマンドを必ず`./start-server.sh`に変更してください。これにより自動的にPythonコマンドがインターセプトされ、根本的に競合が解消されます。
3. **エラーメッセージ**: Replitのデプロイログを確認し、具体的なエラーメッセージを確認します。
4. **依存関係**: 必要なパッケージ（特に `express@4.18.2`）がインストールされているか確認します。
5. **実行中のプロセス**: 問題が続く場合は、コンソールで`ps aux | grep python`を実行し、Pythonサーバープロセスが実行中かどうかを確認します。

## 復元方法

問題が発生した場合は、以下のコマンドでバックアップから復元できます：

```bash
bash restore.sh 20250419_195317_nodejs_deployment_ready
```

## 注意事項

- デプロイ後、Replitの無料プランではアプリケーションがアイドル状態になると自動的に停止します。
- 定期的なアクセスがない場合、アプリケーションの再起動に数秒かかることがあります。
- 本番環境では、環境変数を適切に設定してください。

## サポート

問題が発生した場合は、以下のリソースを参照してください：

- Replit公式ドキュメント: https://docs.replit.com/
- Node.js/Express関連のドキュメント: https://expressjs.com/