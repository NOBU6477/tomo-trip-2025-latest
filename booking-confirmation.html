<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">予約完了 - TomoTrip</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .confirmation-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        
        .confirmation-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .success-header {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 3rem 2rem;
            text-align: center;
        }
        
        .success-icon {
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            color: #28a745;
            font-size: 2rem;
        }
        
        .booking-details {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 2rem;
            margin: 2rem 0;
        }
        
        .next-steps {
            background: #e7f3ff;
            border-left: 4px solid #007bff;
            padding: 1.5rem;
            border-radius: 8px;
            margin: 2rem 0;
        }
        
        .guide-contact {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 1.5rem;
            border-radius: 8px;
            margin: 2rem 0;
        }
        
        .payment-info {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 1.5rem;
            border-radius: 8px;
            margin: 2rem 0;
        }
        
        .btn-action {
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: bold;
            margin: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="confirmation-container">
        <div class="confirmation-card">
            <div class="success-header">
                <div class="success-icon">
                    <i class="bi bi-check2-circle"></i>
                </div>
                <h2 class="fw-bold" id="successTitle">予約が完了しました！</h2>
                <p class="mb-0" id="successMessage">決済が正常に処理され、ガイドに通知を送信しました</p>
            </div>
            
            <div class="p-4">
                <!-- 予約詳細 -->
                <div class="booking-details">
                    <h5 class="fw-bold mb-3" id="bookingDetailsTitle"><i class="bi bi-calendar-check me-2"></i>予約詳細</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center mb-3">
                                <img id="confirmGuideImage" src="" class="rounded-circle me-3" style="width: 80px; height: 80px; object-fit: cover;">
                                <div>
                                    <h6 class="mb-1 fw-bold" id="confirmGuideName">ガイド名</h6>
                                    <small class="text-muted" id="certifiedGuideLabel">認定ガイド</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div id="confirmBookingDetails">
                                <!-- 予約詳細がここに表示 -->
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-md-6">
                            <strong id="bookingNumberLabel">予約番号:</strong> <span id="confirmBookingId">#12345</span>
                        </div>
                        <div class="col-md-6 text-end">
                            <strong id="paymentAmountLabel">お支払い金額:</strong> <span class="text-success fw-bold" id="confirmTotal">¥0</span>
                        </div>
                    </div>
                </div>
                
                <!-- 次のステップ -->
                <div class="next-steps">
                    <h6 class="fw-bold" id="nextStepsTitle"><i class="bi bi-list-check me-2"></i>今後の流れ</h6>
                    <ol class="mb-0" id="nextStepsList">
                        <li><strong>ガイド確認:</strong> ガイドが予約内容を確認し、24時間以内に連絡いたします</li>
                        <li><strong>待ち合わせ確認:</strong> 具体的な集合場所と時間を調整します</li>
                        <li><strong>当日のご案内:</strong> ガイドがお客様をご案内いたします</li>
                        <li><strong>サービス完了:</strong> ガイド終了後、自動的にガイドへお支払いが処理されます</li>
                    </ol>
                </div>
                
                <!-- ガイド連絡先 -->
                <div class="guide-contact">
                    <h6 class="fw-bold" id="guideContactTitle"><i class="bi bi-chat-dots me-2"></i>ガイドとの連絡</h6>
                    <p class="mb-2" id="guideContactDesc">予約が確定次第、ガイドから直接ご連絡いたします。緊急時は以下のボタンからお問い合わせください。</p>
                    <button class="btn btn-success btn-action" onclick="openChat()" id="chatButton">
                        <i class="bi bi-chat me-2"></i>ガイドにメッセージ
                    </button>
                </div>
                
                <!-- 決済・手数料説明 -->
                <div class="payment-info">
                    <h6 class="fw-bold" id="paymentInfoTitle"><i class="bi bi-info-circle me-2"></i>決済について</h6>
                    <div class="row">
                        <div class="col-md-8" id="paymentInfoContent">
                            <p class="mb-2"><strong>お客様のお支払い:</strong> 決済完了済み</p>
                            <p class="mb-2"><strong>ガイドへの支払い:</strong> サービス完了後に自動処理</p>
                            <p class="mb-0"><small class="text-muted">※ガイドには手数料（20%）を差し引いた金額をお支払いします</small></p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="badge bg-success fs-6" id="paymentStatusBadge">決済完了</div>
                        </div>
                    </div>
                </div>
                
                <!-- アクションボタン -->
                <div class="text-center mt-4">
                    <button class="btn btn-primary btn-action" onclick="viewBookings()" id="viewBookingsButton">
                        <i class="bi bi-calendar3 me-2"></i>予約一覧を見る
                    </button>
                    <button class="btn btn-outline-secondary btn-action" onclick="goHome()" id="homeButton">
                        <i class="bi bi-house me-2"></i>ホームに戻る
                    </button>
                </div>
                
                <!-- 緊急連絡先 -->
                <div class="text-center mt-4 pt-4 border-top">
                    <small class="text-muted" id="emergencyContact">
                        <i class="bi bi-telephone me-1"></i>緊急時連絡先: 
                        <a href="tel:+81-3-1234-5678" class="text-decoration-none">03-1234-5678</a>
                        （24時間対応）
                    </small>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let bookingData = null;
        let currentLanguage = 'ja'; // デフォルトは日本語
        
        // 翻訳データ
        const translations = {
            ja: {
                title: '予約完了 - TomoTrip',
                successTitle: '予約が完了しました！',
                successMessage: '決済が正常に処理され、ガイドに通知を送信しました',
                bookingDetails: '予約詳細',
                certifiedGuide: '認定ガイド',
                bookingNumber: '予約番号:',
                paymentAmount: 'お支払い金額:',
                nextSteps: '今後の流れ',
                nextStepsList: [
                    '<strong>ガイド確認:</strong> ガイドが予約内容を確認し、24時間以内に連絡いたします',
                    '<strong>待ち合わせ確認:</strong> 具体的な集合場所と時間を調整します',
                    '<strong>当日のご案内:</strong> ガイドがお客様をご案内いたします',
                    '<strong>サービス完了:</strong> ガイド終了後、自動的にガイドへお支払いが処理されます'
                ],
                guideContact: 'ガイドとの連絡',
                guideContactDesc: '予約が確定次第、ガイドから直接ご連絡いたします。緊急時は以下のボタンからお問い合わせください。',
                chatButton: 'ガイドにメッセージ',
                paymentInfo: '決済について',
                paymentInfoContent: `
                    <p class="mb-2"><strong>お客様のお支払い:</strong> 決済完了済み</p>
                    <p class="mb-2"><strong>ガイドへの支払い:</strong> サービス完了後に自動処理</p>
                    <p class="mb-0"><small class="text-muted">※ガイドには手数料（20%）を差し引いた金額をお支払いします</small></p>
                `,
                paymentStatus: '決済完了',
                viewBookings: '予約一覧を見る',
                goHome: 'ホームに戻る',
                emergencyContact: '<i class="bi bi-telephone me-1"></i>緊急時連絡先: <a href="tel:+81-3-1234-5678" class="text-decoration-none">03-1234-5678</a>（24時間対応）',
                date: '日付',
                time: '時間',
                duration: '時間',
                participants: '参加者',
                specialRequests: '特別リクエスト'
            },
            en: {
                title: 'Booking Confirmed - TomoTrip',
                successTitle: 'Booking Completed!',
                successMessage: 'Payment processed successfully and guide has been notified',
                bookingDetails: 'Booking Details',
                certifiedGuide: 'Certified Guide',
                bookingNumber: 'Booking Number:',
                paymentAmount: 'Payment Amount:',
                nextSteps: 'Next Steps',
                nextStepsList: [
                    '<strong>Guide Confirmation:</strong> Guide will review booking and contact you within 24 hours',
                    '<strong>Meeting Point:</strong> Specific meeting location and time will be arranged',
                    '<strong>Tour Day:</strong> Guide will provide your tour experience',
                    '<strong>Service Complete:</strong> Payment to guide will be processed automatically after tour completion'
                ],
                guideContact: 'Contact with Guide',
                guideContactDesc: 'Once booking is confirmed, the guide will contact you directly. For emergencies, please use the button below.',
                chatButton: 'Message Guide',
                paymentInfo: 'Payment Information',
                paymentInfoContent: `
                    <p class="mb-2"><strong>Your Payment:</strong> Payment completed</p>
                    <p class="mb-2"><strong>Guide Payment:</strong> Automatically processed after service completion</p>
                    <p class="mb-0"><small class="text-muted">※ Guide receives payment minus 20% commission</small></p>
                `,
                paymentStatus: 'Payment Complete',
                viewBookings: 'View Bookings',
                goHome: 'Go Home',
                emergencyContact: '<i class="bi bi-telephone me-1"></i>Emergency Contact: <a href="tel:+81-3-1234-5678" class="text-decoration-none">03-1234-5678</a> (24/7 Support)',
                date: 'Date',
                time: 'Time',
                duration: 'Duration',
                participants: 'Participants',
                specialRequests: 'Special Requests'
            }
        };
        
        document.addEventListener('DOMContentLoaded', function() {
            detectLanguage();
            loadBookingData();
        });
        
        function detectLanguage() {
            // 1. URL parameter check
            const urlParams = new URLSearchParams(window.location.search);
            const langParam = urlParams.get('lang');
            
            if (langParam && (langParam === 'en' || langParam === 'ja')) {
                currentLanguage = langParam;
            } else {
                // 2. Booking data language check
                const tempBookingStr = localStorage.getItem('tempBookingData');
                if (tempBookingStr) {
                    try {
                        const tempBooking = JSON.parse(tempBookingStr);
                        if (tempBooking.language) {
                            currentLanguage = tempBooking.language;
                        }
                    } catch (e) {
                        console.error('Error parsing booking data for language:', e);
                    }
                }
                
                // 3. Referrer check
                if (document.referrer && document.referrer.includes('index-en.html')) {
                    currentLanguage = 'en';
                } else if (document.referrer && document.referrer.includes('payment.html')) {
                    // Check payment page language parameter
                    try {
                        const referrerUrl = new URL(document.referrer);
                        const referrerLang = referrerUrl.searchParams.get('lang');
                        if (referrerLang === 'en') {
                            currentLanguage = 'en';
                        }
                    } catch (e) {
                        // Ignore URL parsing errors
                    }
                }
            }
            
            console.log('Detected language:', currentLanguage);
            updatePageLanguage();
        }
        
        function updatePageLanguage() {
            const t = translations[currentLanguage];
            
            // Update document title
            document.title = t.title;
            document.getElementById('pageTitle').textContent = t.title;
            
            // Update page content
            setTimeout(() => {
                updateTextContent(t);
            }, 100);
        }
        
        function updateTextContent(t) {
            // Header section
            document.getElementById('successTitle').textContent = t.successTitle;
            document.getElementById('successMessage').textContent = t.successMessage;
            
            // Booking details section
            document.getElementById('bookingDetailsTitle').innerHTML = `<i class="bi bi-calendar-check me-2"></i>${t.bookingDetails}`;
            document.getElementById('certifiedGuideLabel').textContent = t.certifiedGuide;
            document.getElementById('bookingNumberLabel').textContent = t.bookingNumber;
            document.getElementById('paymentAmountLabel').textContent = t.paymentAmount;
            
            // Next steps section
            document.getElementById('nextStepsTitle').innerHTML = `<i class="bi bi-list-check me-2"></i>${t.nextSteps}`;
            const nextStepsList = document.getElementById('nextStepsList');
            nextStepsList.innerHTML = t.nextStepsList.map(step => `<li>${step}</li>`).join('');
            
            // Guide contact section
            document.getElementById('guideContactTitle').innerHTML = `<i class="bi bi-chat-dots me-2"></i>${t.guideContact}`;
            document.getElementById('guideContactDesc').textContent = t.guideContactDesc;
            document.getElementById('chatButton').innerHTML = `<i class="bi bi-chat me-2"></i>${t.chatButton}`;
            
            // Payment info section
            document.getElementById('paymentInfoTitle').innerHTML = `<i class="bi bi-info-circle me-2"></i>${t.paymentInfo}`;
            document.getElementById('paymentInfoContent').innerHTML = t.paymentInfoContent;
            document.getElementById('paymentStatusBadge').textContent = t.paymentStatus;
            
            // Action buttons
            document.getElementById('viewBookingsButton').innerHTML = `<i class="bi bi-calendar3 me-2"></i>${t.viewBookings}`;
            document.getElementById('homeButton').innerHTML = `<i class="bi bi-house me-2"></i>${t.goHome}`;
            
            // Emergency contact
            document.getElementById('emergencyContact').innerHTML = t.emergencyContact;
        }
        
        function loadBookingData() {
            const urlParams = new URLSearchParams(window.location.search);
            const bookingId = urlParams.get('id');
            
            if (bookingId) {
                // LocalStorageから予約データを取得
                const bookings = JSON.parse(localStorage.getItem('userBookings') || '[]');
                bookingData = bookings.find(b => b.id == bookingId);
                
                if (bookingData) {
                    displayBookingData();
                } else {
                    alert('予約データが見つかりません。');
                    window.location.href = 'index.html';
                }
            } else {
                // 最新の予約を表示
                const bookings = JSON.parse(localStorage.getItem('userBookings') || '[]');
                if (bookings.length > 0) {
                    bookingData = bookings[bookings.length - 1];
                    displayBookingData();
                } else {
                    alert('予約データが見つかりません。');
                    window.location.href = 'index.html';
                }
            }
        }
        
        function displayBookingData() {
            const t = translations[currentLanguage];
            
            document.getElementById('confirmGuideName').textContent = bookingData.guideName;
            document.getElementById('confirmGuideImage').src = bookingData.guideImage || '';
            document.getElementById('confirmTotal').textContent = bookingData.totalPrice;
            document.getElementById('confirmBookingId').textContent = `#${bookingData.id}`;
            
            // Multi-language booking details
            const durationText = currentLanguage === 'en' ? `${bookingData.duration} hour${bookingData.duration > 1 ? 's' : ''}` : `${bookingData.duration}時間`;
            const participantsText = currentLanguage === 'en' ? `${bookingData.participants} person${bookingData.participants > 1 ? 's' : ''}` : `${bookingData.participants}名`;
            
            const detailsHTML = `
                <div class="mb-2"><strong>${t.date}:</strong> ${bookingData.date}</div>
                <div class="mb-2"><strong>${t.time}:</strong> ${bookingData.time}</div>
                <div class="mb-2"><strong>${t.duration}:</strong> ${durationText}</div>
                <div class="mb-2"><strong>${t.participants}:</strong> ${participantsText}</div>
                ${bookingData.specialRequests ? `<div class="mb-2"><strong>${t.specialRequests}:</strong> ${bookingData.specialRequests}</div>` : ''}
            `;
            document.getElementById('confirmBookingDetails').innerHTML = detailsHTML;
        }
        
        function openChat() {
            if (bookingData) {
                // ガイドIDがない場合はガイド名から生成
                const guideId = bookingData.guideId || bookingData.guideName.replace(/\s+/g, '');
                console.log(`Opening chat for guide: ${bookingData.guideName} (ID: ${guideId})`);
                
                // 専用チャットページにリダイレクト
                const chatUrl = `chat.html?guideId=${guideId}&guideName=${encodeURIComponent(bookingData.guideName)}&bookingId=${bookingData.id}`;
                window.location.href = chatUrl;
            } else {
                alert('予約データが見つかりません。');
            }
        }
        
        function viewBookings() {
            // 予約一覧ページ（今後実装）
            alert('予約一覧ページを表示します');
            // window.location.href = 'my-bookings.html';
        }
        
        function goHome() {
            // Language-aware redirect to home page
            const homeUrl = currentLanguage === 'en' ? 'index-en.html' : 'index.html';
            window.location.href = homeUrl;
        }
    </script>
</body>
</html>