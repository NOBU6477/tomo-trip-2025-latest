<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ガイドダッシュボード - TomoTrip</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            background: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        
        .notification-card {
            background: white;
            border-radius: 15px;
            border-left: 5px solid #28a745;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
            transition: transform 0.2s ease;
        }
        
        .notification-card:hover {
            transform: translateY(-2px);
        }
        
        .notification-card.unread {
            border-left-color: #ffc107;
            background: linear-gradient(90deg, #fff3cd 0%, white 10%);
        }
        
        .stats-card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .stats-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 1.5rem;
        }
        
        .earning-info {
            background: #e7f3ff;
            border-radius: 15px;
            padding: 2rem;
            margin: 2rem 0;
        }
        
        .payout-schedule {
            background: #d4edda;
            border-radius: 15px;
            padding: 2rem;
            margin: 2rem 0;
        }
        
        .commission-explanation {
            background: #fff3cd;
            border-radius: 15px;
            padding: 2rem;
            margin: 2rem 0;
        }
        
        .booking-item {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .status-pending { background: #fff3cd; color: #856404; }
        .status-confirmed { background: #d4edda; color: #155724; }
        .status-completed { background: #cce7ff; color: #004085; }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h2 class="fw-bold mb-2">ガイドダッシュボード</h2>
                    <p class="mb-0">予約管理と収益確認</p>
                </div>
                <div class="col-md-4 text-end">
                    <span class="badge bg-success fs-6" id="onlineStatus">オンライン</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="container">
        <!-- 統計情報 -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-icon bg-primary text-white">
                        <i class="bi bi-calendar-check"></i>
                    </div>
                    <h4 class="fw-bold" id="totalBookings">0</h4>
                    <p class="text-muted mb-0">総予約数</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-icon bg-success text-white">
                        <i class="bi bi-currency-yen"></i>
                    </div>
                    <h4 class="fw-bold" id="totalEarnings">¥0</h4>
                    <p class="text-muted mb-0">総収益</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-icon bg-warning text-white">
                        <i class="bi bi-clock"></i>
                    </div>
                    <h4 class="fw-bold" id="pendingBookings">0</h4>
                    <p class="text-muted mb-0">保留中の予約</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-icon bg-info text-white">
                        <i class="bi bi-star"></i>
                    </div>
                    <h4 class="fw-bold">4.8</h4>
                    <p class="text-muted mb-0">評価平均</p>
                </div>
            </div>
        </div>
        
        <div class="row">
            <!-- 通知とお知らせ -->
            <div class="col-md-8">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-0">
                        <h5 class="fw-bold mb-0">
                            <i class="bi bi-bell me-2"></i>通知
                            <span class="badge bg-danger ms-2" id="unreadCount">0</span>
                        </h5>
                    </div>
                    <div class="card-body" id="notificationsContainer">
                        <p class="text-muted">新しい通知はありません</p>
                    </div>
                </div>
                
                <!-- 最近の予約 -->
                <div class="card border-0 shadow-sm mt-4">
                    <div class="card-header bg-white border-0">
                        <h5 class="fw-bold mb-0">
                            <i class="bi bi-calendar3 me-2"></i>最近の予約
                        </h5>
                    </div>
                    <div class="card-body" id="recentBookingsContainer">
                        <p class="text-muted">予約はありません</p>
                    </div>
                </div>
            </div>
            
            <!-- 収益情報 -->
            <div class="col-md-4">
                <!-- 支払いシステム説明 -->
                <div class="commission-explanation">
                    <h6 class="fw-bold"><i class="bi bi-info-circle me-2"></i>支払いシステム</h6>
                    <div class="small">
                        <div class="mb-2">
                            <strong>お客様支払い:</strong><br>
                            決済時に弊社が全額をお預かり
                        </div>
                        <div class="mb-2">
                            <strong>ガイド報酬:</strong><br>
                            サービス完了後、手数料20%を差し引いて支払い
                        </div>
                        <div class="mb-2">
                            <strong>支払いタイミング:</strong><br>
                            サービス完了から3営業日以内
                        </div>
                        <div>
                            <strong>安心保証:</strong><br>
                            キャンセルやトラブル時も適切に対応
                        </div>
                    </div>
                </div>
                
                <!-- 今月の収益 -->
                <div class="earning-info">
                    <h6 class="fw-bold"><i class="bi bi-graph-up me-2"></i>今月の収益</h6>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span>総売上:</span>
                            <strong id="monthlyGross">¥0</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>手数料 (20%):</span>
                            <strong class="text-danger" id="monthlyCommission">-¥0</strong>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between">
                            <span class="fw-bold">受取金額:</span>
                            <strong class="text-success" id="monthlyPayout">¥0</strong>
                        </div>
                    </div>
                </div>
                
                <!-- 支払い予定 -->
                <div class="payout-schedule">
                    <h6 class="fw-bold"><i class="bi bi-calendar-check me-2"></i>支払い予定</h6>
                    <div id="payoutSchedule">
                        <p class="text-muted small">完了済みサービスはありません</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentGuideId = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
            loadNotifications();
            loadBookings();
            updateStats();
        });
        
        function initializeDashboard() {
            // ガイドIDを取得（実際の実装ではログイン情報から取得）
            const urlParams = new URLSearchParams(window.location.search);
            currentGuideId = urlParams.get('guideId') || '1'; // デフォルト値
            
            console.log('Guide Dashboard initialized for guide:', currentGuideId);
        }
        
        function loadNotifications() {
            if (!currentGuideId) return;
            
            const notifications = JSON.parse(localStorage.getItem(`guideNotifications_${currentGuideId}`) || '[]');
            const container = document.getElementById('notificationsContainer');
            const unreadCount = notifications.filter(n => !n.read).length;
            
            document.getElementById('unreadCount').textContent = unreadCount;
            
            if (notifications.length === 0) {
                container.innerHTML = '<p class="text-muted">新しい通知はありません</p>';
                return;
            }
            
            const notificationsHTML = notifications.map(notification => `
                <div class="notification-card ${!notification.read ? 'unread' : ''}" data-id="${notification.id}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="fw-bold mb-1">${notification.title}</h6>
                                <p class="mb-2">${notification.message}</p>
                                <div class="row">
                                    <div class="col-md-6">
                                        <small class="text-muted">
                                            <i class="bi bi-calendar me-1"></i>
                                            ${new Date(notification.timestamp).toLocaleDateString('ja-JP')}
                                        </small>
                                    </div>
                                    <div class="col-md-6 text-end">
                                        <small class="text-success fw-bold">
                                            受取予定: ¥${notification.payoutAmount?.toLocaleString() || '0'}
                                        </small>
                                    </div>
                                </div>
                            </div>
                            ${!notification.read ? '<span class="badge bg-warning ms-2">新着</span>' : ''}
                        </div>
                        ${notification.type === 'new_booking' ? `
                            <div class="mt-3">
                                <button class="btn btn-success btn-sm me-2" onclick="acceptBooking('${notification.bookingId}')">
                                    <i class="bi bi-check me-1"></i>承認
                                </button>
                                <button class="btn btn-outline-primary btn-sm" onclick="viewBookingDetails('${notification.bookingId}')">
                                    詳細確認
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = notificationsHTML;
            
            // 通知をクリックで既読にする
            container.querySelectorAll('.notification-card').forEach(card => {
                card.addEventListener('click', function() {
                    markAsRead(this.dataset.id);
                });
            });
        }
        
        function loadBookings() {
            // すべての予約から該当ガイドの予約を抽出
            const allBookings = JSON.parse(localStorage.getItem('userBookings') || '[]');
            const guideBookings = allBookings.filter(booking => booking.guideId == currentGuideId);
            
            const container = document.getElementById('recentBookingsContainer');
            
            if (guideBookings.length === 0) {
                container.innerHTML = '<p class="text-muted">予約はありません</p>';
                return;
            }
            
            const bookingsHTML = guideBookings.map(booking => `
                <div class="booking-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="fw-bold mb-1">予約 #${booking.id}</h6>
                            <p class="mb-1">${booking.date} ${booking.time} - ${booking.duration}時間</p>
                            <small class="text-muted">${booking.participants}名様</small>
                        </div>
                        <div class="text-end">
                            <span class="status-badge status-${booking.status}">${getStatusText(booking.status)}</span>
                            <div class="mt-1">
                                <strong class="text-success">${booking.totalPrice}</strong>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = bookingsHTML;
        }
        
        function updateStats() {
            const allBookings = JSON.parse(localStorage.getItem('userBookings') || '[]');
            const guideBookings = allBookings.filter(booking => booking.guideId == currentGuideId);
            
            document.getElementById('totalBookings').textContent = guideBookings.length;
            document.getElementById('pendingBookings').textContent = 
                guideBookings.filter(b => b.status === 'pending').length;
            
            // 収益計算
            const totalEarnings = guideBookings.reduce((sum, booking) => {
                const amount = parseInt(booking.totalPrice.replace(/[^\d]/g, ''));
                return sum + (amount * 0.80); // 80%がガイドの取り分
            }, 0);
            
            document.getElementById('totalEarnings').textContent = `¥${totalEarnings.toLocaleString()}`;
            
            // 今月の収益
            updateMonthlyEarnings(guideBookings);
        }
        
        function updateMonthlyEarnings(bookings) {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            const monthlyBookings = bookings.filter(booking => {
                const bookingDate = new Date(booking.bookingDate);
                return bookingDate.getMonth() === currentMonth && 
                       bookingDate.getFullYear() === currentYear;
            });
            
            const monthlyGross = monthlyBookings.reduce((sum, booking) => {
                return sum + parseInt(booking.totalPrice.replace(/[^\d]/g, ''));
            }, 0);
            
            const monthlyCommission = Math.round(monthlyGross * 0.20);
            const monthlyPayout = monthlyGross - monthlyCommission;
            
            document.getElementById('monthlyGross').textContent = `¥${monthlyGross.toLocaleString()}`;
            document.getElementById('monthlyCommission').textContent = `-¥${monthlyCommission.toLocaleString()}`;
            document.getElementById('monthlyPayout').textContent = `¥${monthlyPayout.toLocaleString()}`;
        }
        
        function getStatusText(status) {
            const statusMap = {
                'pending': '保留中',
                'confirmed': '確定済み',
                'completed': '完了済み',
                'cancelled': 'キャンセル'
            };
            return statusMap[status] || status;
        }
        
        function markAsRead(notificationId) {
            const notifications = JSON.parse(localStorage.getItem(`guideNotifications_${currentGuideId}`) || '[]');
            const updated = notifications.map(n => 
                n.id == notificationId ? {...n, read: true} : n
            );
            localStorage.setItem(`guideNotifications_${currentGuideId}`, JSON.stringify(updated));
            loadNotifications(); // 再読み込み
        }
        
        function acceptBooking(bookingId) {
            alert(`予約 #${bookingId} を承認しました`);
            // 実際の実装では予約ステータスを更新
        }
        
        function viewBookingDetails(bookingId) {
            alert(`予約 #${bookingId} の詳細を表示します`);
            // 実際の実装では詳細ページに遷移
        }
    </script>
</body>
</html>