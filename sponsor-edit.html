<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å”è³›åº—æƒ…å ±ç·¨é›† - TomoTrip</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .edit-container {
            max-width: 900px;
            margin: 2rem auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header-section {
            background: linear-gradient(45deg, #fd7e14, #e83e8c);
            color: white;
            padding: 2rem;
            text-align: center;
        }
        .form-section {
            padding: 2rem;
        }
        .section-title {
            color: #fd7e14;
            font-weight: bold;
            margin-bottom: 1rem;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 0.5rem;
        }
        .progress-steps {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 2rem;
        }
        .step {
            display: inline-block;
            padding: 0.5rem 1rem;
            margin: 0.25rem;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        .step.completed {
            background: #28a745;
            color: white;
        }
        .step.current {
            background: #fd7e14;
            color: white;
        }
        .step.pending {
            background: #e9ecef;
            color: #6c757d;
        }
        .image-upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
        }
        .image-upload-area:hover {
            border-color: #fd7e14;
            background: #fff3cd;
        }
        .preview-image {
            max-width: 150px;
            max-height: 150px;
            object-fit: cover;
            border-radius: 8px;
            margin: 0.5rem;
        }
        .btn-primary {
            background: linear-gradient(45deg, #fd7e14, #e83e8c);
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
        }
        .btn-success {
            background: linear-gradient(45deg, #28a745, #20c997);
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
        }
        .form-control:focus {
            border-color: #fd7e14;
            box-shadow: 0 0 0 0.2rem rgba(253, 126, 20, 0.25);
        }
        .draft-management {
            background: linear-gradient(135deg, #ffc107 0%, #ff8f00 100%);
            color: #000;
            padding: 1rem 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            border: 2px solid #ffab00;
        }
        .draft-management h4 {
            margin-bottom: 1rem;
            font-weight: bold;
        }
        .btn-draft {
            background: #fff;
            color: #ff8f00;
            border: 2px solid #fff;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            font-weight: 600;
            margin: 0.25rem;
            transition: all 0.3s ease;
        }
        .btn-draft:hover {
            background: #ff8f00;
            color: #fff;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 143, 0, 0.3);
        }
        .draft-info {
            background: rgba(255, 255, 255, 0.2);
            padding: 1rem;
            border-radius: 10px;
            margin-top: 1rem;
        }
        .draft-timestamp {
            font-size: 0.9rem;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="edit-container">
            <!-- Header -->
            <div class="header-section">
                <h1><i class="bi bi-pencil-square"></i> å”è³›åº—æƒ…å ±ç·¨é›†</h1>
                <p class="mb-0">è©³ç´°æƒ…å ±ã‚’è¿½åŠ ã—ã¦ã€é­…åŠ›çš„ãªåº—èˆ—ãƒšãƒ¼ã‚¸ã‚’ä½œæˆã—ã¾ã—ã‚‡ã†</p>
            </div>

            <!-- Draft Management Section -->
            <div class="form-section">
                <div class="draft-management" id="draftManagement">
                    <h4><i class="bi bi-file-earmark-text"></i> ä¸‹æ›¸ãç®¡ç†</h4>
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div id="draftStatus">
                                <p class="mb-0">è‡ªå‹•ä¿å­˜æ©Ÿèƒ½ã§ä½œæ¥­å†…å®¹ã‚’å®‰å…¨ã«ä¿æŒã—ã¾ã™</p>
                                <div class="draft-timestamp" id="lastSaved">æœ€çµ‚ä¿å­˜: ã¾ã ä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <button type="button" class="btn btn-draft" onclick="saveDraft()">
                                <i class="bi bi-cloud-arrow-up"></i> ä¸‹æ›¸ãä¿å­˜
                            </button>
                            <button type="button" class="btn btn-draft" onclick="loadDraft()" id="loadDraftBtn" style="display: none;">
                                <i class="bi bi-cloud-arrow-down"></i> ä¸‹æ›¸ãèª­è¾¼
                            </button>
                        </div>
                    </div>
                    <div class="draft-info" id="draftInfo" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <small><strong>ä¿å­˜ã•ã‚ŒãŸé …ç›®:</strong></small>
                                <div id="savedItems" class="draft-timestamp"></div>
                            </div>
                            <div class="col-md-6">
                                <small><strong>ä¸‹æ›¸ãä¿å­˜æ—¥æ™‚:</strong></small>
                                <div id="draftTimestamp" class="draft-timestamp"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Progress Steps -->
                <div class="progress-steps">
                    <div class="text-center">
                        <div class="step completed">
                            <i class="bi bi-check-circle"></i> åŸºæœ¬ç™»éŒ²
                        </div>
                        <div class="step current">
                            <i class="bi bi-pencil"></i> è©³ç´°ç·¨é›†
                        </div>
                        <div class="step pending">
                            <i class="bi bi-eye"></i> å…¬é–‹
                        </div>
                    </div>
                </div>

                <!-- Store Info Display -->
                <div class="alert alert-info">
                    <strong>ç·¨é›†ä¸­ã®åº—èˆ—ï¼š</strong> <span id="currentStoreName">èª­ã¿è¾¼ã¿ä¸­...</span>
                </div>

                <form id="sponsorEditForm">
                    <!-- ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                    <div class="mb-4">
                        <h3 class="section-title"><i class="bi bi-camera"></i> åº—èˆ—ç”»åƒ</h3>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ãƒ¡ã‚¤ãƒ³ç”»åƒï¼ˆåº—èˆ—å¤–è¦³ï¼‰</label>
                                <div class="image-upload-area" onclick="document.getElementById('mainImage').click()">
                                    <i class="bi bi-cloud-upload fs-1 text-muted"></i>
                                    <p class="mt-2 mb-0">ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</p>
                                    <small class="text-muted">æ¨å¥¨ã‚µã‚¤ã‚º: 800x600px</small>
                                </div>
                                <input type="file" id="mainImage" class="d-none" accept="image/*">
                                <div id="mainImagePreview" class="mt-2"></div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ãƒ­ã‚´ãƒ»çœ‹æ¿ç”»åƒ</label>
                                <div class="image-upload-area" onclick="document.getElementById('logoImage').click()">
                                    <i class="bi bi-shop fs-1 text-muted"></i>
                                    <p class="mt-2 mb-0">ãƒ­ã‚´ã¾ãŸã¯çœ‹æ¿ç”»åƒ</p>
                                    <small class="text-muted">æ¨å¥¨ã‚µã‚¤ã‚º: 400x400px</small>
                                </div>
                                <input type="file" id="logoImage" class="d-none" accept="image/*">
                                <div id="logoImagePreview" class="mt-2"></div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">è¿½åŠ ç”»åƒï¼ˆå†…è£…ãƒ»å•†å“ãƒ»ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãªã©ï¼‰</label>
                            <div class="image-upload-area" onclick="document.getElementById('additionalImages').click()">
                                <i class="bi bi-images fs-1 text-muted"></i>
                                <p class="mt-2 mb-0">è¤‡æ•°ã®ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯èƒ½</p>
                                <small class="text-muted">æœ€å¤§15æšã¾ã§</small>
                            </div>
                            <input type="file" id="additionalImages" class="d-none" accept="image/*" multiple>
                            <div id="additionalImagesPreview" class="mt-2"></div>
                        </div>
                    </div>

                    <!-- è©³ç´°èª¬æ˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                    <div class="mb-4">
                        <h3 class="section-title"><i class="bi bi-chat-text"></i> è©³ç´°èª¬æ˜</h3>
                        
                        <div class="mb-3">
                            <label for="detailedDescription" class="form-label">è©³ã—ã„åº—èˆ—ç´¹ä»‹</label>
                            <textarea class="form-control" id="detailedDescription" rows="5" placeholder="ãŠåº—ã®æ­´å²ã€ã“ã ã‚ã‚Šã€é›°å›²æ°—ã€ãŠã™ã™ã‚å•†å“ãƒ»ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãªã©ã‚’è©³ã—ãã”ç´¹ä»‹ãã ã•ã„"></textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="specialty" class="form-label">ç‰¹è‰²ãƒ»å£²ã‚Š</label>
                                <textarea class="form-control" id="specialty" rows="3" placeholder="ä¾‹ï¼šå‰µæ¥­50å¹´ã®è€èˆ—ã€åœ°å…ƒé£Ÿæä½¿ç”¨ã€è·äººã®æ‰‹ä½œã‚Š"></textarea>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="atmosphere" class="form-label">åº—å†…ã®é›°å›²æ°—</label>
                                <textarea class="form-control" id="atmosphere" rows="3" placeholder="ä¾‹ï¼šè½ã¡ç€ã„ãŸå’Œé¢¨ç©ºé–“ã€ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ã§æ˜ã‚‹ã„ã€å®¶æ—é€£ã‚Œæ­“è¿"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- ã‚µãƒ¼ãƒ“ã‚¹è©³ç´°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                    <div class="mb-4">
                        <h3 class="section-title"><i class="bi bi-star"></i> ã‚µãƒ¼ãƒ“ã‚¹è©³ç´°</h3>
                        
                        <div class="mb-3">
                            <label for="detailedDiscount" class="form-label">ç‰¹å…¸ã®è©³ç´°</label>
                            <textarea class="form-control" id="detailedDiscount" rows="3" placeholder="ç‰¹å…¸ã®åˆ©ç”¨æ–¹æ³•ã€æ¡ä»¶ã€æœŸé–“ãªã©ã‚’è©³ã—ãã”è¨˜å…¥ãã ã•ã„"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">æä¾›ã‚µãƒ¼ãƒ“ã‚¹</label>
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="serviceWifi" value="wifi">
                                        <label class="form-check-label" for="serviceWifi">Wi-Fiç„¡æ–™</label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="serviceParking" value="parking">
                                        <label class="form-check-label" for="serviceParking">é§è»Šå ´å®Œå‚™</label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="serviceCard" value="card">
                                        <label class="form-check-label" for="serviceCard">ã‚«ãƒ¼ãƒ‰æ±ºæ¸ˆOK</label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="serviceBarrierFree" value="barrier-free">
                                        <label class="form-check-label" for="serviceBarrierFree">ãƒãƒªã‚¢ãƒ•ãƒªãƒ¼</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="priceRange" class="form-label">ä¾¡æ ¼å¸¯</label>
                                <select class="form-select" id="priceRange">
                                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                    <option value="budget">ãƒªãƒ¼ã‚ºãƒŠãƒ–ãƒ«ï¼ˆã€œ1,000å††ï¼‰</option>
                                    <option value="moderate">ä¸­ç¨‹åº¦ï¼ˆ1,000å††ã€œ3,000å††ï¼‰</option>
                                    <option value="upscale">é«˜ç´šï¼ˆ3,000å††ã€œï¼‰</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="capacity" class="form-label">åå®¹äººæ•°</label>
                                <input type="number" class="form-control" id="capacity" placeholder="ä¾‹ï¼š50">
                            </div>
                        </div>
                    </div>

                    <!-- ã‚¢ã‚¯ã‚»ã‚¹æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                    <div class="mb-4">
                        <h3 class="section-title"><i class="bi bi-geo-alt"></i> ã‚¢ã‚¯ã‚»ã‚¹æƒ…å ±</h3>
                        
                        <div class="mb-3">
                            <label for="accessInfo" class="form-label">ã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³•</label>
                            <textarea class="form-control" id="accessInfo" rows="3" placeholder="æœ€å¯„ã‚Šé§…ã€ãƒã‚¹åœã€ç›®å°ã¨ãªã‚‹å»ºç‰©ãªã©ã‚’è©³ã—ãã”è¨˜å…¥ãã ã•ã„"></textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="nearestStation" class="form-label">æœ€å¯„ã‚Šé§…</label>
                                <input type="text" class="form-control" id="nearestStation" placeholder="ä¾‹ï¼šJRæ¸‹è°·é§… å¾’æ­©5åˆ†">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="parkingInfo" class="form-label">é§è»Šå ´æƒ…å ±</label>
                                <input type="text" class="form-control" id="parkingInfo" placeholder="ä¾‹ï¼šå°‚ç”¨é§è»Šå ´10å°ã€è¿‘éš£ã‚³ã‚¤ãƒ³ãƒ‘ãƒ¼ã‚­ãƒ³ã‚°æœ‰">
                            </div>
                        </div>
                    </div>

                    <!-- ä¿å­˜ãƒ»å…¬é–‹ãƒœã‚¿ãƒ³ -->
                    <div class="text-center">
                        <button type="button" class="btn btn-secondary me-2" onclick="saveDraft()">
                            <i class="bi bi-save"></i> ä¸‹æ›¸ãä¿å­˜
                        </button>
                        <button type="button" class="btn btn-primary me-2" onclick="previewStore()">
                            <i class="bi bi-eye"></i> ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-check-circle"></i> å®Œäº†ã—ã¦å…¬é–‹
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <!-- ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æœ€é©åŒ–ã‚·ã‚¹ãƒ†ãƒ  -->
  <script src="sponsor-storage-optimization.js"></script>
    <script>
        let currentSponsorId = null;
        let currentSponsorData = null;

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing...');
            
            const urlParams = new URLSearchParams(window.location.search);
            currentSponsorId = urlParams.get('id');
            
            if (currentSponsorId) {
                loadSponsorData();
                
                // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰è¨­å®š
                console.log('Setting up image uploads...');
                setupImageUpload('mainImage', 'mainImagePreview', 1);
                setupImageUpload('logoImage', 'logoImagePreview', 1);
                setupImageUpload('additionalImages', 'additionalImagesPreview', 15);
                console.log('Image upload setup complete');
                
                // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
                setupButtonEvents();
                
            } else {
                alert('ç·¨é›†å¯¾è±¡ã®åº—èˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                window.location.href = 'index.html';
            }
        });

        // åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
        function loadSponsorData() {
            const sponsors = JSON.parse(localStorage.getItem('registeredSponsors') || '[]');
            currentSponsorData = sponsors.find(s => s.id === currentSponsorId);
            
            if (currentSponsorData) {
                console.log('âœ… Found sponsor data:', currentSponsorData);
                
                // åº—èˆ—åã‚’æ›´æ–°ï¼ˆã€Œèª­ã¿è¾¼ã¿ä¸­ã€ã‚’è§£é™¤ï¼‰
                const storeNameDisplay = document.getElementById('currentStoreName');
                if (storeNameDisplay) {
                    storeNameDisplay.textContent = currentSponsorData.storeName || 'åº—èˆ—åæœªè¨­å®š';
                }
                
                // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è¨­å®š
                if (currentSponsorData.detailedDescription) {
                    document.getElementById('detailedDescription').value = currentSponsorData.detailedDescription;
                }
                if (currentSponsorData.specialty) {
                    document.getElementById('specialty').value = currentSponsorData.specialty;
                }
                if (currentSponsorData.atmosphere) {
                    document.getElementById('atmosphere').value = currentSponsorData.atmosphere;
                }
                if (currentSponsorData.detailedDiscount) {
                    document.getElementById('detailedDiscount').value = currentSponsorData.detailedDiscount;
                }
                if (currentSponsorData.priceRange) {
                    document.getElementById('priceRange').value = currentSponsorData.priceRange;
                }
                if (currentSponsorData.capacity) {
                    document.getElementById('capacity').value = currentSponsorData.capacity;
                }
                if (currentSponsorData.accessInfo) {
                    document.getElementById('accessInfo').value = currentSponsorData.accessInfo;
                }
                if (currentSponsorData.nearestStation) {
                    document.getElementById('nearestStation').value = currentSponsorData.nearestStation;
                }
                if (currentSponsorData.parkingInfo) {
                    document.getElementById('parkingInfo').value = currentSponsorData.parkingInfo;
                }

                // ç”»åƒã®å¾©å…ƒ
                if (currentSponsorData.mainImage) {
                    displaySavedImage(currentSponsorData.mainImage, 'mainImagePreview');
                }
                if (currentSponsorData.logoImage) {
                    displaySavedImage(currentSponsorData.logoImage, 'logoImagePreview');
                }
                if (currentSponsorData.additionalImages && currentSponsorData.additionalImages.length > 0) {
                    currentSponsorData.additionalImages.forEach(imageSrc => {
                        displaySavedImage(imageSrc, 'additionalImagesPreview');
                    });
                }

                // ã‚µãƒ¼ãƒ“ã‚¹ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å¾©å…ƒ
                if (currentSponsorData.services) {
                    currentSponsorData.services.forEach(service => {
                        let checkboxId;
                        switch(service) {
                            case 'wifi': checkboxId = 'serviceWifi'; break;
                            case 'parking': checkboxId = 'serviceParking'; break;
                            case 'card': checkboxId = 'serviceCard'; break;
                            case 'barrier-free': checkboxId = 'serviceBarrierFree'; break;
                            default: checkboxId = `service${service.charAt(0).toUpperCase() + service.slice(1)}`;
                        }
                        const checkbox = document.getElementById(checkboxId);
                        if (checkbox) {
                            checkbox.checked = true;
                        }
                    });
                }
            } else {
                console.error('âŒ Sponsor data not found for ID:', currentSponsorId);
                
                // ã€Œèª­ã¿è¾¼ã¿ä¸­ã€ã‚’ã€Œãƒ‡ãƒ¼ã‚¿ãªã—ã€ã«å¤‰æ›´
                const storeNameDisplay = document.getElementById('currentStoreName');
                if (storeNameDisplay) {
                    storeNameDisplay.textContent = 'ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
                }
                
                alert('åº—èˆ—ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                window.location.href = 'index.html';
            }
        }

        // ä¿å­˜æ¸ˆã¿ç”»åƒã‚’è¡¨ç¤º
        function displaySavedImage(imageSrc, previewId) {
            const preview = document.getElementById(previewId);
            
            const imageContainer = document.createElement('div');
            imageContainer.className = 'd-inline-block position-relative m-1';
            
            const img = document.createElement('img');
            img.src = imageSrc;
            img.className = 'preview-image';
            
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'btn btn-sm btn-danger position-absolute top-0 end-0';
            removeBtn.style.transform = 'translate(25%, -25%)';
            removeBtn.innerHTML = '<i class="bi bi-x"></i>';
            removeBtn.onclick = function() {
                imageContainer.remove();
            };
            
            imageContainer.appendChild(img);
            imageContainer.appendChild(removeBtn);
            preview.appendChild(imageContainer);
        }

        // ç”»åƒåœ§ç¸®é–¢æ•°
        function compressImage(file, maxWidth = 800, quality = 0.7) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    // ç¸¦æ¨ªæ¯”ã‚’ä¿æŒã—ã¦ãƒªã‚µã‚¤ã‚º
                    const ratio = Math.min(maxWidth / img.width, maxWidth / img.height);
                    canvas.width = img.width * ratio;
                    canvas.height = img.height * ratio;
                    
                    // ç”»åƒã‚’æç”»
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    // åœ§ç¸®ã•ã‚ŒãŸBase64ã‚’å–å¾—
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                    resolve(compressedDataUrl);
                };
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
        function setupImageUpload(inputId, previewId, maxImages = 15) {
            const input = document.getElementById(inputId);
            if (!input) {
                console.error(`Input element not found: ${inputId}`);
                return;
            }
            
            input.addEventListener('change', async function(e) {
                const files = e.target.files;
                const preview = document.getElementById(previewId);
                
                if (!preview) {
                    console.error(`Preview element not found: ${previewId}`);
                    return;
                }

                if (files.length > maxImages) {
                    alert(`ç”»åƒã¯æœ€å¤§${maxImages}æšã¾ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯èƒ½ã§ã™ã€‚`);
                    return;
                }

                // æ—¢å­˜ã®ç”»åƒæ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
                const existingImages = preview.querySelectorAll('.preview-image').length;
                const totalImages = existingImages + files.length;
                
                if (totalImages > maxImages) {
                    alert(`åˆè¨ˆã§æœ€å¤§${maxImages}æšã¾ã§ã§ã™ã€‚ç¾åœ¨${existingImages}æšã‚ã‚Šã¾ã™ã€‚`);
                    return;
                }

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    
                    try {
                        // ç”»åƒã‚’åœ§ç¸®
                        const compressedDataUrl = await compressImage(file);
                        
                        const imageContainer = document.createElement('div');
                        imageContainer.className = 'd-inline-block position-relative m-1';
                        
                        const img = document.createElement('img');
                        img.src = compressedDataUrl;
                        img.className = 'preview-image';
                        
                        const removeBtn = document.createElement('button');
                        removeBtn.type = 'button';
                        removeBtn.className = 'btn btn-sm btn-danger position-absolute top-0 end-0';
                        removeBtn.style.transform = 'translate(25%, -25%)';
                        removeBtn.innerHTML = '<i class="bi bi-x"></i>';
                        removeBtn.onclick = function(event) {
                            event.preventDefault();
                            imageContainer.remove();
                        };
                        
                        imageContainer.appendChild(img);
                        imageContainer.appendChild(removeBtn);
                        
                        // æ—¢å­˜ã®ç”»åƒã‚’ã‚¯ãƒªã‚¢ã—ã¦ã‹ã‚‰è¿½åŠ ï¼ˆå˜ä¸€ç”»åƒã®å ´åˆï¼‰
                        if (maxImages === 1) {
                            preview.innerHTML = '';
                        }
                        
                        preview.appendChild(imageContainer);
                        
                        console.log(`Image ${i + 1} processed and added to ${previewId}`);
                    } catch (error) {
                        console.error('Image processing error:', error);
                        alert(`ç”»åƒ ${file.name} ã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ`);
                    }
                }
            });
        }

        // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
        function setupButtonEvents() {
            console.log('Setting up button events...');
            
            // ä¸‹æ›¸ãä¿å­˜ãƒœã‚¿ãƒ³
            const draftBtn = document.querySelector('button[onclick="saveDraft()"]');
            if (draftBtn) {
                draftBtn.removeAttribute('onclick');
                draftBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    saveDraft();
                });
                console.log('Draft button event set');
            }
            
            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³
            const previewBtn = document.querySelector('button[onclick="previewStore()"]');
            if (previewBtn) {
                previewBtn.removeAttribute('onclick');
                previewBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    previewStore();
                });
                console.log('Preview button event set');
            }
            
            // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆ
            const form = document.getElementById('sponsorEditForm');
            if (form) {
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    console.log('Form submitted');
                    
                    // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
                    const submitBtn = form.querySelector('button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = 'ğŸ”„ å…¬é–‹ä¸­...';
                    
                    try {
                        const editData = collectFormData();
                        editData.status = 'published';
                        editData.publishDate = new Date().toISOString();
                        
                        const success = await updateSponsorData(editData);
                        if (success) {
                            alert('âœ… å”è³›åº—æƒ…å ±ãŒå…¬é–‹ã•ã‚Œã¾ã—ãŸï¼\nå”è³›åº—ä¸€è¦§ãƒšãƒ¼ã‚¸ã§ã”ç¢ºèªã„ãŸã ã‘ã¾ã™ã€‚');
                            window.location.href = 'sponsor-list.html';
                        } else {
                            alert('âŒ å…¬é–‹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ç”»åƒã‚µã‚¤ã‚ºã‚’ç¢ºèªã—ã¦ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                        }
                    } catch (error) {
                        console.error('Publication error:', error);
                        alert('å…¬é–‹ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼š' + error.message);
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                    }
                });
                console.log('Form submit event set');
            }
            
            console.log('Button events setup complete');
        }

        // ä¸‹æ›¸ãä¿å­˜
        function saveDraft() {
            console.log('Save draft clicked');
            const editData = collectFormData();
            editData.status = 'draft';
            editData.draftSavedAt = new Date().toISOString();
            
            if (updateSponsorData(editData)) {
                const continueUrl = `sponsor-edit.html?id=${currentSponsorId}`;
                const message = `ä¸‹æ›¸ãã‚’ä¿å­˜ã—ã¾ã—ãŸï¼\n\nç·¨é›†ã‚’ç¶šã‘ã‚‹å ´åˆã¯ã€ä»¥ä¸‹ã®URLã‹ã‚‰å†é–‹ã§ãã¾ã™ï¼š\n${window.location.origin}/${continueUrl}\n\nã¾ãŸã¯ã€å”è³›åº—ç®¡ç†ãƒšãƒ¼ã‚¸ã®ã€Œä¸‹æ›¸ãä¸€è¦§ã€ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚`;
                alert(message);
                
                // ä¸‹æ›¸ãä¸€è¦§ã¸ã®è¿½åŠ ï¼ˆç®¡ç†ç”¨ï¼‰
                addToDraftList(editData);
            }
        }
        
        // ä¸‹æ›¸ãä¸€è¦§ã¸ã®è¿½åŠ 
        function addToDraftList(draftData) {
            try {
                let drafts = JSON.parse(localStorage.getItem('sponsorDrafts') || '[]');
                const existingIndex = drafts.findIndex(d => d.id === draftData.id);
                
                const draftItem = {
                    id: draftData.id,
                    storeName: draftData.storeName || 'æœªè¨­å®š',
                    category: draftData.category || 'æœªåˆ†é¡',
                    savedAt: draftData.draftSavedAt,
                    editUrl: `sponsor-edit.html?id=${draftData.id}`
                };
                
                if (existingIndex !== -1) {
                    drafts[existingIndex] = draftItem;
                } else {
                    drafts.push(draftItem);
                }
                
                localStorage.setItem('sponsorDrafts', JSON.stringify(drafts));
                console.log('Draft added to list:', draftItem);
            } catch (error) {
                console.error('Failed to add to draft list:', error);
            }
        }

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆè»½é‡åŒ–ç‰ˆï¼‰
        async function previewStore() {
            console.log('ğŸ” Preview button clicked');
            
            const editData = collectFormData();
            if (!editData) {
                alert('ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã®åé›†ã«å¤±æ•—ã—ã¾ã—ãŸ');
                return;
            }
            
            console.log('ğŸ“‹ Collected edit data:', editData);
            
            try {
                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã«è»½é‡åŒ–
                const lightPreviewData = {
                    id: editData.id,
                    storeName: editData.storeName,
                    category: editData.category,
                    address: editData.address,
                    phone: editData.phone,
                    email: editData.email,
                    website: editData.website,
                    openTime: editData.openTime,
                    closeTime: editData.closeTime,
                    holidays: editData.holidays,
                    detailedDescription: editData.detailedDescription,
                    specialty: editData.specialty,
                    atmosphere: editData.atmosphere,
                    detailedDiscount: editData.detailedDiscount,
                    services: editData.services,
                    priceRange: editData.priceRange,
                    capacity: editData.capacity,
                    accessInfo: editData.accessInfo,
                    nearestStation: editData.nearestStation,
                    parkingInfo: editData.parkingInfo,
                    // ç”»åƒã¯åœ§ç¸®ç‰ˆã‚’ä½¿ç”¨
                    mainImage: editData.mainImage ? await resizeAndCompressImage(editData.mainImage, 300, 0.6) : null,
                    logoImage: editData.logoImage ? await resizeAndCompressImage(editData.logoImage, 100, 0.7) : null,
                    additionalImages: editData.additionalImages ? (await Promise.all(
                        editData.additionalImages.slice(0, 2).map(img => 
                            img.startsWith('data:image/') ? resizeAndCompressImage(img, 300, 0.5) : Promise.resolve(img)
                        )
                    )) : [],
                    lastUpdated: editData.lastUpdated,
                    status: 'preview'
                };
                
                const previewKey = `preview_${editData.id}`;
                localStorage.setItem(previewKey, JSON.stringify(lightPreviewData));
                console.log('âœ… Lightweight preview data saved');
                
                // registeredSponsorsã«ã‚‚è»½é‡ç‰ˆã§ä¿å­˜
                let registeredSponsors = JSON.parse(localStorage.getItem('registeredSponsors') || '[]');
                const existingIndex = registeredSponsors.findIndex(s => s.id === editData.id);
                
                if (existingIndex !== -1) {
                    registeredSponsors[existingIndex] = { ...registeredSponsors[existingIndex], ...lightPreviewData };
                } else {
                    registeredSponsors.push(lightPreviewData);
                }
                
                // ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ã—ã¦ä¿å­˜
                const dataString = JSON.stringify(registeredSponsors);
                const sizeInMB = new Blob([dataString]).size / (1024 * 1024);
                console.log('ğŸ’¾ Total size:', sizeInMB.toFixed(2), 'MB');
                
                if (sizeInMB < 4) {
                    localStorage.setItem('registeredSponsors', dataString);
                    console.log('âœ… Data saved to registeredSponsors');
                } else {
                    console.log('âš ï¸ ã‚µã‚¤ã‚ºè¶…éã®ãŸã‚ registeredSponsors ã¸ã®ä¿å­˜ã‚’ã‚¹ã‚­ãƒƒãƒ—');
                }
                
                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
                const previewWindow = window.open(`sponsor-preview.html?id=${editData.id}`, '_blank');
                
                if (!previewWindow) {
                    alert('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¨±å¯ã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                }
                
            } catch (error) {
                console.error('âŒ Failed to save preview data:', error);
                if (error.name === 'QuotaExceededError') {
                    alert('ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®¹é‡ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚ç”»åƒã‚’å‰Šé™¤ã™ã‚‹ã‹ã€ãƒ–ãƒ©ã‚¦ã‚¶ãƒ‡ãƒ¼ã‚¿ã‚’æ•´ç†ã—ã¦ãã ã•ã„ã€‚');
                } else {
                    alert('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸï¼š' + error.message);
                }
            }
        }



        // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿åé›†
        function collectFormData() {
            console.log('Collecting form data...');
            
            // åŸºæœ¬ãƒ‡ãƒ¼ã‚¿ã®åé›†
            const data = {
                id: currentSponsorId,
                storeName: document.getElementById('storeName')?.value || currentSponsorData?.storeName || '',
                category: document.getElementById('category')?.value || currentSponsorData?.category || '',
                address: document.getElementById('address')?.value || currentSponsorData?.address || '',
                phone: document.getElementById('phone')?.value || currentSponsorData?.phone || '',
                email: document.getElementById('email')?.value || currentSponsorData?.email || '',
                website: document.getElementById('website')?.value || currentSponsorData?.website || '',
                openTime: document.getElementById('openTime')?.value || currentSponsorData?.openTime || '',
                closeTime: document.getElementById('closeTime')?.value || currentSponsorData?.closeTime || '',
                holidays: document.getElementById('holidays')?.value || currentSponsorData?.holidays || '',
                detailedDescription: document.getElementById('detailedDescription').value,
                specialty: document.getElementById('specialty').value,
                atmosphere: document.getElementById('atmosphere').value,
                detailedDiscount: document.getElementById('detailedDiscount').value,
                services: getSelectedServices(),
                priceRange: document.getElementById('priceRange').value,
                capacity: document.getElementById('capacity').value,
                accessInfo: document.getElementById('accessInfo').value,
                nearestStation: document.getElementById('nearestStation').value,
                parkingInfo: document.getElementById('parkingInfo').value,
                lastUpdated: new Date().toISOString()
            };

            // ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’åé›†
            const mainImageEl = document.querySelector('#mainImagePreview img');
            if (mainImageEl) {
                data.mainImage = mainImageEl.src;
            }

            const logoImageEl = document.querySelector('#logoImagePreview img');
            if (logoImageEl) {
                data.logoImage = logoImageEl.src;
            }

            const additionalImages = [];
            const additionalImagesEls = document.querySelectorAll('#additionalImagesPreview img');
            additionalImagesEls.forEach(img => {
                additionalImages.push(img.src);
            });
            data.additionalImages = additionalImages;

            console.log('Final collected data:', data);
            return data;
        }

        // é¸æŠã•ã‚ŒãŸã‚µãƒ¼ãƒ“ã‚¹ã‚’å–å¾—
        function getSelectedServices() {
            const services = [];
            if (document.getElementById('serviceWifi').checked) services.push('wifi');
            if (document.getElementById('serviceParking').checked) services.push('parking');
            if (document.getElementById('serviceCard').checked) services.push('card');
            if (document.getElementById('serviceBarrierFree').checked) services.push('barrier-free');
            return services;
        }

        // ç”»åƒåœ§ç¸®æ©Ÿèƒ½
        function compressImage(canvas, quality = 0.6) {
            return new Promise((resolve) => {
                canvas.toBlob((blob) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.readAsDataURL(blob);
                }, 'image/jpeg', quality);
            });
        }

        // ç”»åƒãƒªã‚µã‚¤ã‚ºã¨åœ§ç¸®
        function resizeAndCompressImage(base64, maxWidth = 800, quality = 0.6) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = async () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // ã‚µã‚¤ã‚ºè¨ˆç®—
                    let { width, height } = img;
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    const compressed = await compressImage(canvas, quality);
                    resolve(compressed);
                };
                img.src = base64;
            });
        }

        // æ–°ã—ã„ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨ã—ãŸãƒ‡ãƒ¼ã‚¿æ›´æ–°
        async function updateSponsorData(editData) {
            try {
                console.log('ğŸ”„ æ–°ã—ã„ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚·ã‚¹ãƒ†ãƒ ã§ä¿å­˜é–‹å§‹...');
                
                // ã‚¹ãƒãƒ¼ãƒˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚’ä½¿ç”¨
                if (window.sponsorStorage) {
                    const success = await window.sponsorStorage.saveStore(editData);
                    
                    if (success) {
                        // å¾“æ¥ã‚·ã‚¹ãƒ†ãƒ ã¨ã®äº’æ›æ€§ã®ãŸã‚ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜
                        try {
                            let sponsors = JSON.parse(localStorage.getItem('registeredSponsors') || '[]');
                            const index = sponsors.findIndex(s => s.id === editData.id);
                            
                            if (index !== -1) {
                                sponsors[index] = editData;
                            } else {
                                sponsors.push(editData);
                            }
                            
                            // ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯å¾Œã«ä¿å­˜
                            const dataSize = new Blob([JSON.stringify(sponsors)]).size;
                            if (dataSize < 2 * 1024 * 1024) { // 2MBæœªæº€ãªã‚‰ä¿å­˜
                                localStorage.setItem('registeredSponsors', JSON.stringify(sponsors));
                                console.log('âœ… Legacy storage updated');
                            }
                        } catch (legacyError) {
                            console.log('âš ï¸ Legacy storage skipped:', legacyError.message);
                        }
                        
                        currentSponsorData = editData;
                        console.log('âœ… æ–°ã—ã„ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚·ã‚¹ãƒ†ãƒ ã§ä¿å­˜å®Œäº†');
                        return true;
                    } else {
                        console.error('âŒ æ–°ã—ã„ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚·ã‚¹ãƒ†ãƒ ã§ã®ä¿å­˜ã«å¤±æ•—');
                        return false;
                    }
                } else {
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å¾“æ¥ã‚·ã‚¹ãƒ†ãƒ ï¼ˆåœ§ç¸®ã‚ã‚Šï¼‰
                    console.log('âš ï¸ æ–°ã—ã„ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚·ã‚¹ãƒ†ãƒ æœªå¯¾å¿œã€å¾“æ¥ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨');
                    return await legacyUpdateSponsorData(editData);
                }
                
            } catch (error) {
                console.error('âŒ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼:', error);
                alert('ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼š' + error.message);
                return false;
            }
        }

        // å¾“æ¥ã‚·ã‚¹ãƒ†ãƒ ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
        async function legacyUpdateSponsorData(editData) {
            try {
                // åŸºæœ¬çš„ãªåœ§ç¸®å‡¦ç†
                if (editData.mainImage && editData.mainImage.startsWith('data:image/')) {
                    editData.mainImage = await resizeAndCompressImage(editData.mainImage, 400, 0.6);
                }
                if (editData.logoImage && editData.logoImage.startsWith('data:image/')) {
                    editData.logoImage = await resizeAndCompressImage(editData.logoImage, 150, 0.7);
                }
                if (editData.additionalImages && editData.additionalImages.length > 0) {
                    editData.additionalImages = editData.additionalImages.slice(0, 2); // 2æšã¾ã§
                    const compressedImages = [];
                    for (const img of editData.additionalImages) {
                        if (img.startsWith('data:image/')) {
                            compressedImages.push(await resizeAndCompressImage(img, 300, 0.5));
                        } else {
                            compressedImages.push(img);
                        }
                    }
                    editData.additionalImages = compressedImages;
                }

                let sponsors = JSON.parse(localStorage.getItem('registeredSponsors') || '[]');
                const index = sponsors.findIndex(s => s.id === editData.id);
                
                if (index !== -1) {
                    sponsors[index] = editData;
                } else {
                    sponsors.push(editData);
                }
                
                // æœ€å¤§20ä»¶ã¾ã§ä¿æŒ
                if (sponsors.length > 20) {
                    sponsors = sponsors.slice(-20);
                }
                
                localStorage.setItem('registeredSponsors', JSON.stringify(sponsors));
                localStorage.setItem(editData.id, JSON.stringify(editData));
                
                currentSponsorData = editData;
                console.log('âœ… Legacy system save completed');
                return true;
                
            } catch (error) {
                console.error('âŒ Legacy system failed:', error);
                return false;
            }
        }

        // ç”»åƒæ•°ã‚’è‡ªå‹•å‰Šæ¸›
        function reduceImageCount() {
            const additionalPreview = document.getElementById('additionalImagesPreview');
            const images = additionalPreview.querySelectorAll('.preview-image');
            const halfCount = Math.floor(images.length / 2);
            
            for (let i = halfCount; i < images.length; i++) {
                images[i].closest('.d-inline-block').remove();
            }
            
            alert(`ç”»åƒæ•°ã‚’${halfCount}æšã«å‰Šæ¸›ã—ã¾ã—ãŸã€‚å†åº¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚`);
        }

        // Draft Management Functions
        function saveDraft() {
            console.log('ğŸ’¾ Saving draft...');
            
            const formData = collectFormData();
            if (!formData || !formData.storeName || !formData.storeName.trim()) {
                alert('åº—èˆ—åãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚æœ€ä½é™åº—èˆ—åã‚’å…¥åŠ›ã—ã¦ã‹ã‚‰ä¿å­˜ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const urlParams = new URLSearchParams(window.location.search);
            const currentSponsorId = urlParams.get('id');
            
            if (!currentSponsorId) {
                alert('åº—èˆ—IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }

            const draftKey = `draft_${currentSponsorId}`;
            const draftData = {
                ...formData,
                status: 'draft',
                savedAt: new Date().toISOString(),
                savedItems: getSavedItemsList(formData)
            };

            try {
                localStorage.setItem(draftKey, JSON.stringify(draftData));
                updateDraftUI(draftData);
                
                // Show success feedback  
                const btn = event?.target || document.querySelector('button[onclick="saveDraft()"]');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="bi bi-check-circle"></i> ä¿å­˜å®Œäº†';
                btn.style.background = '#28a745';
                btn.style.color = 'white';
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '#fff';
                    btn.style.color = '#ff8f00';
                }, 2000);
                
                console.log('âœ… Draft saved successfully');
            } catch (error) {
                console.error('âŒ Failed to save draft:', error);
                alert('ä¸‹æ›¸ãã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸï¼š' + error.message);
            }
        }

        function loadDraft() {
            console.log('ğŸ“¥ Loading draft...');
            
            const urlParams = new URLSearchParams(window.location.search);
            const currentSponsorId = urlParams.get('id');
            
            if (!currentSponsorId) {
                alert('åº—èˆ—IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            
            const draftKey = `draft_${currentSponsorId}`;
            const savedDraft = localStorage.getItem(draftKey);
            
            if (savedDraft) {
                try {
                    const draftData = JSON.parse(savedDraft);
                    
                    if (confirm('ä¿å­˜ã•ã‚ŒãŸä¸‹æ›¸ãã‚’èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿç¾åœ¨ã®å…¥åŠ›å†…å®¹ã¯å¤±ã‚ã‚Œã¾ã™ã€‚')) {
                        populateFormWithData(draftData);
                        updateDraftUI(draftData);
                        console.log('âœ… Draft loaded successfully');
                        
                        // Show success feedback
                        const btn = event?.target || document.querySelector('button[onclick="loadDraft()"]');
                        const originalText = btn.innerHTML;
                        btn.innerHTML = '<i class="bi bi-check-circle"></i> èª­è¾¼å®Œäº†';
                        btn.style.background = '#28a745';
                        btn.style.color = 'white';
                        
                        setTimeout(() => {
                            btn.innerHTML = originalText;
                            btn.style.background = '#fff';
                            btn.style.color = '#ff8f00';
                        }, 2000);
                    }
                } catch (error) {
                    console.error('âŒ Failed to load draft:', error);
                    alert('ä¸‹æ›¸ãã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼š' + error.message);
                }
            } else {
                alert('ä¿å­˜ã•ã‚ŒãŸä¸‹æ›¸ããŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
            }
        }

        function checkForExistingDraft() {
            console.log('ğŸ” Checking for existing draft...');
            
            const urlParams = new URLSearchParams(window.location.search);
            const currentSponsorId = urlParams.get('id');
            
            if (!currentSponsorId) {
                console.log('No sponsor ID found in URL');
                return;
            }
            
            const draftKey = `draft_${currentSponsorId}`;
            const savedDraft = localStorage.getItem(draftKey);
            
            if (savedDraft) {
                try {
                    const draftData = JSON.parse(savedDraft);
                    document.getElementById('loadDraftBtn').style.display = 'inline-block';
                    updateDraftUI(draftData);
                    
                    // Show notification
                    const notification = document.createElement('div');
                    notification.className = 'alert alert-warning alert-dismissible fade show';
                    notification.innerHTML = `
                        <strong>ä¸‹æ›¸ããŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸï¼</strong> 
                        ${new Date(draftData.savedAt).toLocaleString()}ã«ä¿å­˜ã•ã‚ŒãŸä¸‹æ›¸ããŒã‚ã‚Šã¾ã™ã€‚
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    
                    const draftManagement = document.getElementById('draftManagement');
                    draftManagement.insertAdjacentElement('afterend', notification);
                    
                    console.log('ğŸ“‹ Found existing draft from:', draftData.savedAt);
                } catch (error) {
                    console.error('âŒ Error checking draft:', error);
                }
            }
        }

        function updateDraftUI(draftData) {
            const lastSaved = document.getElementById('lastSaved');
            const draftInfo = document.getElementById('draftInfo');
            const savedItems = document.getElementById('savedItems');
            const draftTimestamp = document.getElementById('draftTimestamp');

            lastSaved.textContent = `æœ€çµ‚ä¿å­˜: ${new Date(draftData.savedAt).toLocaleString()}`;
            draftInfo.style.display = 'block';
            savedItems.textContent = draftData.savedItems.join(', ');
            draftTimestamp.textContent = new Date(draftData.savedAt).toLocaleString();
        }

        function getSavedItemsList(formData) {
            const items = [];
            if (formData.storeName) items.push('åº—èˆ—å');
            if (formData.detailedDescription) items.push('è©³ç´°èª¬æ˜');
            if (formData.specialty) items.push('å°‚é–€ãƒ»ç‰¹è‰²');
            if (formData.atmosphere) items.push('é›°å›²æ°—');
            if (formData.detailedDiscount) items.push('å‰²å¼•è©³ç´°');
            if (formData.services && formData.services.length > 0) items.push('ã‚µãƒ¼ãƒ“ã‚¹');
            if (formData.priceRange) items.push('ä¾¡æ ¼å¸¯');
            if (formData.capacity) items.push('åå®¹äººæ•°');
            if (formData.accessInfo) items.push('ã‚¢ã‚¯ã‚»ã‚¹æƒ…å ±');
            if (formData.nearestStation) items.push('æœ€å¯„ã‚Šé§…');
            if (formData.parkingInfo) items.push('é§è»Šå ´æƒ…å ±');
            
            return items.length > 0 ? items : ['åŸºæœ¬æƒ…å ±'];
        }

        function populateFormWithData(data) {
            // Basic fields
            if (data.detailedDescription) document.getElementById('detailedDescription').value = data.detailedDescription;
            if (data.specialty) document.getElementById('specialty').value = data.specialty;
            if (data.atmosphere) document.getElementById('atmosphere').value = data.atmosphere;
            if (data.detailedDiscount) document.getElementById('detailedDiscount').value = data.detailedDiscount;
            if (data.priceRange) document.getElementById('priceRange').value = data.priceRange;
            if (data.capacity) document.getElementById('capacity').value = data.capacity;
            if (data.accessInfo) document.getElementById('accessInfo').value = data.accessInfo;
            if (data.nearestStation) document.getElementById('nearestStation').value = data.nearestStation;
            if (data.parkingInfo) document.getElementById('parkingInfo').value = data.parkingInfo;

            // Services checkboxes
            if (data.services && Array.isArray(data.services)) {
                // First clear all checkboxes
                document.querySelectorAll('input[name="services"]').forEach(cb => cb.checked = false);
                // Then check the saved ones
                data.services.forEach(service => {
                    let checkboxId;
                    switch(service) {
                        case 'wifi': checkboxId = 'serviceWifi'; break;
                        case 'parking': checkboxId = 'serviceParking'; break;
                        case 'card': checkboxId = 'serviceCard'; break;
                        case 'barrier-free': checkboxId = 'serviceBarrierFree'; break;
                        default: checkboxId = `service${service.charAt(0).toUpperCase() + service.slice(1)}`;
                    }
                    const checkbox = document.getElementById(checkboxId);
                    if (checkbox) checkbox.checked = true;
                });
            }
        }

        // Auto-save functionality
        let autoSaveTimer;
        function setupAutoSave() {
            const form = document.getElementById('sponsorEditForm');
            const inputs = form.querySelectorAll('input, textarea, select');
            
            inputs.forEach(input => {
                input.addEventListener('input', () => {
                    clearTimeout(autoSaveTimer);
                    autoSaveTimer = setTimeout(() => {
                        console.log('ğŸ”„ Auto-saving...');
                        saveDraft();
                    }, 30000); // Auto-save after 30 seconds of inactivity
                });
            });
        }

        // Initialize draft management on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(async () => {
                // æ–°ã—ã„ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–
                if (window.sponsorStorage) {
                    try {
                        await window.sponsorStorage.initialize();
                        
                        // ä½¿ç”¨é‡è¡¨ç¤º
                        const usage = window.sponsorStorage.getStorageUsage();
                        console.log(`ğŸ’¾ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä½¿ç”¨é‡: ${usage.totalSizeMB}MB`);
                        
                        // å®šæœŸã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã®è¨­å®š
                        if (parseFloat(usage.usagePercent) > 80) {
                            console.log('âš ï¸ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä½¿ç”¨é‡ãŒ80%ã‚’è¶…ãˆã¾ã—ãŸã€‚ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚');
                            await window.sponsorStorage.cleanupOldData();
                        }
                        
                        console.log('âœ… ã‚¹ãƒãƒ¼ãƒˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
                    } catch (error) {
                        console.error('âŒ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                    }
                }
                
                checkForExistingDraft();
                setupAutoSave();
            }, 1000);
        });

        console.log('âœ… Sponsor Edit Page with Draft Management Loaded');
    </script>
</body>
</html>