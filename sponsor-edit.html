<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>協賛店情報編集 - TomoTrip</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .edit-container {
            max-width: 900px;
            margin: 2rem auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header-section {
            background: linear-gradient(45deg, #fd7e14, #e83e8c);
            color: white;
            padding: 2rem;
            text-align: center;
        }
        .form-section {
            padding: 2rem;
        }
        .section-title {
            color: #fd7e14;
            font-weight: bold;
            margin-bottom: 1rem;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 0.5rem;
        }
        .progress-steps {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 2rem;
        }
        .step {
            display: inline-block;
            padding: 0.5rem 1rem;
            margin: 0.25rem;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        .step.completed {
            background: #28a745;
            color: white;
        }
        .step.current {
            background: #fd7e14;
            color: white;
        }
        .step.pending {
            background: #e9ecef;
            color: #6c757d;
        }
        .image-upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
        }
        .image-upload-area:hover {
            border-color: #fd7e14;
            background: #fff3cd;
        }
        .preview-image {
            max-width: 150px;
            max-height: 150px;
            object-fit: cover;
            border-radius: 8px;
            margin: 0.5rem;
        }
        .btn-primary {
            background: linear-gradient(45deg, #fd7e14, #e83e8c);
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
        }
        .btn-success {
            background: linear-gradient(45deg, #28a745, #20c997);
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
        }
        .form-control:focus {
            border-color: #fd7e14;
            box-shadow: 0 0 0 0.2rem rgba(253, 126, 20, 0.25);
        }
        .draft-management {
            background: linear-gradient(135deg, #ffc107 0%, #ff8f00 100%);
            color: #000;
            padding: 1rem 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            border: 2px solid #ffab00;
        }
        .draft-management h4 {
            margin-bottom: 1rem;
            font-weight: bold;
        }
        .btn-draft {
            background: #fff;
            color: #ff8f00;
            border: 2px solid #fff;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            font-weight: 600;
            margin: 0.25rem;
            transition: all 0.3s ease;
        }
        .btn-draft:hover {
            background: #ff8f00;
            color: #fff;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 143, 0, 0.3);
        }
        .draft-info {
            background: rgba(255, 255, 255, 0.2);
            padding: 1rem;
            border-radius: 10px;
            margin-top: 1rem;
        }
        .draft-timestamp {
            font-size: 0.9rem;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="edit-container">
            <!-- Header -->
            <div class="header-section">
                <h1><i class="bi bi-pencil-square"></i> 協賛店情報編集</h1>
                <p class="mb-0">詳細情報を追加して、魅力的な店舗ページを作成しましょう</p>
            </div>

            <!-- Draft Management Section -->
            <div class="form-section">
                <div class="draft-management" id="draftManagement">
                    <h4><i class="bi bi-file-earmark-text"></i> 下書き管理</h4>
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div id="draftStatus">
                                <p class="mb-0">自動保存機能で作業内容を安全に保持します</p>
                                <div class="draft-timestamp" id="lastSaved">最終保存: まだ保存されていません</div>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <button type="button" class="btn btn-draft" onclick="saveDraft()">
                                <i class="bi bi-cloud-arrow-up"></i> 下書き保存
                            </button>
                            <button type="button" class="btn btn-draft" onclick="loadDraft()" id="loadDraftBtn" style="display: none;">
                                <i class="bi bi-cloud-arrow-down"></i> 下書き読込
                            </button>
                        </div>
                    </div>
                    <div class="draft-info" id="draftInfo" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <small><strong>保存された項目:</strong></small>
                                <div id="savedItems" class="draft-timestamp"></div>
                            </div>
                            <div class="col-md-6">
                                <small><strong>下書き保存日時:</strong></small>
                                <div id="draftTimestamp" class="draft-timestamp"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Progress Steps -->
                <div class="progress-steps">
                    <div class="text-center">
                        <div class="step completed">
                            <i class="bi bi-check-circle"></i> 基本登録
                        </div>
                        <div class="step current">
                            <i class="bi bi-pencil"></i> 詳細編集
                        </div>
                        <div class="step pending">
                            <i class="bi bi-eye"></i> 公開
                        </div>
                    </div>
                </div>

                <!-- Store Info Display -->
                <div class="alert alert-info">
                    <strong>編集中の店舗：</strong> <span id="currentStoreName">読み込み中...</span>
                </div>

                <form id="sponsorEditForm">
                    <!-- 画像アップロードセクション -->
                    <div class="mb-4">
                        <h3 class="section-title"><i class="bi bi-camera"></i> 店舗画像</h3>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">メイン画像（店舗外観）</label>
                                <div class="image-upload-area" onclick="document.getElementById('mainImage').click()">
                                    <i class="bi bi-cloud-upload fs-1 text-muted"></i>
                                    <p class="mt-2 mb-0">クリックして画像をアップロード</p>
                                    <small class="text-muted">推奨サイズ: 800x600px</small>
                                </div>
                                <input type="file" id="mainImage" class="d-none" accept="image/*">
                                <div id="mainImagePreview" class="mt-2"></div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ロゴ・看板画像</label>
                                <div class="image-upload-area" onclick="document.getElementById('logoImage').click()">
                                    <i class="bi bi-shop fs-1 text-muted"></i>
                                    <p class="mt-2 mb-0">ロゴまたは看板画像</p>
                                    <small class="text-muted">推奨サイズ: 400x400px</small>
                                </div>
                                <input type="file" id="logoImage" class="d-none" accept="image/*">
                                <div id="logoImagePreview" class="mt-2"></div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">追加画像（内装・商品・メニューなど）</label>
                            <div class="image-upload-area" onclick="document.getElementById('additionalImages').click()">
                                <i class="bi bi-images fs-1 text-muted"></i>
                                <p class="mt-2 mb-0">複数の画像をアップロード可能</p>
                                <small class="text-muted">最大15枚まで</small>
                            </div>
                            <input type="file" id="additionalImages" class="d-none" accept="image/*" multiple>
                            <div id="additionalImagesPreview" class="mt-2"></div>
                        </div>
                    </div>

                    <!-- 詳細説明セクション -->
                    <div class="mb-4">
                        <h3 class="section-title"><i class="bi bi-chat-text"></i> 詳細説明</h3>
                        
                        <div class="mb-3">
                            <label for="detailedDescription" class="form-label">詳しい店舗紹介</label>
                            <textarea class="form-control" id="detailedDescription" rows="5" placeholder="お店の歴史、こだわり、雰囲気、おすすめ商品・メニューなどを詳しくご紹介ください"></textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="specialty" class="form-label">特色・売り</label>
                                <textarea class="form-control" id="specialty" rows="3" placeholder="例：創業50年の老舗、地元食材使用、職人の手作り"></textarea>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="atmosphere" class="form-label">店内の雰囲気</label>
                                <textarea class="form-control" id="atmosphere" rows="3" placeholder="例：落ち着いた和風空間、カジュアルで明るい、家族連れ歓迎"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- サービス詳細セクション -->
                    <div class="mb-4">
                        <h3 class="section-title"><i class="bi bi-star"></i> サービス詳細</h3>
                        
                        <div class="mb-3">
                            <label for="detailedDiscount" class="form-label">特典の詳細</label>
                            <textarea class="form-control" id="detailedDiscount" rows="3" placeholder="特典の利用方法、条件、期間などを詳しくご記入ください"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">提供サービス</label>
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="serviceWifi" value="wifi">
                                        <label class="form-check-label" for="serviceWifi">Wi-Fi無料</label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="serviceParking" value="parking">
                                        <label class="form-check-label" for="serviceParking">駐車場完備</label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="serviceCard" value="card">
                                        <label class="form-check-label" for="serviceCard">カード決済OK</label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="serviceBarrierFree" value="barrier-free">
                                        <label class="form-check-label" for="serviceBarrierFree">バリアフリー</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="priceRange" class="form-label">価格帯</label>
                                <select class="form-select" id="priceRange">
                                    <option value="">選択してください</option>
                                    <option value="budget">リーズナブル（〜1,000円）</option>
                                    <option value="moderate">中程度（1,000円〜3,000円）</option>
                                    <option value="upscale">高級（3,000円〜）</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="capacity" class="form-label">収容人数</label>
                                <input type="number" class="form-control" id="capacity" placeholder="例：50">
                            </div>
                        </div>
                    </div>

                    <!-- アクセス情報セクション -->
                    <div class="mb-4">
                        <h3 class="section-title"><i class="bi bi-geo-alt"></i> アクセス情報</h3>
                        
                        <div class="mb-3">
                            <label for="accessInfo" class="form-label">アクセス方法</label>
                            <textarea class="form-control" id="accessInfo" rows="3" placeholder="最寄り駅、バス停、目印となる建物などを詳しくご記入ください"></textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="nearestStation" class="form-label">最寄り駅</label>
                                <input type="text" class="form-control" id="nearestStation" placeholder="例：JR渋谷駅 徒歩5分">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="parkingInfo" class="form-label">駐車場情報</label>
                                <input type="text" class="form-control" id="parkingInfo" placeholder="例：専用駐車場10台、近隣コインパーキング有">
                            </div>
                        </div>
                    </div>

                    <!-- 保存・公開ボタン -->
                    <div class="text-center">
                        <button type="button" class="btn btn-secondary me-2" onclick="saveDraft()">
                            <i class="bi bi-save"></i> 下書き保存
                        </button>
                        <button type="button" class="btn btn-primary me-2" onclick="previewStore()">
                            <i class="bi bi-eye"></i> プレビュー
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-check-circle"></i> 完了して公開
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <!-- ストレージ最適化システム -->
  <script src="sponsor-storage-optimization.js"></script>
    <script>
        let currentSponsorId = null;
        let currentSponsorData = null;

        // ページロード時の初期化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing...');
            
            const urlParams = new URLSearchParams(window.location.search);
            currentSponsorId = urlParams.get('id');
            
            if (currentSponsorId) {
                loadSponsorData();
                
                // 画像アップロード設定
                console.log('Setting up image uploads...');
                setupImageUpload('mainImage', 'mainImagePreview', 1);
                setupImageUpload('logoImage', 'logoImagePreview', 1);
                setupImageUpload('additionalImages', 'additionalImagesPreview', 15);
                console.log('Image upload setup complete');
                
                // ボタンイベント設定
                setupButtonEvents();
                
            } else {
                alert('編集対象の店舗が見つかりません');
                window.location.href = 'index.html';
            }
        });

        // 店舗データの読み込み
        function loadSponsorData() {
            const sponsors = JSON.parse(localStorage.getItem('registeredSponsors') || '[]');
            currentSponsorData = sponsors.find(s => s.id === currentSponsorId);
            
            if (currentSponsorData) {
                console.log('✅ Found sponsor data:', currentSponsorData);
                
                // 店舗名を更新（「読み込み中」を解除）
                const storeNameDisplay = document.getElementById('currentStoreName');
                if (storeNameDisplay) {
                    storeNameDisplay.textContent = currentSponsorData.storeName || '店舗名未設定';
                }
                
                // 既存データがあれば入力フィールドに設定
                if (currentSponsorData.detailedDescription) {
                    document.getElementById('detailedDescription').value = currentSponsorData.detailedDescription;
                }
                if (currentSponsorData.specialty) {
                    document.getElementById('specialty').value = currentSponsorData.specialty;
                }
                if (currentSponsorData.atmosphere) {
                    document.getElementById('atmosphere').value = currentSponsorData.atmosphere;
                }
                if (currentSponsorData.detailedDiscount) {
                    document.getElementById('detailedDiscount').value = currentSponsorData.detailedDiscount;
                }
                if (currentSponsorData.priceRange) {
                    document.getElementById('priceRange').value = currentSponsorData.priceRange;
                }
                if (currentSponsorData.capacity) {
                    document.getElementById('capacity').value = currentSponsorData.capacity;
                }
                if (currentSponsorData.accessInfo) {
                    document.getElementById('accessInfo').value = currentSponsorData.accessInfo;
                }
                if (currentSponsorData.nearestStation) {
                    document.getElementById('nearestStation').value = currentSponsorData.nearestStation;
                }
                if (currentSponsorData.parkingInfo) {
                    document.getElementById('parkingInfo').value = currentSponsorData.parkingInfo;
                }

                // 画像の復元
                if (currentSponsorData.mainImage) {
                    displaySavedImage(currentSponsorData.mainImage, 'mainImagePreview');
                }
                if (currentSponsorData.logoImage) {
                    displaySavedImage(currentSponsorData.logoImage, 'logoImagePreview');
                }
                if (currentSponsorData.additionalImages && currentSponsorData.additionalImages.length > 0) {
                    currentSponsorData.additionalImages.forEach(imageSrc => {
                        displaySavedImage(imageSrc, 'additionalImagesPreview');
                    });
                }

                // サービスチェックボックスの復元
                if (currentSponsorData.services) {
                    currentSponsorData.services.forEach(service => {
                        let checkboxId;
                        switch(service) {
                            case 'wifi': checkboxId = 'serviceWifi'; break;
                            case 'parking': checkboxId = 'serviceParking'; break;
                            case 'card': checkboxId = 'serviceCard'; break;
                            case 'barrier-free': checkboxId = 'serviceBarrierFree'; break;
                            default: checkboxId = `service${service.charAt(0).toUpperCase() + service.slice(1)}`;
                        }
                        const checkbox = document.getElementById(checkboxId);
                        if (checkbox) {
                            checkbox.checked = true;
                        }
                    });
                }
            } else {
                console.error('❌ Sponsor data not found for ID:', currentSponsorId);
                
                // 「読み込み中」を「データなし」に変更
                const storeNameDisplay = document.getElementById('currentStoreName');
                if (storeNameDisplay) {
                    storeNameDisplay.textContent = 'データが見つかりません';
                }
                
                alert('店舗データが見つかりません');
                window.location.href = 'index.html';
            }
        }

        // 保存済み画像を表示
        function displaySavedImage(imageSrc, previewId) {
            const preview = document.getElementById(previewId);
            
            const imageContainer = document.createElement('div');
            imageContainer.className = 'd-inline-block position-relative m-1';
            
            const img = document.createElement('img');
            img.src = imageSrc;
            img.className = 'preview-image';
            
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'btn btn-sm btn-danger position-absolute top-0 end-0';
            removeBtn.style.transform = 'translate(25%, -25%)';
            removeBtn.innerHTML = '<i class="bi bi-x"></i>';
            removeBtn.onclick = function() {
                imageContainer.remove();
            };
            
            imageContainer.appendChild(img);
            imageContainer.appendChild(removeBtn);
            preview.appendChild(imageContainer);
        }

        // 画像圧縮関数
        function compressImage(file, maxWidth = 800, quality = 0.7) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    // 縦横比を保持してリサイズ
                    const ratio = Math.min(maxWidth / img.width, maxWidth / img.height);
                    canvas.width = img.width * ratio;
                    canvas.height = img.height * ratio;
                    
                    // 画像を描画
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    // 圧縮されたBase64を取得
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                    resolve(compressedDataUrl);
                };
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // 画像アップロード処理
        function setupImageUpload(inputId, previewId, maxImages = 15) {
            const input = document.getElementById(inputId);
            if (!input) {
                console.error(`Input element not found: ${inputId}`);
                return;
            }
            
            input.addEventListener('change', async function(e) {
                const files = e.target.files;
                const preview = document.getElementById(previewId);
                
                if (!preview) {
                    console.error(`Preview element not found: ${previewId}`);
                    return;
                }

                if (files.length > maxImages) {
                    alert(`画像は最大${maxImages}枚までアップロード可能です。`);
                    return;
                }

                // 既存の画像数をカウント
                const existingImages = preview.querySelectorAll('.preview-image').length;
                const totalImages = existingImages + files.length;
                
                if (totalImages > maxImages) {
                    alert(`合計で最大${maxImages}枚までです。現在${existingImages}枚あります。`);
                    return;
                }

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    
                    try {
                        // 画像を圧縮
                        const compressedDataUrl = await compressImage(file);
                        
                        const imageContainer = document.createElement('div');
                        imageContainer.className = 'd-inline-block position-relative m-1';
                        
                        const img = document.createElement('img');
                        img.src = compressedDataUrl;
                        img.className = 'preview-image';
                        
                        const removeBtn = document.createElement('button');
                        removeBtn.type = 'button';
                        removeBtn.className = 'btn btn-sm btn-danger position-absolute top-0 end-0';
                        removeBtn.style.transform = 'translate(25%, -25%)';
                        removeBtn.innerHTML = '<i class="bi bi-x"></i>';
                        removeBtn.onclick = function(event) {
                            event.preventDefault();
                            imageContainer.remove();
                        };
                        
                        imageContainer.appendChild(img);
                        imageContainer.appendChild(removeBtn);
                        
                        // 既存の画像をクリアしてから追加（単一画像の場合）
                        if (maxImages === 1) {
                            preview.innerHTML = '';
                        }
                        
                        preview.appendChild(imageContainer);
                        
                        console.log(`Image ${i + 1} processed and added to ${previewId}`);
                    } catch (error) {
                        console.error('Image processing error:', error);
                        alert(`画像 ${file.name} の処理に失敗しました`);
                    }
                }
            });
        }

        // ボタンイベント設定
        function setupButtonEvents() {
            console.log('Setting up button events...');
            
            // 下書き保存ボタン
            const draftBtn = document.querySelector('button[onclick="saveDraft()"]');
            if (draftBtn) {
                draftBtn.removeAttribute('onclick');
                draftBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    saveDraft();
                });
                console.log('Draft button event set');
            }
            
            // プレビューボタン
            const previewBtn = document.querySelector('button[onclick="previewStore()"]');
            if (previewBtn) {
                previewBtn.removeAttribute('onclick');
                previewBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    previewStore();
                });
                console.log('Preview button event set');
            }
            
            // フォーム送信イベント
            const form = document.getElementById('sponsorEditForm');
            if (form) {
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    console.log('Form submitted');
                    
                    // 送信ボタンを無効化
                    const submitBtn = form.querySelector('button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '🔄 公開中...';
                    
                    try {
                        const editData = collectFormData();
                        editData.status = 'published';
                        editData.publishDate = new Date().toISOString();
                        
                        const success = await updateSponsorData(editData);
                        if (success) {
                            alert('✅ 協賛店情報が公開されました！\n協賛店一覧ページでご確認いただけます。');
                            window.location.href = 'sponsor-list.html';
                        } else {
                            alert('❌ 公開に失敗しました。画像サイズを確認してもう一度お試しください。');
                        }
                    } catch (error) {
                        console.error('Publication error:', error);
                        alert('公開中にエラーが発生しました：' + error.message);
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                    }
                });
                console.log('Form submit event set');
            }
            
            console.log('Button events setup complete');
        }

        // 下書き保存
        function saveDraft() {
            console.log('Save draft clicked');
            const editData = collectFormData();
            editData.status = 'draft';
            editData.draftSavedAt = new Date().toISOString();
            
            if (updateSponsorData(editData)) {
                const continueUrl = `sponsor-edit.html?id=${currentSponsorId}`;
                const message = `下書きを保存しました！\n\n編集を続ける場合は、以下のURLから再開できます：\n${window.location.origin}/${continueUrl}\n\nまたは、協賛店管理ページの「下書き一覧」からアクセスできます。`;
                alert(message);
                
                // 下書き一覧への追加（管理用）
                addToDraftList(editData);
            }
        }
        
        // 下書き一覧への追加
        function addToDraftList(draftData) {
            try {
                let drafts = JSON.parse(localStorage.getItem('sponsorDrafts') || '[]');
                const existingIndex = drafts.findIndex(d => d.id === draftData.id);
                
                const draftItem = {
                    id: draftData.id,
                    storeName: draftData.storeName || '未設定',
                    category: draftData.category || '未分類',
                    savedAt: draftData.draftSavedAt,
                    editUrl: `sponsor-edit.html?id=${draftData.id}`
                };
                
                if (existingIndex !== -1) {
                    drafts[existingIndex] = draftItem;
                } else {
                    drafts.push(draftItem);
                }
                
                localStorage.setItem('sponsorDrafts', JSON.stringify(drafts));
                console.log('Draft added to list:', draftItem);
            } catch (error) {
                console.error('Failed to add to draft list:', error);
            }
        }

        // プレビュー（軽量化版）
        async function previewStore() {
            console.log('🔍 Preview button clicked');
            
            const editData = collectFormData();
            if (!editData) {
                alert('フォームデータの収集に失敗しました');
                return;
            }
            
            console.log('📋 Collected edit data:', editData);
            
            try {
                // プレビュー用に軽量化
                const lightPreviewData = {
                    id: editData.id,
                    storeName: editData.storeName,
                    category: editData.category,
                    address: editData.address,
                    phone: editData.phone,
                    email: editData.email,
                    website: editData.website,
                    openTime: editData.openTime,
                    closeTime: editData.closeTime,
                    holidays: editData.holidays,
                    detailedDescription: editData.detailedDescription,
                    specialty: editData.specialty,
                    atmosphere: editData.atmosphere,
                    detailedDiscount: editData.detailedDiscount,
                    services: editData.services,
                    priceRange: editData.priceRange,
                    capacity: editData.capacity,
                    accessInfo: editData.accessInfo,
                    nearestStation: editData.nearestStation,
                    parkingInfo: editData.parkingInfo,
                    // 画像は圧縮版を使用
                    mainImage: editData.mainImage ? await resizeAndCompressImage(editData.mainImage, 300, 0.6) : null,
                    logoImage: editData.logoImage ? await resizeAndCompressImage(editData.logoImage, 100, 0.7) : null,
                    additionalImages: editData.additionalImages ? (await Promise.all(
                        editData.additionalImages.slice(0, 2).map(img => 
                            img.startsWith('data:image/') ? resizeAndCompressImage(img, 300, 0.5) : Promise.resolve(img)
                        )
                    )) : [],
                    lastUpdated: editData.lastUpdated,
                    status: 'preview'
                };
                
                const previewKey = `preview_${editData.id}`;
                localStorage.setItem(previewKey, JSON.stringify(lightPreviewData));
                console.log('✅ Lightweight preview data saved');
                
                // registeredSponsorsにも軽量版で保存
                let registeredSponsors = JSON.parse(localStorage.getItem('registeredSponsors') || '[]');
                const existingIndex = registeredSponsors.findIndex(s => s.id === editData.id);
                
                if (existingIndex !== -1) {
                    registeredSponsors[existingIndex] = { ...registeredSponsors[existingIndex], ...lightPreviewData };
                } else {
                    registeredSponsors.push(lightPreviewData);
                }
                
                // サイズチェックして保存
                const dataString = JSON.stringify(registeredSponsors);
                const sizeInMB = new Blob([dataString]).size / (1024 * 1024);
                console.log('💾 Total size:', sizeInMB.toFixed(2), 'MB');
                
                if (sizeInMB < 4) {
                    localStorage.setItem('registeredSponsors', dataString);
                    console.log('✅ Data saved to registeredSponsors');
                } else {
                    console.log('⚠️ サイズ超過のため registeredSponsors への保存をスキップ');
                }
                
                // プレビューを新しいタブで開く
                const previewWindow = window.open(`sponsor-preview.html?id=${editData.id}`, '_blank');
                
                if (!previewWindow) {
                    alert('ポップアップがブロックされました。ポップアップを許可してから再度お試しください。');
                }
                
            } catch (error) {
                console.error('❌ Failed to save preview data:', error);
                if (error.name === 'QuotaExceededError') {
                    alert('ストレージ容量が不足しています。画像を削除するか、ブラウザデータを整理してください。');
                } else {
                    alert('プレビューデータの保存に失敗しました：' + error.message);
                }
            }
        }



        // フォームデータ収集
        function collectFormData() {
            console.log('Collecting form data...');
            
            // 基本データの収集
            const data = {
                id: currentSponsorId,
                storeName: document.getElementById('storeName')?.value || currentSponsorData?.storeName || '',
                category: document.getElementById('category')?.value || currentSponsorData?.category || '',
                address: document.getElementById('address')?.value || currentSponsorData?.address || '',
                phone: document.getElementById('phone')?.value || currentSponsorData?.phone || '',
                email: document.getElementById('email')?.value || currentSponsorData?.email || '',
                website: document.getElementById('website')?.value || currentSponsorData?.website || '',
                openTime: document.getElementById('openTime')?.value || currentSponsorData?.openTime || '',
                closeTime: document.getElementById('closeTime')?.value || currentSponsorData?.closeTime || '',
                holidays: document.getElementById('holidays')?.value || currentSponsorData?.holidays || '',
                detailedDescription: document.getElementById('detailedDescription').value,
                specialty: document.getElementById('specialty').value,
                atmosphere: document.getElementById('atmosphere').value,
                detailedDiscount: document.getElementById('detailedDiscount').value,
                services: getSelectedServices(),
                priceRange: document.getElementById('priceRange').value,
                capacity: document.getElementById('capacity').value,
                accessInfo: document.getElementById('accessInfo').value,
                nearestStation: document.getElementById('nearestStation').value,
                parkingInfo: document.getElementById('parkingInfo').value,
                lastUpdated: new Date().toISOString()
            };

            // 画像データを収集
            const mainImageEl = document.querySelector('#mainImagePreview img');
            if (mainImageEl) {
                data.mainImage = mainImageEl.src;
            }

            const logoImageEl = document.querySelector('#logoImagePreview img');
            if (logoImageEl) {
                data.logoImage = logoImageEl.src;
            }

            const additionalImages = [];
            const additionalImagesEls = document.querySelectorAll('#additionalImagesPreview img');
            additionalImagesEls.forEach(img => {
                additionalImages.push(img.src);
            });
            data.additionalImages = additionalImages;

            console.log('Final collected data:', data);
            return data;
        }

        // 選択されたサービスを取得
        function getSelectedServices() {
            const services = [];
            if (document.getElementById('serviceWifi').checked) services.push('wifi');
            if (document.getElementById('serviceParking').checked) services.push('parking');
            if (document.getElementById('serviceCard').checked) services.push('card');
            if (document.getElementById('serviceBarrierFree').checked) services.push('barrier-free');
            return services;
        }

        // 画像圧縮機能
        function compressImage(canvas, quality = 0.6) {
            return new Promise((resolve) => {
                canvas.toBlob((blob) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.readAsDataURL(blob);
                }, 'image/jpeg', quality);
            });
        }

        // 画像リサイズと圧縮
        function resizeAndCompressImage(base64, maxWidth = 800, quality = 0.6) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = async () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // サイズ計算
                    let { width, height } = img;
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    const compressed = await compressImage(canvas, quality);
                    resolve(compressed);
                };
                img.src = base64;
            });
        }

        // 新しいストレージシステムを使用したデータ更新
        async function updateSponsorData(editData) {
            try {
                console.log('🔄 新しいストレージシステムで保存開始...');
                
                // スマートストレージマネージャーを使用
                if (window.sponsorStorage) {
                    const success = await window.sponsorStorage.saveStore(editData);
                    
                    if (success) {
                        // 従来システムとの互換性のためのバックアップ保存
                        try {
                            let sponsors = JSON.parse(localStorage.getItem('registeredSponsors') || '[]');
                            const index = sponsors.findIndex(s => s.id === editData.id);
                            
                            if (index !== -1) {
                                sponsors[index] = editData;
                            } else {
                                sponsors.push(editData);
                            }
                            
                            // サイズチェック後に保存
                            const dataSize = new Blob([JSON.stringify(sponsors)]).size;
                            if (dataSize < 2 * 1024 * 1024) { // 2MB未満なら保存
                                localStorage.setItem('registeredSponsors', JSON.stringify(sponsors));
                                console.log('✅ Legacy storage updated');
                            }
                        } catch (legacyError) {
                            console.log('⚠️ Legacy storage skipped:', legacyError.message);
                        }
                        
                        currentSponsorData = editData;
                        console.log('✅ 新しいストレージシステムで保存完了');
                        return true;
                    } else {
                        console.error('❌ 新しいストレージシステムでの保存に失敗');
                        return false;
                    }
                } else {
                    // フォールバック: 従来システム（圧縮あり）
                    console.log('⚠️ 新しいストレージシステム未対応、従来システムを使用');
                    return await legacyUpdateSponsorData(editData);
                }
                
            } catch (error) {
                console.error('❌ ストレージシステムエラー:', error);
                alert('保存中にエラーが発生しました：' + error.message);
                return false;
            }
        }

        // 従来システム（フォールバック用）
        async function legacyUpdateSponsorData(editData) {
            try {
                // 基本的な圧縮処理
                if (editData.mainImage && editData.mainImage.startsWith('data:image/')) {
                    editData.mainImage = await resizeAndCompressImage(editData.mainImage, 400, 0.6);
                }
                if (editData.logoImage && editData.logoImage.startsWith('data:image/')) {
                    editData.logoImage = await resizeAndCompressImage(editData.logoImage, 150, 0.7);
                }
                if (editData.additionalImages && editData.additionalImages.length > 0) {
                    editData.additionalImages = editData.additionalImages.slice(0, 2); // 2枚まで
                    const compressedImages = [];
                    for (const img of editData.additionalImages) {
                        if (img.startsWith('data:image/')) {
                            compressedImages.push(await resizeAndCompressImage(img, 300, 0.5));
                        } else {
                            compressedImages.push(img);
                        }
                    }
                    editData.additionalImages = compressedImages;
                }

                let sponsors = JSON.parse(localStorage.getItem('registeredSponsors') || '[]');
                const index = sponsors.findIndex(s => s.id === editData.id);
                
                if (index !== -1) {
                    sponsors[index] = editData;
                } else {
                    sponsors.push(editData);
                }
                
                // 最大20件まで保持
                if (sponsors.length > 20) {
                    sponsors = sponsors.slice(-20);
                }
                
                localStorage.setItem('registeredSponsors', JSON.stringify(sponsors));
                localStorage.setItem(editData.id, JSON.stringify(editData));
                
                currentSponsorData = editData;
                console.log('✅ Legacy system save completed');
                return true;
                
            } catch (error) {
                console.error('❌ Legacy system failed:', error);
                return false;
            }
        }

        // 画像数を自動削減
        function reduceImageCount() {
            const additionalPreview = document.getElementById('additionalImagesPreview');
            const images = additionalPreview.querySelectorAll('.preview-image');
            const halfCount = Math.floor(images.length / 2);
            
            for (let i = halfCount; i < images.length; i++) {
                images[i].closest('.d-inline-block').remove();
            }
            
            alert(`画像数を${halfCount}枚に削減しました。再度保存してください。`);
        }

        // Draft Management Functions
        function saveDraft() {
            console.log('💾 Saving draft...');
            
            const formData = collectFormData();
            if (!formData || !formData.storeName || !formData.storeName.trim()) {
                alert('店舗名が入力されていません。最低限店舗名を入力してから保存してください。');
                return;
            }

            const urlParams = new URLSearchParams(window.location.search);
            const currentSponsorId = urlParams.get('id');
            
            if (!currentSponsorId) {
                alert('店舗IDが見つかりません。');
                return;
            }

            const draftKey = `draft_${currentSponsorId}`;
            const draftData = {
                ...formData,
                status: 'draft',
                savedAt: new Date().toISOString(),
                savedItems: getSavedItemsList(formData)
            };

            try {
                localStorage.setItem(draftKey, JSON.stringify(draftData));
                updateDraftUI(draftData);
                
                // Show success feedback  
                const btn = event?.target || document.querySelector('button[onclick="saveDraft()"]');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="bi bi-check-circle"></i> 保存完了';
                btn.style.background = '#28a745';
                btn.style.color = 'white';
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '#fff';
                    btn.style.color = '#ff8f00';
                }, 2000);
                
                console.log('✅ Draft saved successfully');
            } catch (error) {
                console.error('❌ Failed to save draft:', error);
                alert('下書きの保存に失敗しました：' + error.message);
            }
        }

        function loadDraft() {
            console.log('📥 Loading draft...');
            
            const urlParams = new URLSearchParams(window.location.search);
            const currentSponsorId = urlParams.get('id');
            
            if (!currentSponsorId) {
                alert('店舗IDが見つかりません。');
                return;
            }
            
            const draftKey = `draft_${currentSponsorId}`;
            const savedDraft = localStorage.getItem(draftKey);
            
            if (savedDraft) {
                try {
                    const draftData = JSON.parse(savedDraft);
                    
                    if (confirm('保存された下書きを読み込みますか？現在の入力内容は失われます。')) {
                        populateFormWithData(draftData);
                        updateDraftUI(draftData);
                        console.log('✅ Draft loaded successfully');
                        
                        // Show success feedback
                        const btn = event?.target || document.querySelector('button[onclick="loadDraft()"]');
                        const originalText = btn.innerHTML;
                        btn.innerHTML = '<i class="bi bi-check-circle"></i> 読込完了';
                        btn.style.background = '#28a745';
                        btn.style.color = 'white';
                        
                        setTimeout(() => {
                            btn.innerHTML = originalText;
                            btn.style.background = '#fff';
                            btn.style.color = '#ff8f00';
                        }, 2000);
                    }
                } catch (error) {
                    console.error('❌ Failed to load draft:', error);
                    alert('下書きの読み込みに失敗しました：' + error.message);
                }
            } else {
                alert('保存された下書きが見つかりません。');
            }
        }

        function checkForExistingDraft() {
            console.log('🔍 Checking for existing draft...');
            
            const urlParams = new URLSearchParams(window.location.search);
            const currentSponsorId = urlParams.get('id');
            
            if (!currentSponsorId) {
                console.log('No sponsor ID found in URL');
                return;
            }
            
            const draftKey = `draft_${currentSponsorId}`;
            const savedDraft = localStorage.getItem(draftKey);
            
            if (savedDraft) {
                try {
                    const draftData = JSON.parse(savedDraft);
                    document.getElementById('loadDraftBtn').style.display = 'inline-block';
                    updateDraftUI(draftData);
                    
                    // Show notification
                    const notification = document.createElement('div');
                    notification.className = 'alert alert-warning alert-dismissible fade show';
                    notification.innerHTML = `
                        <strong>下書きが見つかりました！</strong> 
                        ${new Date(draftData.savedAt).toLocaleString()}に保存された下書きがあります。
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    
                    const draftManagement = document.getElementById('draftManagement');
                    draftManagement.insertAdjacentElement('afterend', notification);
                    
                    console.log('📋 Found existing draft from:', draftData.savedAt);
                } catch (error) {
                    console.error('❌ Error checking draft:', error);
                }
            }
        }

        function updateDraftUI(draftData) {
            const lastSaved = document.getElementById('lastSaved');
            const draftInfo = document.getElementById('draftInfo');
            const savedItems = document.getElementById('savedItems');
            const draftTimestamp = document.getElementById('draftTimestamp');

            lastSaved.textContent = `最終保存: ${new Date(draftData.savedAt).toLocaleString()}`;
            draftInfo.style.display = 'block';
            savedItems.textContent = draftData.savedItems.join(', ');
            draftTimestamp.textContent = new Date(draftData.savedAt).toLocaleString();
        }

        function getSavedItemsList(formData) {
            const items = [];
            if (formData.storeName) items.push('店舗名');
            if (formData.detailedDescription) items.push('詳細説明');
            if (formData.specialty) items.push('専門・特色');
            if (formData.atmosphere) items.push('雰囲気');
            if (formData.detailedDiscount) items.push('割引詳細');
            if (formData.services && formData.services.length > 0) items.push('サービス');
            if (formData.priceRange) items.push('価格帯');
            if (formData.capacity) items.push('収容人数');
            if (formData.accessInfo) items.push('アクセス情報');
            if (formData.nearestStation) items.push('最寄り駅');
            if (formData.parkingInfo) items.push('駐車場情報');
            
            return items.length > 0 ? items : ['基本情報'];
        }

        function populateFormWithData(data) {
            // Basic fields
            if (data.detailedDescription) document.getElementById('detailedDescription').value = data.detailedDescription;
            if (data.specialty) document.getElementById('specialty').value = data.specialty;
            if (data.atmosphere) document.getElementById('atmosphere').value = data.atmosphere;
            if (data.detailedDiscount) document.getElementById('detailedDiscount').value = data.detailedDiscount;
            if (data.priceRange) document.getElementById('priceRange').value = data.priceRange;
            if (data.capacity) document.getElementById('capacity').value = data.capacity;
            if (data.accessInfo) document.getElementById('accessInfo').value = data.accessInfo;
            if (data.nearestStation) document.getElementById('nearestStation').value = data.nearestStation;
            if (data.parkingInfo) document.getElementById('parkingInfo').value = data.parkingInfo;

            // Services checkboxes
            if (data.services && Array.isArray(data.services)) {
                // First clear all checkboxes
                document.querySelectorAll('input[name="services"]').forEach(cb => cb.checked = false);
                // Then check the saved ones
                data.services.forEach(service => {
                    let checkboxId;
                    switch(service) {
                        case 'wifi': checkboxId = 'serviceWifi'; break;
                        case 'parking': checkboxId = 'serviceParking'; break;
                        case 'card': checkboxId = 'serviceCard'; break;
                        case 'barrier-free': checkboxId = 'serviceBarrierFree'; break;
                        default: checkboxId = `service${service.charAt(0).toUpperCase() + service.slice(1)}`;
                    }
                    const checkbox = document.getElementById(checkboxId);
                    if (checkbox) checkbox.checked = true;
                });
            }
        }

        // Auto-save functionality
        let autoSaveTimer;
        function setupAutoSave() {
            const form = document.getElementById('sponsorEditForm');
            const inputs = form.querySelectorAll('input, textarea, select');
            
            inputs.forEach(input => {
                input.addEventListener('input', () => {
                    clearTimeout(autoSaveTimer);
                    autoSaveTimer = setTimeout(() => {
                        console.log('🔄 Auto-saving...');
                        saveDraft();
                    }, 30000); // Auto-save after 30 seconds of inactivity
                });
            });
        }

        // Initialize draft management on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(async () => {
                // 新しいストレージシステムの初期化
                if (window.sponsorStorage) {
                    try {
                        await window.sponsorStorage.initialize();
                        
                        // 使用量表示
                        const usage = window.sponsorStorage.getStorageUsage();
                        console.log(`💾 ストレージ使用量: ${usage.totalSizeMB}MB`);
                        
                        // 定期クリーンアップの設定
                        if (parseFloat(usage.usagePercent) > 80) {
                            console.log('⚠️ ストレージ使用量が80%を超えました。クリーンアップを実行します。');
                            await window.sponsorStorage.cleanupOldData();
                        }
                        
                        console.log('✅ スマートストレージシステム初期化完了');
                    } catch (error) {
                        console.error('❌ ストレージシステム初期化エラー:', error);
                    }
                }
                
                checkForExistingDraft();
                setupAutoSave();
            }, 1000);
        });

        console.log('✅ Sponsor Edit Page with Draft Management Loaded');
    </script>
</body>
</html>