<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å”è³›åº—ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ - TomoTrip</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 3rem 0;
        }
        .preview-card {
            border: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 2rem;
        }
        .store-image {
            width: 100%;
            height: 300px;
            object-fit: cover;
        }
        .category-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255,255,255,0.9);
            color: #333;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .benefit-tag {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            margin: 0.2rem;
            display: inline-block;
        }
        .language-tag {
            background: #3742fa;
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 10px;
            font-size: 0.75rem;
            margin: 0.1rem;
        }
        .info-section {
            background: #f8f9ff;
            padding: 1.5rem;
            border-radius: 10px;
            margin: 1rem 0;
        }
        .contact-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            padding: 0.8rem 2rem;
            border-radius: 25px;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .contact-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            color: white;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="gradient-bg">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="bi bi-eye"></i> å”è³›åº—ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h1>
                    <p class="lead mb-0">ãŠå®¢æ§˜ã‹ã‚‰è¦‹ãˆã‚‹åº—èˆ—æƒ…å ±ã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ãã¾ã™</p>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-light me-2" onclick="goBackToEdit()">
                        <i class="bi bi-arrow-left"></i> æˆ»ã‚‹
                    </button>
                    <a href="sponsor-list.html" class="btn btn-outline-light">
                        <i class="bi bi-list"></i> ä¸€è¦§è¡¨ç¤º
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container my-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <!-- Preview Card -->
                <div class="card preview-card" id="previewCard">
                    <div class="position-relative">
                        <img id="previewImage" src="" alt="åº—èˆ—ç”»åƒ" class="store-image" style="display: none;">
                        <div class="category-badge" id="previewCategory"></div>
                    </div>
                    
                    <div class="card-body p-4">
                        <h2 class="card-title mb-3" id="previewStoreName"></h2>
                        
                        <!-- Basic Info -->
                        <div class="info-section">
                            <h5><i class="bi bi-info-circle"></i> åŸºæœ¬æƒ…å ±</h5>
                            <p><i class="bi bi-geo-alt"></i> <span id="previewAddress"></span></p>
                            <p><i class="bi bi-telephone"></i> <span id="previewPhone"></span></p>
                            <p><i class="bi bi-envelope"></i> <span id="previewEmail"></span></p>
                            <div id="previewWebsite"></div>
                        </div>

                        <!-- Business Hours -->
                        <div class="info-section" id="businessHoursSection">
                            <h5><i class="bi bi-clock"></i> å–¶æ¥­æ™‚é–“</h5>
                            <p id="previewBusinessHours"></p>
                            <p id="previewHolidays"></p>
                        </div>

                        <!-- Description -->
                        <div class="info-section" id="descriptionSection">
                            <h5><i class="bi bi-card-text"></i> åº—èˆ—ç´¹ä»‹</h5>
                            <p id="previewDescription"></p>
                        </div>

                        <!-- Languages -->
                        <div class="info-section" id="languagesSection">
                            <h5><i class="bi bi-translate"></i> å¯¾å¿œè¨€èª</h5>
                            <div id="previewLanguages"></div>
                        </div>

                        <!-- TomoTrip Benefits -->
                        <div class="info-section" id="benefitsSection">
                            <h5><i class="bi bi-gift"></i> TomoTripç‰¹å…¸</h5>
                            <div id="previewBenefits"></div>
                        </div>

                        <!-- Contact Actions -->
                        <div class="text-center mt-4">
                            <button class="contact-btn me-3">
                                <i class="bi bi-telephone"></i> é›»è©±ã§å•ã„åˆã‚ã›
                            </button>
                            <button class="contact-btn">
                                <i class="bi bi-envelope"></i> ãƒ¡ãƒ¼ãƒ«ã§å•ã„åˆã‚ã›
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Edit Actions -->
                <div class="text-center mt-4">
                    <button class="btn btn-primary btn-lg me-3" onclick="goBackToEdit()">
                        <i class="bi bi-pencil"></i> ç·¨é›†ã«æˆ»ã‚‹
                    </button>
                    <button class="btn btn-success btn-lg" onclick="publishToList()">
                        <i class="bi bi-check-circle"></i> å…¬é–‹ã™ã‚‹
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰åº—èˆ—IDã‚’å–å¾—
        const urlParams = new URLSearchParams(window.location.search);
        const sponsorId = urlParams.get('id');

        // åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
        function loadPreview() {
            console.log('Loading preview for ID:', sponsorId);
            
            if (!sponsorId) {
                alert('åº—èˆ—IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }

            // LocalStorageã®å†…å®¹ã‚’ãƒ‡ãƒãƒƒã‚°è¡¨ç¤º
            console.log('LocalStorage contents:');
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                console.log(`  ${key}:`, localStorage.getItem(key).substring(0, 100) + '...');
            }

            // ç™»éŒ²æ¸ˆã¿å”è³›åº—ãƒªã‚¹ãƒˆã‹ã‚‰è©²å½“ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const registeredSponsors = JSON.parse(localStorage.getItem('registeredSponsors') || '[]');
            console.log('Registered sponsors:', registeredSponsors);
            console.log('Looking for ID:', sponsorId);
            
            const sponsor = registeredSponsors.find(s => s.id === sponsorId);
            console.log('Found sponsor:', sponsor);
            
            if (!sponsor) {
                // å¤ã„ãƒ‡ãƒ¼ã‚¿å½¢å¼ã‚‚ç¢ºèªï¼ˆä¸‹ä½äº’æ›æ€§ï¼‰
                console.log('Checking legacy format...');
                const sponsorData = localStorage.getItem(sponsorId);
                console.log('Legacy data:', sponsorData);
                
                if (sponsorData) {
                    try {
                        const legacySponsor = JSON.parse(sponsorData);
                        console.log('Using legacy sponsor data:', legacySponsor);
                        displayPreview(legacySponsor);
                        return;
                    } catch (e) {
                        console.error('Failed to parse legacy data:', e);
                    }
                }
                
                console.error('No sponsor data found for ID:', sponsorId);
                alert('å”è³›ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ç·¨é›†ãƒšãƒ¼ã‚¸ã«æˆ»ã£ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            console.log('Preview data loaded successfully:', sponsor);
            displayPreview(sponsor);
        }

        function displayPreview(sponsor) {
            console.log('ğŸ¯ Displaying preview for sponsor:', sponsor);
            
            // æ¥­ç¨®åãƒãƒƒãƒ”ãƒ³ã‚°
            const categoryNames = {
                'restaurant': 'ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ãƒ»é£²é£Ÿåº—',
                'hotel': 'ãƒ›ãƒ†ãƒ«ãƒ»å®¿æ³Šæ–½è¨­',
                'shopping': 'ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ãƒ»å°å£²',
                'entertainment': 'ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ†ã‚¤ãƒ¡ãƒ³ãƒˆ',
                'transport': 'äº¤é€šãƒ»ãƒ¬ãƒ³ã‚¿ãƒ«',
                'service': 'ã‚µãƒ¼ãƒ“ã‚¹æ¥­',
                'other': 'ãã®ä»–'
            };

            // åŸºæœ¬æƒ…å ±è¡¨ç¤ºï¼ˆå¼·åˆ¶çš„ã«è¦ç´ ã‚’ãƒã‚§ãƒƒã‚¯ï¼‰
            const storeName = sponsor.storeName || 'åº—èˆ—åæœªè¨­å®š';
            const category = categoryNames[sponsor.category] || sponsor.category || 'æœªåˆ†é¡';
            const address = sponsor.address || 'ä½æ‰€æœªè¨­å®š';
            const phone = sponsor.phone || 'é›»è©±ç•ªå·æœªè¨­å®š';
            const email = sponsor.email || 'ãƒ¡ãƒ¼ãƒ«æœªè¨­å®š';
            
            console.log('ğŸ“ Setting basic info:');
            console.log('  Store Name:', storeName);
            console.log('  Category:', category);
            console.log('  Address:', address);
            console.log('  Phone:', phone);
            console.log('  Email:', email);
            
            // è¦ç´ ã®å­˜åœ¨ç¢ºèªã¨å¼·åˆ¶è¨­å®š
            const storeNameEl = document.getElementById('previewStoreName');
            const categoryEl = document.getElementById('previewCategory');
            const addressEl = document.getElementById('previewAddress');
            const phoneEl = document.getElementById('previewPhone');
            const emailEl = document.getElementById('previewEmail');
            
            console.log('ğŸ” Element check:');
            console.log('  storeNameEl:', storeNameEl ? 'found' : 'NOT FOUND');
            console.log('  categoryEl:', categoryEl ? 'found' : 'NOT FOUND');
            console.log('  addressEl:', addressEl ? 'found' : 'NOT FOUND');
            console.log('  phoneEl:', phoneEl ? 'found' : 'NOT FOUND');
            console.log('  emailEl:', emailEl ? 'found' : 'NOT FOUND');
            
            if (storeNameEl) {
                storeNameEl.textContent = storeName;
                console.log('âœ… Store name set to:', storeNameEl.textContent);
            }
            if (categoryEl) {
                categoryEl.textContent = category;
                console.log('âœ… Category set to:', categoryEl.textContent);
            }
            if (addressEl) {
                addressEl.textContent = address;
                console.log('âœ… Address set to:', addressEl.textContent);
            }
            if (phoneEl) {
                phoneEl.textContent = phone;
                console.log('âœ… Phone set to:', phoneEl.textContent);
            }
            if (emailEl) {
                emailEl.textContent = email;
                console.log('âœ… Email set to:', emailEl.textContent);
            }

            // ãƒ¡ã‚¤ãƒ³ç”»åƒ
            if (sponsor.mainImage) {
                const img = document.getElementById('previewImage');
                img.src = sponsor.mainImage;
                img.style.display = 'block';
            } else if (sponsor.additionalImages && sponsor.additionalImages.length > 0) {
                // ãƒ¡ã‚¤ãƒ³ç”»åƒãŒãªã„å ´åˆã¯è¿½åŠ ç”»åƒã®æœ€åˆã®ç”»åƒã‚’ä½¿ç”¨
                const img = document.getElementById('previewImage');
                img.src = sponsor.additionalImages[0];
                img.style.display = 'block';
            }

            // ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ
            if (sponsor.website) {
                document.getElementById('previewWebsite').innerHTML = 
                    `<p><i class="bi bi-globe"></i> <a href="${sponsor.website}" target="_blank" class="text-decoration-none">${sponsor.website}</a></p>`;
            }

            // å–¶æ¥­æ™‚é–“ï¼ˆä¿®æ­£ç‰ˆï¼‰
            let businessHoursText = '';
            if (sponsor.openTime && sponsor.openTime.includes('-')) {
                // 15:00-1:00 å½¢å¼ã®å ´åˆ
                businessHoursText = sponsor.openTime;
            } else if (sponsor.openTime || sponsor.closeTime) {
                // åˆ¥ã€…ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆ
                businessHoursText = `${sponsor.openTime || '?'} - ${sponsor.closeTime || '?'}`;
            }
            
            const businessHoursEl = document.getElementById('previewBusinessHours');
            const holidaysEl = document.getElementById('previewHolidays');
            
            console.log('ğŸ• Business hours check:');
            console.log('  businessHoursEl:', businessHoursEl ? 'found' : 'NOT FOUND');
            console.log('  holidaysEl:', holidaysEl ? 'found' : 'NOT FOUND');
            console.log('  businessHoursText:', businessHoursText);
            console.log('  holidays:', sponsor.holidays);
            
            if (businessHoursEl) {
                if (businessHoursText) {
                    businessHoursEl.textContent = businessHoursText;
                    console.log('âœ… Business hours set to:', businessHoursEl.textContent);
                } else {
                    businessHoursEl.textContent = 'å–¶æ¥­æ™‚é–“æœªè¨­å®š';
                    console.log('âš ï¸ Business hours set to default');
                }
            }
            
            if (holidaysEl) {
                if (sponsor.holidays) {
                    holidaysEl.textContent = `å®šä¼‘æ—¥: ${sponsor.holidays}`;
                    console.log('âœ… Holidays set to:', holidaysEl.textContent);
                } else {
                    holidaysEl.textContent = 'å®šä¼‘æ—¥: æœªè¨­å®š';
                    console.log('âš ï¸ Holidays set to default');
                }
            }

            // åº—èˆ—èª¬æ˜
            if (sponsor.detailedDescription) {
                document.getElementById('previewDescription').textContent = sponsor.detailedDescription;
            } else {
                document.getElementById('descriptionSection').style.display = 'none';
            }

            // ç‰¹è‰²ãƒ»å£²ã‚Šã€é›°å›²æ°—ã‚’è¿½åŠ 
            if (sponsor.specialty || sponsor.atmosphere) {
                const specialSection = document.createElement('div');
                specialSection.className = 'info-section';
                specialSection.innerHTML = `
                    <h5><i class="bi bi-star"></i> åº—èˆ—ã®ç‰¹è‰²</h5>
                    ${sponsor.specialty ? `<p><strong>ç‰¹è‰²ãƒ»å£²ã‚Š:</strong> ${sponsor.specialty}</p>` : ''}
                    ${sponsor.atmosphere ? `<p><strong>åº—å†…ã®é›°å›²æ°—:</strong> ${sponsor.atmosphere}</p>` : ''}
                `;
                document.getElementById('descriptionSection').after(specialSection);
            }

            // ä¾¡æ ¼å¸¯ãƒ»åå®¹äººæ•°
            if (sponsor.priceRange || sponsor.capacity) {
                const priceSection = document.createElement('div');
                priceSection.className = 'info-section';
                priceSection.innerHTML = `
                    <h5><i class="bi bi-currency-yen"></i> æ–™é‡‘ãƒ»åå®¹æƒ…å ±</h5>
                    ${sponsor.priceRange ? `<p><strong>ä¾¡æ ¼å¸¯:</strong> ${getPriceRangeText(sponsor.priceRange)}</p>` : ''}
                    ${sponsor.capacity ? `<p><strong>åå®¹äººæ•°:</strong> ${sponsor.capacity}å</p>` : ''}
                `;
                document.getElementById('businessHoursSection').after(priceSection);
            }

            // ã‚¢ã‚¯ã‚»ã‚¹æƒ…å ±
            if (sponsor.accessInfo || sponsor.nearestStation || sponsor.parkingInfo) {
                const accessSection = document.createElement('div');
                accessSection.className = 'info-section';
                accessSection.innerHTML = `
                    <h5><i class="bi bi-geo-alt"></i> ã‚¢ã‚¯ã‚»ã‚¹æƒ…å ±</h5>
                    ${sponsor.accessInfo ? `<p><strong>ã‚¢ã‚¯ã‚»ã‚¹:</strong> ${sponsor.accessInfo}</p>` : ''}
                    ${sponsor.nearestStation ? `<p><strong>æœ€å¯„ã‚Šé§…:</strong> ${sponsor.nearestStation}</p>` : ''}
                    ${sponsor.parkingInfo ? `<p><strong>é§è»Šå ´:</strong> ${sponsor.parkingInfo}</p>` : ''}
                `;
                document.getElementById('businessHoursSection').after(accessSection);
            }

            // æä¾›ã‚µãƒ¼ãƒ“ã‚¹
            if (sponsor.services && sponsor.services.length > 0) {
                const serviceNames = {
                    'wifi': 'Wi-Fiç„¡æ–™',
                    'parking': 'é§è»Šå ´å®Œå‚™', 
                    'card': 'ã‚«ãƒ¼ãƒ‰æ±ºæ¸ˆOK',
                    'barrier-free': 'ãƒãƒªã‚¢ãƒ•ãƒªãƒ¼'
                };
                const servicesSection = document.createElement('div');
                servicesSection.className = 'info-section';
                servicesSection.innerHTML = `
                    <h5><i class="bi bi-check-circle"></i> æä¾›ã‚µãƒ¼ãƒ“ã‚¹</h5>
                    <div>${sponsor.services.map(service => 
                        `<span class="language-tag">${serviceNames[service] || service}</span>`
                    ).join('')}</div>
                `;
                document.getElementById('languagesSection').before(servicesSection);
            }

            // å¯¾å¿œè¨€èª
            if (sponsor.languages && sponsor.languages.length > 0) {
                const languageNames = {
                    'english': 'English',
                    'chinese': 'ä¸­æ–‡',
                    'korean': 'í•œêµ­ì–´'
                };
                document.getElementById('previewLanguages').innerHTML = 
                    sponsor.languages.map(lang => 
                        `<span class="language-tag">${languageNames[lang] || lang}</span>`
                    ).join('');
            } else {
                document.getElementById('languagesSection').style.display = 'none';
            }

            // TomoTripç‰¹å…¸
            if (sponsor.tomotripBenefits || sponsor.detailedDiscount) {
                const benefitText = sponsor.detailedDiscount || sponsor.tomotripBenefits || '';
                document.getElementById('previewBenefits').innerHTML = 
                    benefitText.split(',').map(benefit => 
                        `<span class="benefit-tag">${benefit.trim()}</span>`
                    ).join('');
            } else {
                document.getElementById('benefitsSection').style.display = 'none';
            }

            // è¿½åŠ ç”»åƒã‚®ãƒ£ãƒ©ãƒªãƒ¼ã‚’è¿½åŠ 
            if (sponsor.additionalImages && sponsor.additionalImages.length > 0) {
                const gallerySection = document.createElement('div');
                gallerySection.className = 'info-section';
                gallerySection.innerHTML = `
                    <h5><i class="bi bi-images"></i> åº—èˆ—ã‚®ãƒ£ãƒ©ãƒªãƒ¼</h5>
                    <div class="row">
                        ${sponsor.additionalImages.map(img => 
                            `<div class="col-4 col-md-3 mb-2">
                                <img src="${img}" class="img-fluid rounded" style="height: 120px; object-fit: cover; width: 100%; cursor: pointer;" onclick="openImageModal('${img}')">
                            </div>`
                        ).join('')}
                    </div>
                `;
                document.getElementById('benefitsSection').after(gallerySection);
            }
        }

        function getPriceRangeText(range) {
            const ranges = {
                'budget': 'ãƒªãƒ¼ã‚ºãƒŠãƒ–ãƒ«ï¼ˆã€œ1,000å††ï¼‰',
                'moderate': 'ä¸­ç¨‹åº¦ï¼ˆ1,000å††ã€œ3,000å††ï¼‰',
                'upscale': 'é«˜ç´šï¼ˆ3,000å††ã€œï¼‰'
            };
            return ranges[range] || range;
        }

        function openImageModal(imageSrc) {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body text-center">
                            <img src="${imageSrc}" class="img-fluid">
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            modal.addEventListener('hidden.bs.modal', () => modal.remove());
        }

        function goBackToEdit() {
            if (sponsorId) {
                window.location.href = `sponsor-edit.html?id=${sponsorId}`;
            } else {
                history.back();
            }
        }

        function publishToList() {
            if (confirm('ã“ã®å†…å®¹ã§å”è³›åº—ä¸€è¦§ã«å…¬é–‹ã—ã¾ã™ã‹ï¼Ÿ')) {
                // å…¬é–‹ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
                const sponsorData = localStorage.getItem(sponsorId);
                if (sponsorData) {
                    const sponsor = JSON.parse(sponsorData);
                    sponsor.published = true;
                    sponsor.publishedDate = new Date().toISOString();
                    localStorage.setItem(sponsorId, JSON.stringify(sponsor));
                }
                
                alert('å”è³›åº—ä¸€è¦§ã«å…¬é–‹ã•ã‚Œã¾ã—ãŸï¼');
                window.location.href = 'sponsor-list.html';
            }
        }

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«å®Ÿè¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ” Preview page DOM loaded');
            console.log('ğŸ“ URL:', window.location.href);
            console.log('ğŸ†” Sponsor ID from URL:', sponsorId);
            
            // LocalStorageã®è©³ç´°ãƒ‡ãƒãƒƒã‚°
            console.log('ğŸ’¾ LocalStorage Debug:');
            const registeredSponsors = JSON.parse(localStorage.getItem('registeredSponsors') || '[]');
            console.log('ğŸ“‹ Total registered sponsors:', registeredSponsors.length);
            registeredSponsors.forEach((sponsor, index) => {
                console.log(`   ${index + 1}. ID: ${sponsor.id}, Name: ${sponsor.storeName}, Status: ${sponsor.status}`);
            });
            
            loadPreview();
        });
    </script>
</body>
</html>