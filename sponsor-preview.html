<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>協賛店プレビュー - TomoTrip</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tango, Geneva, Verdana, sans-serif;
        }
        
        .preview-header {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.2);
            padding: 1rem 0;
        }
        
        .preview-card {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
            overflow: hidden;
        }
        
        .store-image {
            width: 100%;
            height: 300px;
            object-fit: cover;
            border-radius: 15px;
        }
        
        .info-section {
            background: rgba(248, 249, 250, 0.8);
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .contact-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            transition: all 0.3s ease;
        }
        
        .contact-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            color: white;
        }
        
        .image-placeholder {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 200px;
        }
    </style>
</head>
<body>
    <div class="preview-header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <h2><i class="bi bi-eye"></i> 協賛店プレビュー</h2>
                <div>
                    <button class="btn btn-outline-secondary me-2" onclick="goBackToEdit()">
                        <i class="bi bi-arrow-left"></i> 戻る
                    </button>
                    <button class="btn btn-outline-primary" onclick="toggleListView()">
                        <i class="bi bi-list"></i> 一覧表示
                    </button>
                </div>
            </div>
            <p class="mb-0 text-muted">お客様が見る店舗情報をプレビューできます</p>
        </div>
    </div>

    <div class="container my-4">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="preview-card p-4">
                    <div class="row">
                        <!-- Store Image -->
                        <div class="col-md-6 mb-3">
                            <img id="previewImage" class="store-image" style="display: none;" alt="店舗画像">
                            <div id="imagePlaceholder" class="image-placeholder">
                                <i class="bi bi-image" style="font-size: 3rem; color: #ccc;"></i>
                                <p class="mt-2 text-muted">画像未設定</p>
                            </div>
                        </div>
                        
                        <!-- Store Info -->
                        <div class="col-md-6">
                            <h3 id="previewStoreName" class="mb-3 text-primary">店舗名</h3>
                            <p><i class="bi bi-tag"></i> <span id="previewCategory">カテゴリ</span></p>
                            <p><i class="bi bi-geo-alt"></i> <span id="previewAddress">住所</span></p>
                            <p><i class="bi bi-telephone"></i> <span id="previewPhone">電話番号</span></p>
                            <p><i class="bi bi-envelope"></i> <span id="previewEmail">メールアドレス</span></p>
                            <div id="previewWebsite"></div>
                        </div>
                    </div>

                    <!-- Business Hours -->
                    <div class="info-section" id="businessHoursSection">
                        <h5><i class="bi bi-clock"></i> 営業時間</h5>
                        <p id="previewBusinessHours">営業時間未設定</p>
                        <p id="previewHolidays">定休日未設定</p>
                    </div>

                    <!-- Description -->
                    <div class="info-section" id="descriptionSection">
                        <h5><i class="bi bi-card-text"></i> 店舗紹介</h5>
                        <p id="previewDescription">店舗説明未設定</p>
                    </div>

                    <!-- Languages -->
                    <div class="info-section" id="languagesSection">
                        <h5><i class="bi bi-translate"></i> 対応言語</h5>
                        <div id="previewLanguages">対応言語未設定</div>
                    </div>

                    <!-- TomoTrip Benefits -->
                    <div class="info-section" id="benefitsSection">
                        <h5><i class="bi bi-gift"></i> TomoTrip特典</h5>
                        <div id="previewBenefits">特典未設定</div>
                    </div>

                    <!-- Contact Actions -->
                    <div class="text-center mt-4">
                        <button class="contact-btn me-3">
                            <i class="bi bi-telephone"></i> 電話で問い合わせ
                        </button>
                        <button class="contact-btn">
                            <i class="bi bi-envelope"></i> メールで問い合わせ
                        </button>
                    </div>
                </div>

                <!-- Edit Actions -->
                <div class="text-center mt-4">
                    <button class="btn btn-primary btn-lg me-3" onclick="goBackToEdit()">
                        <i class="bi bi-pencil"></i> 編集に戻る
                    </button>
                    <button class="btn btn-success btn-lg" onclick="publishToList()">
                        <i class="bi bi-check-circle"></i> 公開する
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // URLパラメータから店舗IDを取得
        const urlParams = new URLSearchParams(window.location.search);
        const sponsorId = urlParams.get('id');
        
        console.log('🔗 Preview page initialized');
        console.log('📍 Current URL:', window.location.href);
        console.log('🆔 Sponsor ID from URL:', sponsorId);

        // 店舗データを読み込んでプレビュー表示（強化版）
        function loadPreview() {
            console.log('🔍 Loading preview for ID:', sponsorId);
            
            if (!sponsorId) {
                showError('店舗IDが指定されていません');
                return;
            }

            // デバッグ：全てのストレージキーと内容を出力
            console.log('📊 ALL LOCALSTORAGE DEBUGGING:');
            const allKeys = Object.keys(localStorage);
            allKeys.forEach(key => {
                const value = localStorage.getItem(key);
                console.log(`🔑 Key: ${key} | Length: ${value ? value.length : 0}`);
                if (key.includes('sponsor') || key.includes('test')) {
                    try {
                        const parsed = JSON.parse(value);
                        if (Array.isArray(parsed)) {
                            console.log(`  📋 Array with ${parsed.length} items:`, parsed.map(item => item?.id || 'no-id'));
                        } else {
                            console.log(`  📄 Object ID: ${parsed?.id || 'no-id'}`);
                        }
                    } catch (e) {
                        console.log(`  ❌ Not JSON: ${value?.substring(0, 50)}...`);
                    }
                }
            });

            // データを取得（複数の場所から試行）
            let sponsor = null;
            
            // 1. プレビュー用データを確認
            console.log('🔍 Step 1: Checking preview data...');
            const previewKey = `preview_${sponsorId}`;
            console.log(`  Looking for key: ${previewKey}`);
            const previewData = localStorage.getItem(previewKey);
            if (previewData) {
                try {
                    sponsor = JSON.parse(previewData);
                    console.log('✅ Step 1 SUCCESS: Found preview data:', sponsor);
                } catch (e) {
                    console.error('❌ Step 1 FAILED: Parse error:', e);
                }
            } else {
                console.log('❌ Step 1 FAILED: No preview data found');
            }
            
            // 2. 直接IDキーでの取得
            if (!sponsor) {
                console.log('🔍 Step 2: Checking direct ID...');
                console.log(`  Looking for key: ${sponsorId}`);
                const directData = localStorage.getItem(sponsorId);
                if (directData) {
                    try {
                        sponsor = JSON.parse(directData);
                        console.log('✅ Step 2 SUCCESS: Found direct ID data:', sponsor);
                    } catch (e) {
                        console.error('❌ Step 2 FAILED: Parse error:', e);
                    }
                } else {
                    console.log('❌ Step 2 FAILED: No direct data found');
                }
            }
            
            // 3. registeredSponsorsから取得
            if (!sponsor) {
                const registeredSponsors = JSON.parse(localStorage.getItem('registeredSponsors') || '[]');
                sponsor = registeredSponsors.find(s => s.id === sponsorId);
                if (sponsor) {
                    console.log('✅ Found in registered sponsors:', sponsor);
                }
            }
            
            // 3.5. 各種セッションストレージからも検索
            if (!sponsor) {
                const sessionKeys = ['sponsorSession', 'sponsorAccounts', 'sponsorData', 'sponsor_1'];
                for (const key of sessionKeys) {
                    try {
                        const sessionData = localStorage.getItem(key);
                        if (sessionData) {
                            const parsed = JSON.parse(sessionData);
                            if (Array.isArray(parsed)) {
                                sponsor = parsed.find(s => s && s.id === sponsorId);
                            } else if (parsed && parsed.id === sponsorId) {
                                sponsor = parsed;
                            }
                            if (sponsor) {
                                console.log(`✅ Found in session storage ${key}:`, sponsor);
                                break;
                            }
                        }
                    } catch (e) {
                        console.error(`Failed to parse ${key}:`, e);
                    }
                }
            }
            
            // 4. 個別保存データを確認
            if (!sponsor) {
                const storeKey = `store_${sponsorId}`;
                const storeData = localStorage.getItem(storeKey);
                if (storeData) {
                    try {
                        sponsor = JSON.parse(storeData);
                        console.log('✅ Found in store data:', sponsor);
                    } catch (e) {
                        console.error('Failed to parse store data:', e);
                    }
                }
            }
            
            // 5. 最後の手段：全てのキーをスキャン
            if (!sponsor) {
                console.log('🔍 Scanning all localStorage keys...');
                const allKeys = Object.keys(localStorage);
                console.log('All available keys:', allKeys);
                
                // まず部分一致で検索
                for (const key of allKeys) {
                    if (key.includes(sponsorId) || sponsorId.includes(key) || 
                        key.includes('sponsor') || key.includes('test')) {
                        try {
                            const data = JSON.parse(localStorage.getItem(key));
                            if (data) {
                                // 単一オブジェクトの場合
                                if (data.id === sponsorId) {
                                    sponsor = data;
                                    console.log('✅ Found via key scan (direct):', key, sponsor);
                                    break;
                                }
                                // 配列の場合
                                if (Array.isArray(data)) {
                                    const found = data.find(item => item && item.id === sponsorId);
                                    if (found) {
                                        sponsor = found;
                                        console.log('✅ Found via key scan (array):', key, sponsor);
                                        break;
                                    }
                                }
                            }
                        } catch (e) {
                            console.error('Failed to parse scanned data:', key, e);
                        }
                    }
                }
                
                // さらに見つからない場合、全てのデータを確認
                if (!sponsor) {
                    for (const key of allKeys) {
                        try {
                            const data = localStorage.getItem(key);
                            if (data && data.includes(sponsorId)) {
                                const parsedData = JSON.parse(data);
                                if (parsedData.id === sponsorId || 
                                    (Array.isArray(parsedData) && parsedData.find(item => item.id === sponsorId))) {
                                    sponsor = Array.isArray(parsedData) ? 
                                        parsedData.find(item => item.id === sponsorId) : parsedData;
                                    console.log('✅ Found via deep scan:', key, sponsor);
                                    break;
                                }
                            }
                        } catch (e) {
                            // JSON以外のデータは無視
                        }
                    }
                }
            }
            
            if (!sponsor) {
                console.error('❌ No data found for ID:', sponsorId);
                
                // デバッグ情報を詳細に表示
                console.log('Debug info for missing data:');
                console.log('- Searched ID:', sponsorId);
                console.log('- Available localStorage keys:', Object.keys(localStorage));
                console.log('- registeredSponsors content:', localStorage.getItem('registeredSponsors'));
                
                // 緊急対策：類似IDでの検索
                const allKeys = Object.keys(localStorage);
                const possibleKeys = allKeys.filter(key => 
                    key.includes('sponsor') || 
                    key.includes('kyoto') || 
                    key.includes('test') ||
                    key.includes(sponsorId.split('_').pop())
                );
                
                if (possibleKeys.length > 0) {
                    console.log('Possible matching keys found:', possibleKeys);
                    showError(`店舗ID: ${sponsorId} のデータが見つかりません。\n\n利用可能なデータ: ${possibleKeys.join(', ')}\n\nテストページに戻ってデータを確認してください。`);
                } else {
                    showError(`店舗ID: ${sponsorId} のデータが見つかりません。\n\nテストページでデータを作成してからプレビューしてください。`);
                }
                return;
            }

            console.log('Preview data loaded successfully:', sponsor);
            displayPreview(sponsor);
        }

        function displayPreview(sponsor) {
            console.log('🎯 Displaying preview for sponsor:', sponsor);
            
            // 業種名マッピング
            const categoryNames = {
                'restaurant': 'レストラン・飲食店',
                'hotel': 'ホテル・宿泊施設',
                'shopping': 'ショッピング・小売',
                'entertainment': 'エンターテイメント',
                'transport': '交通・レンタル',
                'service': 'サービス業',
                'other': 'その他'
            };

            // 基本情報表示
            const storeName = sponsor.storeName || '店舗名未設定';
            const category = categoryNames[sponsor.category] || sponsor.category || '未分類';
            const address = sponsor.address || '住所未設定';
            const phone = sponsor.phone || '電話番号未設定';
            const email = sponsor.email || 'メール未設定';
            
            // 要素に値を設定
            document.getElementById('previewStoreName').textContent = storeName;
            document.getElementById('previewCategory').textContent = category;
            document.getElementById('previewAddress').textContent = address;
            document.getElementById('previewPhone').textContent = phone;
            document.getElementById('previewEmail').textContent = email;

            // 画像表示（エラーハンドリング強化）
            const imageElement = document.getElementById('previewImage');
            const placeholder = document.getElementById('imagePlaceholder');
            
            if (sponsor.mainImage && sponsor.mainImage.trim() !== '') {
                try {
                    imageElement.src = sponsor.mainImage;
                    imageElement.onerror = function() {
                        console.log('⚠️ 画像読み込みエラー');
                        imageElement.style.display = 'none';
                        placeholder.style.display = 'flex';
                    };
                    imageElement.onload = function() {
                        imageElement.style.display = 'block';
                        placeholder.style.display = 'none';
                    };
                } catch (error) {
                    console.error('画像処理エラー:', error);
                    imageElement.style.display = 'none';
                    placeholder.style.display = 'flex';
                }
            } else {
                imageElement.style.display = 'none';
                placeholder.style.display = 'flex';
            }

            // ウェブサイト
            if (sponsor.website && sponsor.website.trim() !== '') {
                document.getElementById('previewWebsite').innerHTML = 
                    `<p><i class="bi bi-globe"></i> <a href="${sponsor.website}" target="_blank" class="text-decoration-none">${sponsor.website}</a></p>`;
            }

            // 営業時間
            const businessHours = sponsor.openTime || '営業時間未設定';
            const holidays = sponsor.holidays || '定休日未設定';
            
            document.getElementById('previewBusinessHours').textContent = businessHours;
            document.getElementById('previewHolidays').textContent = `定休日: ${holidays}`;

            // 店舗説明
            if (sponsor.detailedDescription && sponsor.detailedDescription.trim() !== '') {
                document.getElementById('previewDescription').textContent = sponsor.detailedDescription;
            } else {
                document.getElementById('descriptionSection').style.display = 'none';
            }

            // 対応言語
            if (sponsor.languages && sponsor.languages.length > 0) {
                const languageText = sponsor.languages.join(', ');
                document.getElementById('previewLanguages').textContent = languageText;
            } else {
                document.getElementById('languagesSection').style.display = 'none';
            }

            // TomoTrip特典
            if (sponsor.detailedDiscount && sponsor.detailedDiscount.trim() !== '') {
                document.getElementById('previewBenefits').textContent = sponsor.detailedDiscount;
            } else {
                document.getElementById('benefitsSection').style.display = 'none';
            }
        }

        function showError(message) {
            document.body.innerHTML = `
                <div class="container mt-5">
                    <div class="alert alert-warning text-center">
                        <h4><i class="bi bi-exclamation-triangle"></i> エラー</h4>
                        <p>${message}</p>
                        <p>編集ページに戻ってデータを保存してからプレビューしてください。</p>
                        <button class="btn btn-primary" onclick="goBackToEdit()">
                            <i class="bi bi-arrow-left"></i> 編集ページに戻る
                        </button>
                    </div>
                </div>
            `;
        }

        function goBackToEdit() {
            if (window.opener && !window.opener.closed) {
                window.close();
                window.opener.focus();
            } else {
                window.location.href = `sponsor-edit.html?id=${sponsorId}`;
            }
        }

        function toggleListView() {
            const btn = event.target;
            btn.innerHTML = '<i class="bi bi-list"></i> 表示切替中...';
            btn.disabled = true;
            
            setTimeout(() => {
                btn.innerHTML = '<i class="bi bi-list"></i> 一覧表示';
                btn.disabled = false;
            }, 1000);
        }

        function publishToList() {
            if (confirm('この内容で協賛店一覧に公開しますか？')) {
                try {
                    // 公開処理
                    const sponsor = JSON.parse(localStorage.getItem(`preview_${sponsorId}`) || '{}');
                    sponsor.published = true;
                    sponsor.publishedDate = new Date().toISOString();
                    
                    // 複数の場所に保存
                    localStorage.setItem(`store_${sponsorId}`, JSON.stringify(sponsor));
                    
                    const registeredSponsors = JSON.parse(localStorage.getItem('registeredSponsors') || '[]');
                    const index = registeredSponsors.findIndex(s => s.id === sponsorId);
                    if (index !== -1) {
                        registeredSponsors[index] = sponsor;
                    } else {
                        registeredSponsors.push(sponsor);
                    }
                    localStorage.setItem('registeredSponsors', JSON.stringify(registeredSponsors));
                    
                    alert('協賛店一覧に公開されました！');
                    window.location.href = 'sponsor-list.html';
                } catch (error) {
                    console.error('公開エラー:', error);
                    alert('公開中にエラーが発生しました。');
                }
            }
        }

        // ページロード時に実行
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🔍 Preview page DOM loaded');
            loadPreview();
        });
    </script>
</body>
</html>