<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>協賛店プレビュー - TomoTrip</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 3rem 0;
        }
        .preview-card {
            border: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 2rem;
        }
        .store-image {
            width: 100%;
            height: 300px;
            object-fit: cover;
        }
        .category-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255,255,255,0.9);
            color: #333;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .benefit-tag {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            margin: 0.2rem;
            display: inline-block;
        }
        .language-tag {
            background: #3742fa;
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 10px;
            font-size: 0.75rem;
            margin: 0.1rem;
        }
        .info-section {
            background: #f8f9ff;
            padding: 1.5rem;
            border-radius: 10px;
            margin: 1rem 0;
        }
        .contact-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            padding: 0.8rem 2rem;
            border-radius: 25px;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .contact-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            color: white;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="gradient-bg">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="bi bi-eye"></i> 協賛店プレビュー</h1>
                    <p class="lead mb-0">お客様から見える店舗情報をプレビューできます</p>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-light me-2" onclick="goBackToEdit()">
                        <i class="bi bi-arrow-left"></i> 戻る
                    </button>
                    <a href="sponsor-list.html" class="btn btn-outline-light">
                        <i class="bi bi-list"></i> 一覧表示
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container my-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <!-- Preview Card -->
                <div class="card preview-card" id="previewCard">
                    <div class="position-relative">
                        <img id="previewImage" src="" alt="店舗画像" class="store-image" style="display: none;">
                        <div class="category-badge" id="previewCategory"></div>
                    </div>
                    
                    <div class="card-body p-4">
                        <h2 class="card-title mb-3" id="previewStoreName"></h2>
                        
                        <!-- Basic Info -->
                        <div class="info-section">
                            <h5><i class="bi bi-info-circle"></i> 基本情報</h5>
                            <p><i class="bi bi-geo-alt"></i> <span id="previewAddress"></span></p>
                            <p><i class="bi bi-telephone"></i> <span id="previewPhone"></span></p>
                            <p><i class="bi bi-envelope"></i> <span id="previewEmail"></span></p>
                            <div id="previewWebsite"></div>
                        </div>

                        <!-- Business Hours -->
                        <div class="info-section" id="businessHoursSection">
                            <h5><i class="bi bi-clock"></i> 営業時間</h5>
                            <p id="previewBusinessHours"></p>
                            <p id="previewHolidays"></p>
                        </div>

                        <!-- Description -->
                        <div class="info-section" id="descriptionSection">
                            <h5><i class="bi bi-card-text"></i> 店舗紹介</h5>
                            <p id="previewDescription"></p>
                        </div>

                        <!-- Languages -->
                        <div class="info-section" id="languagesSection">
                            <h5><i class="bi bi-translate"></i> 対応言語</h5>
                            <div id="previewLanguages"></div>
                        </div>

                        <!-- TomoTrip Benefits -->
                        <div class="info-section" id="benefitsSection">
                            <h5><i class="bi bi-gift"></i> TomoTrip特典</h5>
                            <div id="previewBenefits"></div>
                        </div>

                        <!-- Contact Actions -->
                        <div class="text-center mt-4">
                            <button class="contact-btn me-3">
                                <i class="bi bi-telephone"></i> 電話で問い合わせ
                            </button>
                            <button class="contact-btn">
                                <i class="bi bi-envelope"></i> メールで問い合わせ
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Edit Actions -->
                <div class="text-center mt-4">
                    <button class="btn btn-primary btn-lg me-3" onclick="goBackToEdit()">
                        <i class="bi bi-pencil"></i> 編集に戻る
                    </button>
                    <button class="btn btn-success btn-lg" onclick="publishToList()">
                        <i class="bi bi-check-circle"></i> 公開する
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // URLパラメータから店舗IDを取得
        const urlParams = new URLSearchParams(window.location.search);
        const sponsorId = urlParams.get('id');

        // 店舗データを読み込んでプレビュー表示
        function loadPreview() {
            console.log('Loading preview for ID:', sponsorId);
            
            if (!sponsorId) {
                alert('店舗IDが指定されていません');
                return;
            }

            // LocalStorageの内容をデバッグ表示
            console.log('LocalStorage contents:');
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                console.log(`  ${key}:`, localStorage.getItem(key).substring(0, 100) + '...');
            }

            // 登録済み協賛店リストから該当データを取得
            const registeredSponsors = JSON.parse(localStorage.getItem('registeredSponsors') || '[]');
            console.log('Registered sponsors:', registeredSponsors);
            console.log('Looking for ID:', sponsorId);
            
            const sponsor = registeredSponsors.find(s => s.id === sponsorId);
            console.log('Found sponsor:', sponsor);
            
            if (!sponsor) {
                // 古いデータ形式も確認（下位互換性）
                console.log('Checking legacy format...');
                const sponsorData = localStorage.getItem(sponsorId);
                console.log('Legacy data:', sponsorData);
                
                if (sponsorData) {
                    try {
                        const legacySponsor = JSON.parse(sponsorData);
                        console.log('Using legacy sponsor data:', legacySponsor);
                        displayPreview(legacySponsor);
                        return;
                    } catch (e) {
                        console.error('Failed to parse legacy data:', e);
                    }
                }
                
                console.error('No sponsor data found for ID:', sponsorId);
                alert('協賛データが見つかりません。編集ページに戻って保存してください。');
                return;
            }

            console.log('Preview data loaded successfully:', sponsor);
            displayPreview(sponsor);
        }

        function displayPreview(sponsor) {
            console.log('🎯 Displaying preview for sponsor:', sponsor);
            
            // 業種名マッピング
            const categoryNames = {
                'restaurant': 'レストラン・飲食店',
                'hotel': 'ホテル・宿泊施設',
                'shopping': 'ショッピング・小売',
                'entertainment': 'エンターテイメント',
                'transport': '交通・レンタル',
                'service': 'サービス業',
                'other': 'その他'
            };

            // 基本情報表示（強制的に要素をチェック）
            const storeName = sponsor.storeName || '店舗名未設定';
            const category = categoryNames[sponsor.category] || sponsor.category || '未分類';
            const address = sponsor.address || '住所未設定';
            const phone = sponsor.phone || '電話番号未設定';
            const email = sponsor.email || 'メール未設定';
            
            console.log('📝 Setting basic info:');
            console.log('  Store Name:', storeName);
            console.log('  Category:', category);
            console.log('  Address:', address);
            console.log('  Phone:', phone);
            console.log('  Email:', email);
            
            // 要素の存在確認と強制設定
            const storeNameEl = document.getElementById('previewStoreName');
            const categoryEl = document.getElementById('previewCategory');
            const addressEl = document.getElementById('previewAddress');
            const phoneEl = document.getElementById('previewPhone');
            const emailEl = document.getElementById('previewEmail');
            
            console.log('🔍 Element check:');
            console.log('  storeNameEl:', storeNameEl ? 'found' : 'NOT FOUND');
            console.log('  categoryEl:', categoryEl ? 'found' : 'NOT FOUND');
            console.log('  addressEl:', addressEl ? 'found' : 'NOT FOUND');
            console.log('  phoneEl:', phoneEl ? 'found' : 'NOT FOUND');
            console.log('  emailEl:', emailEl ? 'found' : 'NOT FOUND');
            
            if (storeNameEl) {
                storeNameEl.textContent = storeName;
                console.log('✅ Store name set to:', storeNameEl.textContent);
            }
            if (categoryEl) {
                categoryEl.textContent = category;
                console.log('✅ Category set to:', categoryEl.textContent);
            }
            if (addressEl) {
                addressEl.textContent = address;
                console.log('✅ Address set to:', addressEl.textContent);
            }
            if (phoneEl) {
                phoneEl.textContent = phone;
                console.log('✅ Phone set to:', phoneEl.textContent);
            }
            if (emailEl) {
                emailEl.textContent = email;
                console.log('✅ Email set to:', emailEl.textContent);
            }

            // メイン画像
            if (sponsor.mainImage) {
                const img = document.getElementById('previewImage');
                img.src = sponsor.mainImage;
                img.style.display = 'block';
            } else if (sponsor.additionalImages && sponsor.additionalImages.length > 0) {
                // メイン画像がない場合は追加画像の最初の画像を使用
                const img = document.getElementById('previewImage');
                img.src = sponsor.additionalImages[0];
                img.style.display = 'block';
            }

            // ウェブサイト
            if (sponsor.website) {
                document.getElementById('previewWebsite').innerHTML = 
                    `<p><i class="bi bi-globe"></i> <a href="${sponsor.website}" target="_blank" class="text-decoration-none">${sponsor.website}</a></p>`;
            }

            // 営業時間（修正版）
            let businessHoursText = '';
            if (sponsor.openTime && sponsor.openTime.includes('-')) {
                // 15:00-1:00 形式の場合
                businessHoursText = sponsor.openTime;
            } else if (sponsor.openTime || sponsor.closeTime) {
                // 別々に設定されている場合
                businessHoursText = `${sponsor.openTime || '?'} - ${sponsor.closeTime || '?'}`;
            }
            
            const businessHoursEl = document.getElementById('previewBusinessHours');
            const holidaysEl = document.getElementById('previewHolidays');
            
            console.log('🕐 Business hours check:');
            console.log('  businessHoursEl:', businessHoursEl ? 'found' : 'NOT FOUND');
            console.log('  holidaysEl:', holidaysEl ? 'found' : 'NOT FOUND');
            console.log('  businessHoursText:', businessHoursText);
            console.log('  holidays:', sponsor.holidays);
            
            if (businessHoursEl) {
                if (businessHoursText) {
                    businessHoursEl.textContent = businessHoursText;
                    console.log('✅ Business hours set to:', businessHoursEl.textContent);
                } else {
                    businessHoursEl.textContent = '営業時間未設定';
                    console.log('⚠️ Business hours set to default');
                }
            }
            
            if (holidaysEl) {
                if (sponsor.holidays) {
                    holidaysEl.textContent = `定休日: ${sponsor.holidays}`;
                    console.log('✅ Holidays set to:', holidaysEl.textContent);
                } else {
                    holidaysEl.textContent = '定休日: 未設定';
                    console.log('⚠️ Holidays set to default');
                }
            }

            // 店舗説明
            if (sponsor.detailedDescription) {
                document.getElementById('previewDescription').textContent = sponsor.detailedDescription;
            } else {
                document.getElementById('descriptionSection').style.display = 'none';
            }

            // 特色・売り、雰囲気を追加
            if (sponsor.specialty || sponsor.atmosphere) {
                const specialSection = document.createElement('div');
                specialSection.className = 'info-section';
                specialSection.innerHTML = `
                    <h5><i class="bi bi-star"></i> 店舗の特色</h5>
                    ${sponsor.specialty ? `<p><strong>特色・売り:</strong> ${sponsor.specialty}</p>` : ''}
                    ${sponsor.atmosphere ? `<p><strong>店内の雰囲気:</strong> ${sponsor.atmosphere}</p>` : ''}
                `;
                document.getElementById('descriptionSection').after(specialSection);
            }

            // 価格帯・収容人数
            if (sponsor.priceRange || sponsor.capacity) {
                const priceSection = document.createElement('div');
                priceSection.className = 'info-section';
                priceSection.innerHTML = `
                    <h5><i class="bi bi-currency-yen"></i> 料金・収容情報</h5>
                    ${sponsor.priceRange ? `<p><strong>価格帯:</strong> ${getPriceRangeText(sponsor.priceRange)}</p>` : ''}
                    ${sponsor.capacity ? `<p><strong>収容人数:</strong> ${sponsor.capacity}名</p>` : ''}
                `;
                document.getElementById('businessHoursSection').after(priceSection);
            }

            // アクセス情報
            if (sponsor.accessInfo || sponsor.nearestStation || sponsor.parkingInfo) {
                const accessSection = document.createElement('div');
                accessSection.className = 'info-section';
                accessSection.innerHTML = `
                    <h5><i class="bi bi-geo-alt"></i> アクセス情報</h5>
                    ${sponsor.accessInfo ? `<p><strong>アクセス:</strong> ${sponsor.accessInfo}</p>` : ''}
                    ${sponsor.nearestStation ? `<p><strong>最寄り駅:</strong> ${sponsor.nearestStation}</p>` : ''}
                    ${sponsor.parkingInfo ? `<p><strong>駐車場:</strong> ${sponsor.parkingInfo}</p>` : ''}
                `;
                document.getElementById('businessHoursSection').after(accessSection);
            }

            // 提供サービス
            if (sponsor.services && sponsor.services.length > 0) {
                const serviceNames = {
                    'wifi': 'Wi-Fi無料',
                    'parking': '駐車場完備', 
                    'card': 'カード決済OK',
                    'barrier-free': 'バリアフリー'
                };
                const servicesSection = document.createElement('div');
                servicesSection.className = 'info-section';
                servicesSection.innerHTML = `
                    <h5><i class="bi bi-check-circle"></i> 提供サービス</h5>
                    <div>${sponsor.services.map(service => 
                        `<span class="language-tag">${serviceNames[service] || service}</span>`
                    ).join('')}</div>
                `;
                document.getElementById('languagesSection').before(servicesSection);
            }

            // 対応言語
            if (sponsor.languages && sponsor.languages.length > 0) {
                const languageNames = {
                    'english': 'English',
                    'chinese': '中文',
                    'korean': '한국어'
                };
                document.getElementById('previewLanguages').innerHTML = 
                    sponsor.languages.map(lang => 
                        `<span class="language-tag">${languageNames[lang] || lang}</span>`
                    ).join('');
            } else {
                document.getElementById('languagesSection').style.display = 'none';
            }

            // TomoTrip特典
            if (sponsor.tomotripBenefits || sponsor.detailedDiscount) {
                const benefitText = sponsor.detailedDiscount || sponsor.tomotripBenefits || '';
                document.getElementById('previewBenefits').innerHTML = 
                    benefitText.split(',').map(benefit => 
                        `<span class="benefit-tag">${benefit.trim()}</span>`
                    ).join('');
            } else {
                document.getElementById('benefitsSection').style.display = 'none';
            }

            // 追加画像ギャラリーを追加
            if (sponsor.additionalImages && sponsor.additionalImages.length > 0) {
                const gallerySection = document.createElement('div');
                gallerySection.className = 'info-section';
                gallerySection.innerHTML = `
                    <h5><i class="bi bi-images"></i> 店舗ギャラリー</h5>
                    <div class="row">
                        ${sponsor.additionalImages.map(img => 
                            `<div class="col-4 col-md-3 mb-2">
                                <img src="${img}" class="img-fluid rounded" style="height: 120px; object-fit: cover; width: 100%; cursor: pointer;" onclick="openImageModal('${img}')">
                            </div>`
                        ).join('')}
                    </div>
                `;
                document.getElementById('benefitsSection').after(gallerySection);
            }
        }

        function getPriceRangeText(range) {
            const ranges = {
                'budget': 'リーズナブル（〜1,000円）',
                'moderate': '中程度（1,000円〜3,000円）',
                'upscale': '高級（3,000円〜）'
            };
            return ranges[range] || range;
        }

        function openImageModal(imageSrc) {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">画像プレビュー</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body text-center">
                            <img src="${imageSrc}" class="img-fluid">
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            modal.addEventListener('hidden.bs.modal', () => modal.remove());
        }

        function goBackToEdit() {
            if (sponsorId) {
                window.location.href = `sponsor-edit.html?id=${sponsorId}`;
            } else {
                history.back();
            }
        }

        function publishToList() {
            if (confirm('この内容で協賛店一覧に公開しますか？')) {
                // 公開フラグを設定
                const sponsorData = localStorage.getItem(sponsorId);
                if (sponsorData) {
                    const sponsor = JSON.parse(sponsorData);
                    sponsor.published = true;
                    sponsor.publishedDate = new Date().toISOString();
                    localStorage.setItem(sponsorId, JSON.stringify(sponsor));
                }
                
                alert('協賛店一覧に公開されました！');
                window.location.href = 'sponsor-list.html';
            }
        }

        // ページロード時に実行
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🔍 Preview page DOM loaded');
            console.log('📍 URL:', window.location.href);
            console.log('🆔 Sponsor ID from URL:', sponsorId);
            
            // LocalStorageの詳細デバッグ
            console.log('💾 LocalStorage Debug:');
            const registeredSponsors = JSON.parse(localStorage.getItem('registeredSponsors') || '[]');
            console.log('📋 Total registered sponsors:', registeredSponsors.length);
            registeredSponsors.forEach((sponsor, index) => {
                console.log(`   ${index + 1}. ID: ${sponsor.id}, Name: ${sponsor.storeName}, Status: ${sponsor.status}`);
            });
            
            loadPreview();
        });
    </script>
</body>
</html>