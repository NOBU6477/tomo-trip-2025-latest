<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ガイド詳細 - TomoTrip</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
  
  <!-- 強化された認証システム -->
  <style>
    /* 認証されるまでページ全体を非表示 */
    body { display: none !important; }
    .auth-loading {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: #667eea;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-family: sans-serif;
      z-index: 9999;
    }
  </style>
  
  <!-- 認証チェック画面 -->
  <div id="authCheck" class="auth-loading">
    <div class="text-center">
      <div class="spinner-border text-light mb-3"></div>
      <p>認証確認中...</p>
    </div>
  </div>

  <script>
    // シンプルな認証チェック
    (function() {
      'use strict';
      
      const touristData = localStorage.getItem('touristData');
      
      if (!touristData) {
        // 未認証の場合は認証要求ページを表示
        const urlParams = new URLSearchParams(window.location.search);
        const guideId = urlParams.get('id');
        
        document.write(`
          <!DOCTYPE html>
          <html lang="ja">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ログインが必要です - TomoTrip</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
            <style>
              body {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
                font-family: 'Noto Sans JP', sans-serif;
              }
              .auth-container {
                background: white;
                border-radius: 20px;
                padding: 40px;
                text-align: center;
                box-shadow: 0 20px 60px rgba(0,0,0,0.2);
                max-width: 500px;
                margin: 20px;
              }
              .auth-icon {
                font-size: 4rem;
                color: #667eea;
                margin-bottom: 20px;
              }
              .btn-custom {
                border-radius: 25px;
                padding: 12px 30px;
                font-weight: 600;
                margin: 10px;
              }
            </style>
          </head>
          <body>
            <div class="auth-container">
              <div class="auth-icon">
                <i class="bi bi-shield-lock"></i>
              </div>
              <h2 class="mb-3">ログインが必要です</h2>
              <p class="text-muted mb-4">
                ガイドの詳細情報をご覧いただくには、<br>
                観光客としてログインしてください。
              </p>
              <div class="alert alert-info">
                <strong>安全なサービスのために</strong><br>
                身元確認済みのユーザーのみが<br>
                ガイド詳細を閲覧できます
              </div>
              <div class="mt-4">
                <a href="index.html" class="btn btn-primary btn-custom">
                  <i class="bi bi-house-door me-2"></i>ホームページに戻る
                </a>
              </div>
              <div class="mt-2">
                <small class="text-muted">
                  ホームページからログインまたは新規登録してください
                </small>
              </div>
            </div>
          </body>
          </html>
        `);
        return;
      }
      
      // 認証済みの場合はページを通常表示
      document.addEventListener('DOMContentLoaded', function() {
        const authCheck = document.getElementById('authCheck');
        if (authCheck) {
          authCheck.style.display = 'none';
        }
        document.body.style.display = 'block';
      });
      
    })();
  </script>

  <style>
    body {
      font-family: 'Noto Sans JP', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    .navbar {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .guide-hero {
      background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)), url('attached_assets/image_1750354393748.png');
      background-size: cover;
      background-position: center;
      height: 400px;
      position: relative;
      color: white;
    }
    
    .guide-details-card {
      margin-top: -100px;
      z-index: 10;
      position: relative;
    }
    
    .guide-avatar {
      width: 150px;
      height: 150px;
      border: 5px solid white;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .language-badge {
      margin-right: 0.5rem;
      margin-bottom: 0.5rem;
    }
    
    .booking-card {
      position: sticky;
      top: 20px;
    }
    
    .review-card {
      border-left: 4px solid #007bff;
    }
    
    .back-btn {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(255,255,255,0.9);
      border: none;
      color: #333;
    }
    
    .back-btn:hover {
      background: white;
      color: #007bff;
    }
  </style>
</head>

<body>

  <!-- ナビゲーション -->
  <nav class="navbar navbar-expand-lg navbar-light fixed-top">
    <div class="container">
      <a class="navbar-brand fw-bold text-primary" href="index.html">
        <img src="attached_assets/image_1750354393748.png" alt="TomoTrip" height="40" class="me-2">
        TomoTrip
      </a>
      
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a class="nav-link" href="index.html">ホーム</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="guides.html">ガイドを探す</a>
          </li>
        </ul>
        
        <ul class="navbar-nav">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="languageDropdown" role="button" data-bs-toggle="dropdown">
              日本語
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#" data-lang="ja">日本語</a></li>
              <li><a class="dropdown-item" href="#" data-lang="en">English</a></li>
            </ul>
          </li>
          <li class="nav-item">
            <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#loginModal">ログイン</button>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- ヒーローセクション -->
  <section class="guide-hero d-flex align-items-end">
    <button class="btn back-btn" onclick="history.back()">
      <i class="bi bi-arrow-left me-2"></i>戻る
    </button>
    <div class="container">
      <div class="row">
        <div class="col-12">
          <div class="d-flex align-items-end pb-4">
            <img id="guide-avatar" src="attached_assets/image_1750354393748.png" alt="ガイド写真" class="guide-avatar rounded-circle me-4">
            <div>
              <h1 id="guide-name" class="mb-2">ガイド名</h1>
              <p id="guide-location" class="mb-1"><i class="bi bi-geo-alt-fill me-2"></i>所在地</p>
              <div class="d-flex align-items-center">
                <div id="guide-rating" class="text-warning me-3">
                  <i class="bi bi-star-fill"></i>
                  <span id="rating-value">0.0</span>
                </div>
                <span id="guide-price" class="badge bg-primary fs-6">¥0/セッション</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- メインコンテンツ -->
  <div class="container">
    <div class="row">
      <!-- ガイド詳細情報 -->
      <div class="col-lg-8">
        <div class="card guide-details-card shadow-lg">
          <div class="card-body p-4">
            <!-- 概要 -->
            <section class="mb-5">
              <h3 class="mb-3">プロフィール</h3>
              <p id="guide-description" class="text-muted">ガイドの詳細説明がここに表示されます。</p>
            </section>

            <!-- 対応言語 -->
            <section class="mb-5">
              <h4 class="mb-3">対応言語</h4>
              <div id="guide-languages">
                <!-- 言語バッジがここに表示されます -->
              </div>
            </section>

            <!-- 専門分野 -->
            <section class="mb-5">
              <h4 class="mb-3">専門分野・キーワード</h4>
              <div id="guide-keywords">
                <!-- キーワードバッジがここに表示されます -->
              </div>
            </section>

            <!-- レビュー -->
            <section class="mb-5">
              <h4 class="mb-3">レビュー</h4>
              <div id="reviews-container">
                <!-- レビューカードがここに表示されます -->
                <div class="review-card card mb-3">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                      <div>
                        <strong>田中さん</strong>
                        <div class="text-warning">
                          <i class="bi bi-star-fill"></i>
                          <i class="bi bi-star-fill"></i>
                          <i class="bi bi-star-fill"></i>
                          <i class="bi bi-star-fill"></i>
                          <i class="bi bi-star-fill"></i>
                        </div>
                      </div>
                      <small class="text-muted">2024年6月</small>
                    </div>
                    <p class="mb-0">とても親切で知識豊富なガイドでした。地元の隠れた名所を案内していただき、素晴らしい体験ができました。</p>
                  </div>
                </div>

                <div class="review-card card mb-3">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                      <div>
                        <strong>佐藤さん</strong>
                        <div class="text-warning">
                          <i class="bi bi-star-fill"></i>
                          <i class="bi bi-star-fill"></i>
                          <i class="bi bi-star-fill"></i>
                          <i class="bi bi-star-fill"></i>
                          <i class="bi bi-star"></i>
                        </div>
                      </div>
                      <small class="text-muted">2024年5月</small>
                    </div>
                    <p class="mb-0">英語での説明も上手で、外国人の友人も大満足でした。また利用したいと思います。</p>
                  </div>
                </div>
              </div>
            </section>
          </div>
        </div>
      </div>

      <!-- 予約カード -->
      <div class="col-lg-4">
        <div class="card booking-card shadow-lg">
          <div class="card-body p-4">
            <h4 class="mb-3">予約する</h4>
            
            <div class="mb-3">
              <label for="booking-date" class="form-label">希望日時</label>
              <input type="datetime-local" class="form-control" id="booking-date" required>
            </div>
            
            <div class="mb-3">
              <label for="booking-duration" class="form-label">時間</label>
              <select class="form-select" id="booking-duration" required>
                <option value="">時間を選択</option>
                <option value="2">2時間</option>
                <option value="3">3時間</option>
                <option value="4">4時間</option>
                <option value="6">6時間</option>
                <option value="8">8時間（1日）</option>
              </select>
            </div>
            
            <div class="mb-3">
              <label for="booking-participants" class="form-label">参加人数</label>
              <select class="form-select" id="booking-participants" required>
                <option value="">人数を選択</option>
                <option value="1">1名</option>
                <option value="2">2名</option>
                <option value="3">3名</option>
                <option value="4">4名</option>
                <option value="5">5名</option>
                <option value="6">6名以上</option>
              </select>
            </div>
            
            <div class="mb-3">
              <label for="booking-message" class="form-label">メッセージ（任意）</label>
              <textarea class="form-control" id="booking-message" rows="3" placeholder="特別なリクエストがあればお聞かせください"></textarea>
            </div>
            
            <div class="border-top pt-3 mb-3">
              <div class="d-flex justify-content-between">
                <span>基本料金</span>
                <span id="base-price">¥0</span>
              </div>
              <div class="d-flex justify-content-between">
                <span>サービス料</span>
                <span>¥500</span>
              </div>
              <hr>
              <div class="d-flex justify-content-between fw-bold">
                <span>合計</span>
                <span id="total-price">¥500</span>
              </div>
            </div>
            
            <button class="btn btn-primary w-100" id="booking-submit">予約リクエストを送信</button>
            
            <div class="text-center mt-3">
              <small class="text-muted">※ガイドが承認後に予約確定</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="py-5"></div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // URLパラメータからガイドIDを取得
    const urlParams = new URLSearchParams(window.location.search);
    const guideId = urlParams.get('id');
    
    if (!guideId) {
      alert('ガイドIDが指定されていません');
      window.location.href = 'index.html';
      return;
    }

    // 認証チェックは head セクションで既に実行済み
    // この時点では認証済みユーザーのみが到達

    // ガイドデータを読み込み
    function loadGuideDetails() {
      // ローカルストレージからガイドデータを取得
      const guideData = localStorage.getItem(`guide_${guideId}`);
      
      if (guideData) {
        const guide = JSON.parse(guideData);
        displayGuideDetails(guide);
      } else {
        // データが見つからない場合は生成されたデータから検索
        if (typeof generateGuides === 'function') {
          const guides = generateGuides();
          const guide = guides.find(g => g.id == guideId);
          if (guide) {
            displayGuideDetails(guide);
          } else {
            alert('ガイドデータが見つかりません');
            window.location.href = 'index.html';
          }
        } else {
          alert('ガイドデータが見つかりません');
          window.location.href = 'index.html';
        }
      }
    }

    // ガイド詳細を表示
    function displayGuideDetails(guide) {
      document.getElementById('guide-name').textContent = guide.name;
      document.getElementById('guide-location').innerHTML = `<i class="bi bi-geo-alt-fill me-2"></i>${guide.region}`;
      document.getElementById('guide-description').textContent = guide.description;
      document.getElementById('rating-value').textContent = guide.rating.toFixed(1);
      document.getElementById('guide-price').textContent = `¥${guide.fee.toLocaleString()}/セッション`;
      document.getElementById('base-price').textContent = `¥${guide.fee.toLocaleString()}`;
      document.getElementById('total-price').textContent = `¥${(guide.fee + 500).toLocaleString()}`;
      
      // プロフィール画像
      if (guide.imageUrl) {
        document.getElementById('guide-avatar').src = guide.imageUrl;
      }
      
      // 言語バッジ
      const languagesContainer = document.getElementById('guide-languages');
      languagesContainer.innerHTML = guide.languages.map(lang => 
        `<span class="badge bg-secondary language-badge">${lang}</span>`
      ).join('');
      
      // キーワードバッジ
      const keywordsContainer = document.getElementById('guide-keywords');
      keywordsContainer.innerHTML = guide.keywords.map(keyword => 
        `<span class="badge bg-outline-primary language-badge">${keyword}</span>`
      ).join('');
      
      // レーティング星表示
      const ratingContainer = document.getElementById('guide-rating');
      const stars = Math.floor(guide.rating);
      const halfStar = guide.rating % 1 >= 0.5;
      let starsHTML = '';
      
      for (let i = 0; i < stars; i++) {
        starsHTML += '<i class="bi bi-star-fill"></i>';
      }
      if (halfStar) {
        starsHTML += '<i class="bi bi-star-half"></i>';
      }
      for (let i = stars + (halfStar ? 1 : 0); i < 5; i++) {
        starsHTML += '<i class="bi bi-star"></i>';
      }
      starsHTML += ` <span>${guide.rating.toFixed(1)}</span>`;
      
      ratingContainer.innerHTML = starsHTML;
      
      // ページタイトル更新
      document.title = `${guide.name} - ガイド詳細 | TomoTrip`;
    }

    // 予約処理
    document.getElementById('booking-submit').addEventListener('click', function() {
      const date = document.getElementById('booking-date').value;
      const duration = document.getElementById('booking-duration').value;
      const participants = document.getElementById('booking-participants').value;
      const message = document.getElementById('booking-message').value;
      
      if (!date || !duration || !participants) {
        alert('必須項目を入力してください');
        return;
      }
      
      // 予約データ
      const bookingData = {
        guideId: guideId,
        date: date,
        duration: duration,
        participants: participants,
        message: message,
        status: 'pending',
        timestamp: new Date().toISOString()
      };
      
      // ローカルストレージに保存（実際のアプリではサーバーに送信）
      const bookings = JSON.parse(localStorage.getItem('bookings') || '[]');
      bookings.push(bookingData);
      localStorage.setItem('bookings', JSON.stringify(bookings));
      
      alert('予約リクエストを送信しました！ガイドからの返答をお待ちください。');
      
      // 予約確認ページに遷移
      window.location.href = `booking-confirmation.html?id=${bookings.length - 1}`;
    });

    // ページ読み込み時に実行
    document.addEventListener('DOMContentLoaded', function() {
      loadGuideDetails();
    });
  </script>
  
  <!-- 言語切り替え機能 -->

  
  <script src="minimal-language.js"></script>
  
  <!-- テスト用ログイン機能 -->
  <script src="test-login.js"></script>
  
  <!-- ガイドデータ生成（データが見つからない場合のフォールバック） -->
  <script src="generate-guide-data.js"></script>
</body>
</html>