<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Guide Profile - TomoTrip</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .ocean-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .edit-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }
        .section-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }
        .section-header {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 15px 15px 0 0;
            margin: -1px -1px 0 -1px;
        }
        .rating-display {
            color: #ffc107;
        }
        .photo-preview {
            width: 80px;
            height: 80px;
            border-radius: 10px;
            object-fit: cover;
            margin: 5px;
        }
        .language-tag {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            margin: 2px;
            display: inline-block;
        }
        .specialty-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 8px 12px;
            margin: 3px;
            display: inline-block;
        }
        .edit-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            transition: all 0.3s ease;
        }
        .edit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .save-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            border: none;
            color: white;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
        }
    </style>
</head>
<body class="ocean-bg">
    <div class="container py-4">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <button class="btn btn-outline-light" onclick="history.back()">
                <i class="bi bi-arrow-left me-2"></i>Back
            </button>
            <h1 class="text-white mb-0">
                <i class="bi bi-person-gear me-2"></i>Edit Guide Profile
            </h1>
            <div></div>
        </div>

        <div class="edit-container p-4">
            <!-- Basic Information Section -->
            <div class="section-card p-3">
                <div class="section-header">
                    <h4 class="mb-0"><i class="bi bi-person-circle me-2"></i>Basic Information</h4>
                </div>
                <div class="p-3">
                    <div class="row">
                        <div class="col-md-3 text-center">
                            <div class="profile-photo-container mb-3">
                                <img id="profilePhotoPreview" src="/assets/images/default-guide.jpg" 
                                     class="rounded-circle border" width="120" height="120" 
                                     style="object-fit: cover;">
                                <div class="mt-2">
                                    <input type="file" id="profilePhotoInput" class="d-none" accept="image/*">
                                    <button class="btn btn-sm edit-btn" onclick="document.getElementById('profilePhotoInput').click()">
                                        <i class="bi bi-camera me-1"></i>Change Photo
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-9">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Guide Name</label>
                                    <input type="text" class="form-control" id="guideName" placeholder="Enter guide name">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Rate (Per Day)</label>
                                    <div class="input-group">
                                        <span class="input-group-text">Â¥</span>
                                        <input type="number" class="form-control" id="dailyRate" placeholder="0">
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Location</label>
                                    <input type="text" class="form-control" id="location" placeholder="e.g. Tokyo">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Guide Type</label>
                                    <select class="form-control" id="guideType">
                                        <option value="day">Day Guide</option>
                                        <option value="overnight">Overnight Guide</option>
                                        <option value="multi-day">Multi-Day Guide</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Languages</label>
                                <div id="languagesContainer">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="lang_japanese" value="Japanese">
                                        <label class="form-check-label" for="lang_japanese">Japanese</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="lang_english" value="English">
                                        <label class="form-check-label" for="lang_english">English</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="lang_chinese" value="Chinese">
                                        <label class="form-check-label" for="lang_chinese">Chinese</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="lang_korean" value="Korean">
                                        <label class="form-check-label" for="lang_korean">Korean</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="lang_taiwanese" value="Taiwanese">
                                        <label class="form-check-label" for="lang_taiwanese">Taiwanese</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- About Guide Section -->
            <div class="section-card p-3">
                <div class="section-header">
                    <h4 class="mb-0"><i class="bi bi-chat-text me-2"></i>About Guide</h4>
                </div>
                <div class="p-3">
                    <textarea class="form-control" id="introduction" rows="4" 
                              placeholder="Please write your self-introduction. Describe your strengths and passion as a guide."></textarea>
                </div>
            </div>

            <!-- Experience & Achievements Section -->
            <div class="section-card p-3">
                <div class="section-header">
                    <h4 class="mb-0"><i class="bi bi-award me-2"></i>Experience & Achievements</h4>
                </div>
                <div class="p-3">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Guide Experience</label>
                            <select class="form-control" id="experience">
                                <option value="beginner">Beginner (Less than 1 year)</option>
                                <option value="intermediate">Intermediate (1-3 years)</option>
                                <option value="advanced">Advanced (3+ years)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Achievements</label>
                            <input type="text" class="form-control" id="achievements" 
                                   placeholder="e.g. 200+ tour experiences">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Specialties</label>
                        <div id="specialtiesContainer">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="spec_culture" value="Cultureã»History">
                                <label class="form-check-label" for="spec_culture">Cultureã»History</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="spec_food" value="Food">
                                <label class="form-check-label" for="spec_food">Food</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="spec_nature" value="Nature">
                                <label class="form-check-label" for="spec_nature">Natureã»Outdoor</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="spec_shopping" value="Shopping">
                                <label class="form-check-label" for="spec_shopping">Shopping</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="spec_photo" value="Photography">
                                <label class="form-check-label" for="spec_photo">Photography</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tour Photo Gallery Section -->
            <div class="section-card p-3">
                <div class="section-header">
                    <h4 class="mb-0"><i class="bi bi-images me-2"></i>Tour Photo Gallery</h4>
                </div>
                <div class="p-3">
                    <div id="galleryPreview" class="mb-3">
                        <!-- Tour photo preview area -->
                    </div>
                    <input type="file" id="galleryInput" class="d-none" accept="image/*" multiple>
                    <button class="btn edit-btn" onclick="document.getElementById('galleryInput').click()">
                        <i class="bi bi-plus-circle me-2"></i>Add Photos
                    </button>
                    <small class="text-muted d-block mt-2">Up to 6 photos can be added</small>
                </div>
            </div>

            <!-- Contact Information Section -->
            <div class="section-card p-3">
                <div class="section-header">
                    <h4 class="mb-0"><i class="bi bi-envelope me-2"></i>Contact Information</h4>
                </div>
                <div class="p-3">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Email Address</label>
                            <input type="email" class="form-control" id="email" readonly>
                            <small class="text-muted">Email address cannot be changed</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Phone Number</label>
                            <input type="tel" class="form-control" id="phone" readonly>
                            <small class="text-muted">Phone number cannot be changed</small>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Available Hours</label>
                        <input type="text" class="form-control" id="availability" 
                               placeholder="e.g. 9:00 - 18:00">
                    </div>
                </div>
            </div>

            <!-- Additional Information Section -->
            <div class="section-card p-3">
                <div class="section-header">
                    <h4 class="mb-0"><i class="bi bi-info-circle me-2"></i>Additional Information</h4>
                </div>
                <div class="p-3">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="multiLingual">
                                <label class="form-check-label" for="multiLingual">Multilingual Support</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="hospitalitySupport">
                                <label class="form-check-label" for="hospitalitySupport">Hospitality Focused</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="emergencySupport">
                                <label class="form-check-label" for="emergencySupport">Emergency Support</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="localExpert">
                                <label class="form-check-label" for="localExpert">Local Expert</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Save Button -->
            <div class="text-center mt-4">
                <button type="button" class="btn save-btn me-3" id="saveChanges">
                    <i class="bi bi-check-circle me-2"></i>Save Changes
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="history.back()">
                    <i class="bi bi-x-circle me-2"></i>Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center p-4">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h5>Saving guide information...</h5>
                    <p class="text-muted mb-0">Please wait</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentGuideId = null;
        
        // URLãã guide ID ãåå¾ (ãããã°æå ±è¿½å )
        console.log('ð Current URL:', window.location.href);
        console.log('ð Search params:', window.location.search);
        
        const urlParams = new URLSearchParams(window.location.search);
        currentGuideId = urlParams.get('id');
        
        console.log('ð Extracted guide ID:', currentGuideId);
        console.log('ð All URL params:', Object.fromEntries(urlParams));
        
        if (!currentGuideId || currentGuideId.trim() === '') {
            console.error('â No guide ID found in URL parameters');
            alert('Guide ID not specified. Please check URL parameters.\n\nURL: ' + window.location.href);
            window.location.href = 'index-en.html';
        } else {
            console.log('â Guide ID validated:', currentGuideId);
        }

        // ãã¼ã¸èª­ã¿è¾¼ã¿æã«ã¬ã¤ãæå ±ãåå¾
        document.addEventListener('DOMContentLoaded', async function() {
            await loadGuideData();
            setupEventListeners();
        });

        // ã¬ã¤ãæå ±ãèª­ã¿è¾¼ã¿
        async function loadGuideData() {
            try {
                console.log('ð Loading guide data for ID:', currentGuideId);
                const response = await fetch(`/api/guides/${currentGuideId}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('ð¥ API Response:', result);
                
                if (result.success && result.guide) {
                    console.log('â Guide data loaded successfully');
                    populateForm(result.guide);
                } else {
                    console.error('â Failed to get guide data:', result);
                    alert('Failed to load guide information: ' + (result.message || 'Unknown error'));
                    window.location.href = 'index-en.html';
                }
            } catch (error) {
                console.error('â Error loading guide data:', error);
                alert('Error loading guide information: ' + error.message);
                window.location.href = 'index-en.html';
            }
        }

        // ãã©ã¼ã ã«ãã¼ã¿ãå¥å
        function populateForm(guide) {
            document.getElementById('guideName').value = guide.guideName || '';
            document.getElementById('dailyRate').value = guide.guideSessionRate || '';
            document.getElementById('location').value = guide.location || 'Tokyo';
            document.getElementById('guideType').value = guide.guideType || 'day';
            document.getElementById('introduction').value = guide.guideIntroduction || '';
            document.getElementById('experience').value = guide.guideExperience || 'intermediate';
            document.getElementById('achievements').value = guide.achievements || '';
            document.getElementById('email').value = guide.guideEmail || '';
            document.getElementById('phone').value = guide.phoneNumber || '';
            document.getElementById('availability').value = guide.guideAvailability || '';
            
            // Language checkboxes setup
            if (guide.guideLanguages && Array.isArray(guide.guideLanguages)) {
                const languageMap = {
                    'Japanese': 'lang_japanese',
                    'English': 'lang_english',
                    'Chinese': 'lang_chinese',
                    'Korean': 'lang_korean',
                    'Taiwanese': 'lang_taiwanese',
                    'æ¥æ¬èª': 'lang_japanese',
                    'è±èª': 'lang_english',
                    'ä¸­å½èª': 'lang_chinese',
                    'éå½èª': 'lang_korean',
                    'å°æ¹¾èª': 'lang_taiwanese'
                };
                
                guide.guideLanguages.forEach(lang => {
                    const checkbox = document.getElementById(languageMap[lang]);
                    if (checkbox) checkbox.checked = true;
                });
            }
            
            // Specialties checkboxes setup
            if (guide.guideSpecialties) {
                const specialties = guide.guideSpecialties.split(',').map(s => s.trim());
                const specialtyMap = {
                    'Cultureã»History': 'spec_culture',
                    'Food': 'spec_food', 
                    'Nature': 'spec_nature',
                    'Shopping': 'spec_shopping',
                    'Photography': 'spec_photo',
                    'æåã»æ­´å²ã¬ã¤ã': 'spec_culture',
                    'ã°ã«ã¡ã¬ã¤ã': 'spec_food', 
                    'èªç¶ã¬ã¤ã': 'spec_nature',
                    'ã·ã§ããã³ã°': 'spec_shopping',
                    'åçæ®å½±': 'spec_photo'
                };
                
                specialties.forEach(spec => {
                    const checkbox = document.getElementById(specialtyMap[spec]);
                    if (checkbox) checkbox.checked = true;
                });
            }
            
            // ãã­ãã£ã¼ã«åçè¨­å®
            if (guide.profilePhoto && guide.profilePhoto.fileName) {
                document.getElementById('profilePhotoPreview').src = `/uploads/${guide.profilePhoto.fileName}`;
            }
        }

        // ã¤ãã³ããªã¹ãã¼ã»ããã¢ãã
        function setupEventListeners() {
            // ä¿å­ãã¿ã³
            document.getElementById('saveChanges').addEventListener('click', saveGuideData);
            
            // ãã¡ã¤ã«å¥å
            document.getElementById('profilePhotoInput').addEventListener('change', handleProfilePhotoChange);
            document.getElementById('galleryInput').addEventListener('change', handleGalleryChange);
        }

        // ãã­ãã£ã¼ã«åçå¤æ´å¦ç
        function handleProfilePhotoChange(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('profilePhotoPreview').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        // ã®ã£ã©ãªã¼åçè¿½å å¦ç
        function handleGalleryChange(event) {
            const files = Array.from(event.target.files);
            const galleryPreview = document.getElementById('galleryPreview');
            
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'photo-preview';
                    img.onclick = function() { this.remove(); };
                    galleryPreview.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        }

        // ã¬ã¤ãæå ±ä¿å­
        async function saveGuideData() {
            const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
            loadingModal.show();
            
            try {
                // ãã©ã¼ã ãã¼ã¿åé
                const formData = collectFormData();
                
                const response = await fetch(`/api/guides/${currentGuideId}/edit`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    loadingModal.hide();
                    showToast('ã¬ã¤ãæå ±ãæ­£å¸¸ã«æ´æ°ãã¾ããï¼', 'success');
                    
                    // ã¡ã¤ã³ãã¼ã¸ããªã­ã¼ããã¦ææ°æå ±ãåæ 
                    if (window.opener) {
                        // Send message to parent window to trigger refresh
                        try {
                            window.opener.postMessage({
                                type: 'guideUpdated',
                                guideId: currentGuideId,
                                action: 'edit',
                                message: 'Guide information updated!'
                            }, '*');
                            console.log('â Update message sent to parent window');
                        } catch (messageError) {
                            console.warn('â ï¸ Failed to send message to parent:', messageError);
                        }
                        
                        // Use the global refresh function if available
                        if (window.opener.refreshGuideData) {
                            await window.opener.refreshGuideData();
                        } else {
                            window.opener.location.reload();
                        }
                        
                        // Show success notification in parent window
                        if (window.opener.showNewGuideNotification) {
                            window.opener.showNewGuideNotification(1, false, 'Guide information updated!');
                        }
                    }
                    
                    // Automatically return to main page
                    setTimeout(() => {
                        console.log('â Guide edit completed - Returning to main page');
                        if (window.opener) {
                            window.close();
                        } else {
                            window.location.href = 'index-en.html';
                        }
                    }, 1500);
                    
                } else {
                    throw new Error(result.message || 'Update failed');
                }
                
            } catch (error) {
                console.error('Save error:', error);
                loadingModal.hide();
                alert('Error saving: ' + error.message);
            }
        }

        // ãã©ã¼ã ãã¼ã¿åé
        function collectFormData() {
            // é¸æãããè¨èªãåé
            const selectedLanguages = [];
            const languageCheckboxes = document.querySelectorAll('#languagesContainer input[type="checkbox"]:checked');
            languageCheckboxes.forEach(cb => selectedLanguages.push(cb.value));
            
            // é¸æãããå¾æåéãåé
            const selectedSpecialties = [];
            const specialtyCheckboxes = document.querySelectorAll('#specialtiesContainer input[type="checkbox"]:checked');
            specialtyCheckboxes.forEach(cb => selectedSpecialties.push(cb.value));
            
            return {
                guideName: document.getElementById('guideName').value,
                guideSessionRate: document.getElementById('dailyRate').value,
                location: document.getElementById('location').value,
                guideType: document.getElementById('guideType').value,
                guideLanguages: selectedLanguages,
                guideIntroduction: document.getElementById('introduction').value,
                guideExperience: document.getElementById('experience').value,
                achievements: document.getElementById('achievements').value,
                guideSpecialties: selectedSpecialties.join(', '),
                guideAvailability: document.getElementById('availability').value,
                multiLingual: document.getElementById('multiLingual').checked,
                hospitalitySupport: document.getElementById('hospitalitySupport').checked,
                emergencySupport: document.getElementById('emergencySupport').checked,
                localExpert: document.getElementById('localExpert').checked
            };
        }

        // Toastéç¥ã·ã¹ãã 
        function showToast(message, type = 'success') {
            const toastHtml = `
                <div class="toast-container position-fixed top-0 end-0 p-3">
                    <div class="toast show" role="alert">
                        <div class="toast-header">
                            <i class="bi bi-${type === 'success' ? 'check-circle-fill text-success' : 'exclamation-triangle-fill text-danger'} me-2"></i>
                            <strong class="me-auto">TomoTrip</strong>
                            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                        </div>
                        <div class="toast-body">${message}</div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', toastHtml);
            
            setTimeout(() => {
                const toastElement = document.querySelector('.toast-container');
                if (toastElement) toastElement.remove();
            }, 3000);
        }
    </script>
</body>
</html>