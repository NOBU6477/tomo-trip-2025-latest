// TomoTrip Application Initialization - Direct Implementation
// No imports - all functions defined directly to prevent loading issues

console.log('üöÄ TomoTrip app-init.mjs loading...');

// Early detection for iframe
const isReplitIframe = window.self !== window.top;

if (isReplitIframe) {
    window.FOOTER_EMERGENCY_DISABLED = true;
    console.log('üîá Iframe context detected');
}

// Default guide data - simplified
const defaultGuideData = [
    { id: 1, name: "Áî∞‰∏≠ÂÅ•Â§™", location: "tokyo", rating: 4.8, price: 8000, photo: "/assets/img/guides/default-1.svg", languages: ["ja", "en"], specialties: ["history", "culture"] },
    { id: 2, name: "‰ΩêËó§ÁæéÂí≤", location: "osaka", rating: 4.9, price: 7500, photo: "/assets/img/guides/default-2.svg", languages: ["ja", "en", "zh"], specialties: ["food", "local"] },
    { id: 3, name: "Èà¥Êú®‰∏ÄÈÉé", location: "kyoto", rating: 4.7, price: 9000, photo: "/assets/img/guides/default-3.svg", languages: ["ja", "en"], specialties: ["temples", "traditional"] },
    { id: 4, name: "Â±±Áî∞Ëä±Â≠ê", location: "osaka", rating: 4.6, price: 7000, photo: "/assets/img/guides/default-4.svg", languages: ["ja", "en"], specialties: ["shopping", "food"] },
    { id: 5, name: "Johnson Mike", location: "tokyo", rating: 4.8, price: 8500, photo: "/assets/img/guides/default-5.svg", languages: ["en", "ja"], specialties: ["business", "modern"] },
    { id: 6, name: "ÊùéÁæéÈ∫ó", location: "kyoto", rating: 4.9, price: 8800, photo: "attached_assets/image_1754399234136.png", languages: ["zh", "ja", "en"], specialties: ["culture", "temples"] },
    { id: 7, name: "È´òÊ©ãÁøîÂ§™", location: "hokkaido", rating: 4.7, price: 9500, photo: "attached_assets/image_1754399234136.png", languages: ["ja", "en"], specialties: ["nature", "skiing"] },
    { id: 8, name: "Anderson Sarah", location: "okinawa", rating: 4.8, price: 8200, photo: "attached_assets/image_1754399234136.png", languages: ["en", "ja"], specialties: ["beach", "diving"] },
    { id: 9, name: "ÈáëÊàêÊ∞ë", location: "tokyo", rating: 4.6, price: 7800, photo: "attached_assets/image_1754399234136.png", languages: ["ko", "ja", "en"], specialties: ["kpop", "modern"] },
    { id: 10, name: "‰ºäËó§ÂÑ™Â≠ê", location: "nara", rating: 4.9, price: 8600, photo: "attached_assets/image_1754399234136.png", languages: ["ja", "en"], specialties: ["deer", "temples"] },
    { id: 11, name: "Rodriguez Carlos", location: "hiroshima", rating: 4.7, price: 8300, photo: "attached_assets/image_1754399234136.png", languages: ["es", "ja", "en"], specialties: ["history", "peace"] },
    { id: 12, name: "‰∏≠ÊùëÂ≠ù", location: "fukuoka", rating: 4.8, price: 7900, photo: "attached_assets/image_1754399234136.png", languages: ["ja", "en"], specialties: ["ramen", "local"] }
];

/** Main application initialization function */
function appInit() {
    console.log('üå¥ TomoTrip Application Starting...');
    
    // Initialize with default guide data
    const guides = defaultGuideData;
    window.defaultGuides = guides;
    
    console.log('üéØ Environment Data Sync:', {
        guides: guides.length,
        source: 'defaultGuideData (direct)',
    });
    setupEventListeners(state);
    
    // Render initial guide cards using single consistent system
    try {
        // Only use renderGuideCards - don't call displayGuides which conflicts
        renderGuideCards(guides);
        
        // Force update counters immediately
        setTimeout(() => {
            updateGuideCounters(guides.length, guides.length);
        }, 100);
        
        console.log('‚úÖ Guide cards rendered successfully');
    } catch (error) {
        console.error('‚ùå Error rendering guide cards:', error);
        
        // Fallback: manually update counters even if rendering fails
        const guideCounter = document.getElementById('guideCounter');
        const totalGuideCounter = document.getElementById('totalGuideCounter');
        if (guideCounter) guideCounter.textContent = `${guides.length}‰∫∫„ÅÆ„Ç¨„Ç§„Éâ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åó„Åü`;
        if (totalGuideCounter) totalGuideCounter.textContent = `Á∑èÊï∞: ${guides.length}‰∫∫`;
    }
    
    // Setup login system
    if (window.updateLoginStatus) {
        window.updateLoginStatus();
        console.log('‚úÖ Login status updated');
    }
    
    if (window.setupLoginDropdown) {
        window.setupLoginDropdown();
        console.log('‚úÖ Login dropdown setup');
    }
    
    if (window.setupLoginForms) {
        window.setupLoginForms();
        console.log('‚úÖ Login forms setup');
    }
    
    // Set up login dropdown button handlers
    setTimeout(() => {
        const touristLoginBtn = document.getElementById('directTouristLoginBtn');
        const guideLoginBtn = document.getElementById('directGuideLoginBtn');
        
        if (touristLoginBtn && window.handleTouristLogin) {
            touristLoginBtn.addEventListener('click', window.handleTouristLogin);
            console.log('‚úÖ Tourist login button handler attached');
        }
        
        if (guideLoginBtn && window.handleGuideLogin) {
            guideLoginBtn.addEventListener('click', window.handleGuideLogin);
            console.log('‚úÖ Guide login button handler attached');
        }
        
        // Set up main hero buttons
        const findGuideBtn = document.getElementById('findGuideBtn');
        const contactBtn = document.getElementById('contactBtn');
        
        if (findGuideBtn) {
            findGuideBtn.addEventListener('click', function() {
                // Scroll to guides section
                const guidesSection = document.getElementById('guides-section');
                if (guidesSection) {
                    guidesSection.scrollIntoView({ behavior: 'smooth' });
                }
            });
            console.log('‚úÖ Find Guide button handler attached');
        }
        
        if (contactBtn) {
            contactBtn.addEventListener('click', function() {
                // Show contact modal or information
                alert('„ÅäÂïè„ÅÑÂêà„Çè„Åõ„ÅÑ„Åü„Å†„Åç„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÇ\n\n„É°„Éº„É´: info@tomotrip.com\nÈõªË©±: 03-1234-5678\n\n„Åæ„Åü„ÅØ„ÄÅ„ÅîÂ∏åÊúõ„ÅÆ„Ç¨„Ç§„Éâ„Åã„ÇâÁõ¥Êé•„ÅäÂïè„ÅÑÂêà„Çè„Åõ„ÅÑ„Åü„Å†„Åë„Åæ„Åô„ÄÇ');
            });
            console.log('‚úÖ Contact button handler attached');
        }
    }, 100);
    
    // Setup button handlers
    wireSponsorButtons();
    wireLanguageSwitcher();
    
    log.ok('‚úÖ Application initialized successfully with AppState');
    
    // Make critical functions globally available
    window.renderGuideCards = renderGuideCards;
    window.updateGuideCounters = updateGuideCounters;
    window.displayGuides = displayGuides;
    
    // Direct function definitions - bypassing dynamic import to prevent loading issues
    console.log('üîß Setting up global functions directly...');
    
    // Filter functions with full implementation
    window.filterGuides = function() {
        console.log('üîç filterGuides called');
        try {
            const location = document.getElementById('locationFilter')?.value || '';
            const language = document.getElementById('languageFilter')?.value || '';
            const price = document.getElementById('priceFilter')?.value || '';
            const keyword = document.getElementById('keywordInput')?.value?.toLowerCase() || '';
            
            console.log('üîç Filter values:', { location, language, price, keyword });
            
            // Get all guides
            const allGuides = window.defaultGuides || [];
            
            // Apply filters
            let filtered = allGuides.filter(guide => {
                const locationMatch = !location || guide.location === location;
                const languageMatch = !language || (Array.isArray(guide.languages) ? guide.languages.includes(language) : guide.languages === language);
                const priceMatch = !price || (
                    price === 'low' && guide.price <= 8000 ||
                    price === 'medium' && guide.price > 8000 && guide.price <= 10000 ||
                    price === 'high' && guide.price > 10000
                );
                const keywordMatch = !keyword || 
                    guide.name.toLowerCase().includes(keyword) ||
                    (guide.specialty && guide.specialty.toLowerCase().includes(keyword)) ||
                    (guide.description && guide.description.toLowerCase().includes(keyword));
                
                return locationMatch && languageMatch && priceMatch && keywordMatch;
            });
            
            console.log(`‚úÖ Filtered guides: ${filtered.length} out of ${allGuides.length}`);
            
            // Re-render guide cards
            if (window.renderGuideCards) {
                window.renderGuideCards(filtered);
            }
            
            // Update counters
            if (window.updateGuideCounters) {
                window.updateGuideCounters(filtered.length, allGuides.length);
            }
            
        } catch (error) {
            console.error('‚ùå Filter error:', error);
            alert('Ê§úÁ¥¢‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
        }
    };
    
    window.resetFilters = function() {
        console.log('üîÑ resetFilters called');
        try {
            // Clear all filter inputs
            const locationFilter = document.getElementById('locationFilter');
            const languageFilter = document.getElementById('languageFilter');
            const priceFilter = document.getElementById('priceFilter');
            const keywordInput = document.getElementById('keywordInput');
            
            if (locationFilter) locationFilter.value = '';
            if (languageFilter) languageFilter.value = '';
            if (priceFilter) priceFilter.value = '';
            if (keywordInput) keywordInput.value = '';
            
            // Reset to show all guides
            const allGuides = window.defaultGuides || [];
            
            if (window.renderGuideCards) {
                window.renderGuideCards(allGuides);
            }
            
            if (window.updateGuideCounters) {
                window.updateGuideCounters(allGuides.length, allGuides.length);
            }
            
            console.log('‚úÖ Filters reset successfully');
            
        } catch (error) {
            console.error('‚ùå Reset error:', error);
            location.reload();
        }
    };
    
    window.handleSponsorRegistration = function() {
        console.log('üè™ handleSponsorRegistration called');
        window.location.href = 'sponsor-registration.html';
    };
    
    // Tourist registration modal functions
    window.goToStep2Modal = function() {
        console.log('üéØ goToStep2Modal called');
        
        const phoneInput = document.getElementById('touristPhone');
        const firstNameInput = document.getElementById('touristFirstName');
        const lastNameInput = document.getElementById('touristLastName');
        const emailInput = document.getElementById('touristEmail');
        
        // Basic validation
        if (!firstNameInput?.value?.trim()) {
            alert('ÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            return;
        }
        if (!lastNameInput?.value?.trim()) {
            alert('Âßì„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            return;
        }
        if (!emailInput?.value?.trim()) {
            alert('„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            return;
        }
        if (!phoneInput?.value?.trim()) {
            alert('ÈõªË©±Áï™Âè∑„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            return;
        }
        
        // Hide step 1, show step 2
        const step1 = document.getElementById('step1Content');
        const step2 = document.getElementById('step2Content');
        if (step1) step1.style.display = 'none';
        if (step2) step2.style.display = 'block';
        
        // Update step indicators
        const step1Indicator = document.getElementById('step1-indicator');
        const step2Indicator = document.getElementById('step2-indicator');
        if (step1Indicator?.querySelector('.badge')) {
            step1Indicator.querySelector('.badge').className = 'badge bg-success rounded-circle me-2';
        }
        if (step2Indicator?.querySelector('.badge')) {
            step2Indicator.querySelector('.badge').className = 'badge bg-primary rounded-circle me-2';
        }
        
        // Update phone display
        const phoneDisplay = document.getElementById('phoneDisplayModal');
        if (phoneDisplay) {
            phoneDisplay.textContent = 'ÈõªË©±Áï™Âè∑: ' + phoneInput.value;
        }
        
        console.log('‚úÖ Successfully moved to step 2');
    };
    
    window.clearRegistrationModal = function() {
        console.log('üßπ Clearing registration modal data');
        
        // Clear all form inputs
        const inputs = ['touristFirstName', 'touristLastName', 'touristEmail', 'touristPhone', 'touristCountry', 
                       'touristVisitDuration', 'touristPreferredLanguage', 'touristSpecialRequests'];
        
        inputs.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.value = '';
            }
        });
        
        // Clear checkboxes
        const checkboxes = document.querySelectorAll('#registrationModal input[type="checkbox"]');
        checkboxes.forEach(cb => cb.checked = false);
        
        // Reset to step 1
        const step1 = document.getElementById('step1Content');
        const step2 = document.getElementById('step2Content');
        const step3 = document.getElementById('step3Content');
        if (step1) step1.style.display = 'block';
        if (step2) step2.style.display = 'none';
        if (step3) step3.style.display = 'none';
        
        // Reset indicators
        const step1Indicator = document.getElementById('step1-indicator');
        const step2Indicator = document.getElementById('step2-indicator');
        const step3Indicator = document.getElementById('step3-indicator');
        
        if (step1Indicator?.querySelector('.badge')) {
            step1Indicator.querySelector('.badge').className = 'badge bg-primary rounded-circle me-2';
        }
        if (step2Indicator?.querySelector('.badge')) {
            step2Indicator.querySelector('.badge').className = 'badge bg-secondary rounded-circle me-2';
        }
        if (step3Indicator?.querySelector('.badge')) {
            step3Indicator.querySelector('.badge').className = 'badge bg-secondary rounded-circle me-2';
        }
        
        console.log('‚úÖ Registration modal cleared');
    };
    
    // Additional tourist registration functions
    window.goToStep1Modal = function() {
        const step1 = document.getElementById('step1Content');
        const step2 = document.getElementById('step2Content');
        if (step1) step1.style.display = 'block';
        if (step2) step2.style.display = 'none';
        
        const step1Indicator = document.getElementById('step1-indicator');
        const step2Indicator = document.getElementById('step2-indicator');
        if (step1Indicator?.querySelector('.badge')) {
            step1Indicator.querySelector('.badge').className = 'badge bg-primary rounded-circle me-2';
        }
        if (step2Indicator?.querySelector('.badge')) {
            step2Indicator.querySelector('.badge').className = 'badge bg-secondary rounded-circle me-2';
        }
        console.log('‚úÖ Returned to step 1');
    };
    
    window.goToStep3Modal = function() {
        const step2 = document.getElementById('step2Content');
        const step3 = document.getElementById('step3Content');
        if (step2) step2.style.display = 'none';
        if (step3) step3.style.display = 'block';
        
        const step2Indicator = document.getElementById('step2-indicator');
        const step3Indicator = document.getElementById('step3-indicator');
        if (step2Indicator?.querySelector('.badge')) {
            step2Indicator.querySelector('.badge').className = 'badge bg-success rounded-circle me-2';
        }
        if (step3Indicator?.querySelector('.badge')) {
            step3Indicator.querySelector('.badge').className = 'badge bg-primary rounded-circle me-2';
        }
        console.log('‚úÖ Moved to step 3');
    };
    
    console.log('‚úÖ All global functions set up successfully:', {
        filterGuides: typeof window.filterGuides,
        resetFilters: typeof window.resetFilters,
        goToStep2Modal: typeof window.goToStep2Modal,
        clearRegistrationModal: typeof window.clearRegistrationModal,
        handleSponsorRegistration: typeof window.handleSponsorRegistration
    });
    
    // Setup guide card click handlers with authentication
    setTimeout(() => {
        setupGuideCardClickHandlers();
        
        // Setup tourist registration system
        if (window.setupTouristRegistration) {
            window.setupTouristRegistration();
        }
    }, 200);
    
    console.log('üåç Global functions exposed:', {
        renderGuideCards: typeof window.renderGuideCards,
        updateGuideCounters: typeof window.updateGuideCounters,
        displayGuides: typeof window.displayGuides
    });
    
    // Signal that the app is ready
    document.body.setAttribute('data-app-status', 'ready');
    document.dispatchEvent(new CustomEvent('appReady', { detail: { guides: guides.length } }));
    console.log('üéâ TomoTrip application is fully ready!');
}

// Simplified guide rendering - bypassing complex module system
function renderGuidesDirectly() {
    console.log('üéØ Rendering guides directly...');
    
    const container = document.getElementById('guideCardsContainer');
    if (!container) {
        console.error('Guide container not found');
        return;
    }
    
    // Full guide dataset - expanded from original defaultGuideData
    const guides = [
        { id: 1, name: "Áî∞‰∏≠ÂÅ•Â§™", location: "tokyo", rating: 4.8, price: 8000, photo: "/assets/img/guides/default-1.svg", languages: ["ja", "en"], specialties: ["history", "culture"] },
        { id: 2, name: "‰ΩêËó§ÁæéÂí≤", location: "osaka", rating: 4.9, price: 7500, photo: "/assets/img/guides/default-2.svg", languages: ["ja", "en", "zh"], specialties: ["food", "local"] },
        { id: 3, name: "Èà¥Êú®‰∏ÄÈÉé", location: "kyoto", rating: 4.7, price: 9000, photo: "/assets/img/guides/default-3.svg", languages: ["ja", "en"], specialties: ["temples", "traditional"] },
        { id: 4, name: "Â±±Áî∞Ëä±Â≠ê", location: "osaka", rating: 4.6, price: 7000, photo: "/assets/img/guides/default-4.svg", languages: ["ja", "en"], specialties: ["shopping", "food"] },
        { id: 5, name: "Johnson Mike", location: "tokyo", rating: 4.8, price: 8500, photo: "/assets/img/guides/default-5.svg", languages: ["en", "ja"], specialties: ["business", "modern"] },
        { id: 6, name: "ÊùéÁæéÈ∫ó", location: "kyoto", rating: 4.9, price: 8800, photo: "attached_assets/image_1754399234136.png", languages: ["zh", "ja", "en"], specialties: ["culture", "temples"] },
        { id: 7, name: "È´òÊ©ãÁøîÂ§™", location: "hokkaido", rating: 4.7, price: 9500, photo: "attached_assets/image_1754399234136.png", languages: ["ja", "en"], specialties: ["nature", "skiing"] },
        { id: 8, name: "Anderson Sarah", location: "okinawa", rating: 4.8, price: 8200, photo: "attached_assets/image_1754399234136.png", languages: ["en", "ja"], specialties: ["beach", "diving"] },
        { id: 9, name: "ÈáëÊàêÊ∞ë", location: "tokyo", rating: 4.6, price: 7800, photo: "attached_assets/image_1754399234136.png", languages: ["ko", "ja", "en"], specialties: ["kpop", "modern"] },
        { id: 10, name: "‰ºäËó§ÂÑ™Â≠ê", location: "nara", rating: 4.9, price: 8600, photo: "attached_assets/image_1754399234136.png", languages: ["ja", "en"], specialties: ["deer", "temples"] },
        { id: 11, name: "Rodriguez Carlos", location: "hiroshima", rating: 4.7, price: 8300, photo: "attached_assets/image_1754399234136.png", languages: ["es", "ja", "en"], specialties: ["history", "peace"] },
        { id: 12, name: "‰∏≠ÊùëÂ≠ù", location: "fukuoka", rating: 4.8, price: 7900, photo: "attached_assets/image_1754399234136.png", languages: ["ja", "en"], specialties: ["ramen", "local"] }
    ];
    
    // Set global reference for modal system
    window.defaultGuides = guides;
    
    // Location mapping for display
    window.locationNames = {
        hokkaido: "ÂåóÊµ∑ÈÅì", tokyo: "Êù±‰∫¨ÈÉΩ", osaka: "Â§ßÈò™Â∫ú", kyoto: "‰∫¨ÈÉΩÂ∫ú", 
        nara: "Â•àËâØÁúå", hiroshima: "Â∫ÉÂ≥∂Áúå", fukuoka: "Á¶èÂ≤°Áúå", okinawa: "Ê≤ñÁ∏ÑÁúå"
    };
    
    // Render cards
    const cardsHTML = guides.map(guide => `
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="guide-card h-100" style="border: none; border-radius: 15px; overflow: hidden; box-shadow: 0 8px 25px rgba(0,0,0,0.1); transition: all 0.3s ease; background: white;">
                <div class="position-relative">
                    <img src="${guide.photo || '/assets/img/guides/default-1.svg'}" 
                         class="card-img-top" alt="${guide.name}" 
                         style="height: 250px; object-fit: cover;">
                    <div class="position-absolute top-0 end-0 m-2">
                        <span class="badge" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; font-size: 12px; padding: 5px 10px; border-radius: 15px;">
                            Ë©ï‰æ° ${guide.rating} ‚≠ê
                        </span>
                    </div>
                </div>
                <div class="card-body p-4">
                    <h5 class="card-title fw-bold mb-2" style="color: #2c3e50;">${guide.name}</h5>
                    <p class="text-muted mb-2">
                        <i class="bi bi-geo-alt"></i> ${window.locationNames[guide.location] || guide.location}
                    </p>
                    <p class="card-text text-muted mb-3" style="font-size: 14px; line-height: 1.4;">
                        Âú∞Âüü„ÅÆÈ≠ÖÂäõ„Çí„ÅîÊ°àÂÜÖ„Åó„Åæ„Åô
                    </p>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small class="text-muted">ÂØæÂøúË®ÄË™û</small>
                            <small class="fw-semibold">${Array.isArray(guide.languages) ? guide.languages.map(lang => {
                                const langMap = {
                                    'ja': 'Êó•Êú¨Ë™û', 'japanese': 'Êó•Êú¨Ë™û',
                                    'en': 'Ëã±Ë™û', 'english': 'Ëã±Ë™û', 
                                    'zh': '‰∏≠ÂõΩË™û', 'chinese': '‰∏≠ÂõΩË™û',
                                    'ko': 'ÈüìÂõΩË™û', 'korean': 'ÈüìÂõΩË™û',
                                    'es': '„Çπ„Éö„Ç§„É≥Ë™û', 'spanish': '„Çπ„Éö„Ç§„É≥Ë™û',
                                    'fr': '„Éï„É©„É≥„ÇπË™û', 'french': '„Éï„É©„É≥„ÇπË™û',
                                    'de': '„Éâ„Ç§„ÉÑË™û', 'german': '„Éâ„Ç§„ÉÑË™û',
                                    'it': '„Ç§„Çø„É™„Ç¢Ë™û', 'italian': '„Ç§„Çø„É™„Ç¢Ë™û'
                                };
                                return langMap[lang.toLowerCase()] || lang;
                            }).join(', ') : guide.languages}</small>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small class="text-muted">ÊñôÈáë</small>
                            <small class="fw-bold text-primary">¬•${Number(guide.price).toLocaleString()}</small>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" 
                                data-action="view-details" 
                                data-guide-id="${guide.id}"
                                style="background: linear-gradient(135deg, #667eea, #764ba2); border: none; border-radius: 10px; padding: 10px;">
                            Ë©≥„Åó„ÅèË¶ã„Çã
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = cardsHTML;
    
    // Update counters
    const guideCounter = document.getElementById('guideCounter');
    const totalGuideCounter = document.getElementById('totalGuideCounter');
    if (guideCounter) guideCounter.textContent = `${guides.length}‰∫∫„ÅÆ„Ç¨„Ç§„Éâ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åó„ÅüÔºàÂÖ®${guides.length}‰∫∫‰∏≠Ôºâ`;
    if (totalGuideCounter) totalGuideCounter.textContent = `Á∑èÊï∞: ${guides.length}‰∫∫`;
    
    console.log(`‚úÖ Rendered ${guides.length} guide cards successfully`);
}

// Initialize application with direct rendering
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        renderGuidesDirectly();
        appInit();
    });
} else {
    renderGuidesDirectly();
    appInit();
}

// Location mapping for display - unified to prevent conflicts
if (!window.locationNames) {
    window.locationNames = {
        hokkaido: "ÂåóÊµ∑ÈÅì", aomori: "ÈùíÊ£ÆÁúå", iwate: "Â≤©ÊâãÁúå", miyagi: "ÂÆÆÂüéÁúå", akita: "ÁßãÁî∞Áúå", yamagata: "Â±±ÂΩ¢Áúå", fukushima: "Á¶èÂ≥∂Áúå",
        ibaraki: "Ëå®ÂüéÁúå", tochigi: "Ê†ÉÊú®Áúå", gunma: "Áæ§È¶¨Áúå", saitama: "ÂüºÁéâÁúå", chiba: "ÂçÉËëâÁúå", tokyo: "Êù±‰∫¨ÈÉΩ", kanagawa: "Á•ûÂ•àÂ∑ùÁúå",
        niigata: "Êñ∞ÊΩüÁúå", toyama: "ÂØåÂ±±Áúå", ishikawa: "Áü≥Â∑ùÁúå", fukui: "Á¶è‰∫ïÁúå", yamanashi: "Â±±Ê¢®Áúå", nagano: "Èï∑ÈáéÁúå", gifu: "Â≤êÈòúÁúå", shizuoka: "ÈùôÂ≤°Áúå", aichi: "ÊÑõÁü•Áúå",
        mie: "‰∏âÈáçÁúå", shiga: "ÊªãË≥ÄÁúå", kyoto: "‰∫¨ÈÉΩÂ∫ú", osaka: "Â§ßÈò™Â∫ú", hyogo: "ÂÖµÂ∫´Áúå", nara: "Â•àËâØÁúå", wakayama: "ÂíåÊ≠åÂ±±Áúå",
        tottori: "È≥•ÂèñÁúå", shimane: "Â≥∂Ê†πÁúå", okayama: "Â≤°Â±±Áúå", hiroshima: "Â∫ÉÂ≥∂Áúå", yamaguchi: "Â±±Âè£Áúå", tokushima: "Âæ≥Â≥∂Áúå", kagawa: "È¶ôÂ∑ùÁúå", ehime: "ÊÑõÂ™õÁúå", kochi: "È´òÁü•Áúå",
        fukuoka: "Á¶èÂ≤°Áúå", saga: "‰ΩêË≥ÄÁúå", nagasaki: "Èï∑Â¥éÁúå", kumamoto: "ÁÜäÊú¨Áúå", oita: "Â§ßÂàÜÁúå", miyazaki: "ÂÆÆÂ¥éÁúå", kagoshima: "ÈπøÂÖêÂ≥∂Áúå", okinawa: "Ê≤ñÁ∏ÑÁúå",
        ogasawara: "Â∞èÁ¨†ÂéüË´∏Â≥∂", izu: "‰ºäË±ÜË´∏Â≥∂", sado: "‰ΩêÊ∏°Â≥∂", awaji: "Ê∑°Ë∑ØÂ≥∂", yakushima: "Â±ã‰πÖÂ≥∂", amami: "Â•ÑÁæéÂ§ßÂ≥∂", ishigaki: "Áü≥Âû£Â≥∂", miyako: "ÂÆÆÂè§Â≥∂"
    };
    console.log('%cLocationNames Object Initialized:', 'color: #28a745;', Object.keys(window.locationNames).length, 'locations');
}

// Remove all global state variables - managed by AppState now
// All display functions moved to event-handlers.mjs to prevent conflicts