// Áµ±‰∏ÄÁÆ°ÁêÜ„É¢„Éº„ÉÄ„É´„Ç∑„Çπ„ÉÜ„É† - Êó•Êú¨Ë™ûÁâà„Å®Ëã±Ë™ûÁâà„ÅÆÂÆåÂÖ®Áµ±‰∏Ä
console.log('üîÑ Áµ±‰∏ÄÁÆ°ÁêÜ„É¢„Éº„ÉÄ„É´„Ç∑„Çπ„ÉÜ„É†ÈñãÂßã');

class UnifiedManagementModal {
    constructor(language = 'ja') {
        this.language = language;
        this.isJapanese = language === 'ja';
        this.texts = this.getTexts();
        
        // Êó¢Â≠ò„ÅÆ„É¢„Éº„ÉÄ„É´Ë°®Á§∫Èñ¢Êï∞„Çí„Ç™„Éº„Éê„Éº„É©„Ç§„Éâ
        this.overrideExistingModals();
    }
    
    getTexts() {
        return {
            ja: {
                bookmarkTitle: '„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØÁÆ°ÁêÜ',
                comparisonTitle: 'ÊØîËºÉÁÆ°ÁêÜ',
                bookmarkInfo: '„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„Åó„Åü„Ç¨„Ç§„Éâ„ÇíÁÆ°ÁêÜ„Åß„Åç„Åæ„Åô„ÄÇ‰∏çË¶Å„Å™„ÇÇ„ÅÆ„ÅØÂâäÈô§„Åß„Åç„Åæ„Åô„ÄÇ',
                comparisonInfo: 'ÊØîËºÉ‰∏≠„ÅÆ„Ç¨„Ç§„Éâ„ÇíÁÆ°ÁêÜ„Åß„Åç„Åæ„Åô„ÄÇÊúÄÂ§ß3‰∫∫„Åæ„ÅßÈÅ∏ÊäûÂèØËÉΩ„Åß„Åô„ÄÇ',
                bookmarkEmpty: '„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„Åï„Çå„Åü„Ç¨„Ç§„Éâ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì',
                comparisonEmpty: 'ÊØîËºÉ„Åô„Çã„Ç¨„Ç§„Éâ„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì',
                removeBtn: 'ÂâäÈô§',
                clearAllBtn: 'ÂÖ®„Å¶ÂâäÈô§',
                closeBtn: 'Èñâ„Åò„Çã',
                startComparisonBtn: 'ÊØîËºÉÈñãÂßã',
                location: 'Êù±‰∫¨ÈÉΩ',
                confirmClearAll: 'ÂÖ®„Å¶„ÅÆ{type}„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü',
                removedAlert: '„Ç¨„Ç§„Éâ{id}„Çí{type}„Åã„ÇâÂâäÈô§„Åó„Åæ„Åó„Åü',
                clearedAlert: 'ÂÖ®„Å¶„ÅÆ{type}„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü'
            },
            en: {
                bookmarkTitle: 'Bookmark Management',
                comparisonTitle: 'Comparison Management',
                bookmarkInfo: 'Manage your bookmarked guides. Remove unwanted ones.',
                comparisonInfo: 'Manage guides for comparison. You can select up to 3 guides.',
                bookmarkEmpty: 'No bookmarked guides',
                comparisonEmpty: 'No guides selected for comparison',
                removeBtn: 'Remove',
                clearAllBtn: 'Clear All',
                closeBtn: 'Close',
                startComparisonBtn: 'Start Comparison',
                location: 'Tokyo',
                confirmClearAll: 'Clear all {type}?',
                removedAlert: 'Guide {id} removed from {type}',
                clearedAlert: 'All {type} cleared'
            }
        };
    }
    
    overrideExistingModals() {
        // Êó•Êú¨Ë™ûÁâà„ÅÆ„Ç™„Éº„Éê„Éº„É©„Ç§„Éâ
        if (window.ultimateJapaneseIcons) {
            window.ultimateJapaneseIcons.showManagementModal = (type) => {
                this.showUnifiedModal(type);
            };
        }
        
        // Ëã±Ë™ûÁâà„ÅÆ„Ç™„Éº„Éê„Éº„É©„Ç§„Éâ
        if (window.ultimateEnglishIcons) {
            window.ultimateEnglishIcons.showManagementModal = (type) => {
                this.showUnifiedModal(type);
            };
        }
        
        console.log('‚úÖ Êó¢Â≠ò„É¢„Éº„ÉÄ„É´Èñ¢Êï∞„Çí„Ç™„Éº„Éê„Éº„É©„Ç§„ÉâÂÆå‰∫Ü');
    }
    
    showUnifiedModal(type) {
        const isBookmark = type === 'bookmark';
        const t = this.texts[this.language];
        
        // ÈÅ©Âàá„Å™„Ç§„É≥„Çπ„Çø„É≥„Çπ„Åã„Çâ„Éá„Éº„Çø„ÇíÂèñÂæó
        const instance = this.isJapanese ? window.ultimateJapaneseIcons : window.ultimateEnglishIcons;
        if (!instance) {
            console.error('„Ç¢„Ç§„Ç≥„É≥„Ç∑„Çπ„ÉÜ„É†„ÅÆ„Ç§„É≥„Çπ„Çø„É≥„Çπ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
            return;
        }
        
        const guides = isBookmark ? instance.bookmarkedGuides : instance.comparedGuides;
        const title = isBookmark ? t.bookmarkTitle : t.comparisonTitle;
        const info = isBookmark ? t.bookmarkInfo : t.comparisonInfo;
        const emptyMessage = isBookmark ? t.bookmarkEmpty : t.comparisonEmpty;
        
        console.log(`üìã Áµ±‰∏Ä„É¢„Éº„ÉÄ„É´Ë°®Á§∫: ${type}, „Ç¨„Ç§„ÉâÊï∞: ${guides.length}`);
        
        if (guides.length === 0) {
            instance.showAlert(emptyMessage, 'info');
            return;
        }
        
        // Êó¢Â≠ò„É¢„Éº„ÉÄ„É´„ÇíÂâäÈô§
        this.removeExistingModals();
        
        // Êñ∞„Åó„ÅÑ„É¢„Éº„ÉÄ„É´„Çí‰ΩúÊàê
        const modal = this.createModalElement(type, title, info, guides, emptyMessage, t);
        document.body.appendChild(modal);
        
        // Bootstrap „É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
        const bsModal = new bootstrap.Modal(modal, {
            backdrop: 'static',
            keyboard: true
        });
        bsModal.show();
        
        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
        this.setupModalEvents(modal, type, bsModal, instance, t);
    }
    
    removeExistingModals() {
        // ÂÖ®„Å¶„ÅÆÊó¢Â≠ò„É¢„Éº„ÉÄ„É´„ÇíÂâäÈô§
        const existingModals = document.querySelectorAll('.modal[id*="management"], .modal[id*="bookmark"], .modal[id*="comparison"]');
        existingModals.forEach(modal => modal.remove());
        
        // „É¢„Éº„ÉÄ„É´ËÉåÊôØ„ÇÇÂâäÈô§
        const backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach(backdrop => backdrop.remove());
        
        // body „ÇØ„É©„Çπ„Çí„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
    }
    
    createModalElement(type, title, info, guides, emptyMessage, t) {
        const isBookmark = type === 'bookmark';
        const modalId = `unified-${type}-modal`;
        
        const modal = document.createElement('div');
        modal.id = modalId;
        modal.className = 'modal fade';
        modal.setAttribute('tabindex', '-1');
        modal.setAttribute('aria-labelledby', `${modalId}-title`);
        modal.setAttribute('aria-hidden', 'true');
        modal.style.zIndex = '1055';
        
        let guideListHTML = '';
        guides.forEach(guideId => {
            guideListHTML += `
                <div class="d-flex align-items-center justify-content-between p-3 border-bottom guide-management-item" data-guide-id="${guideId}">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <img src="https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=60&h=60&fit=crop&crop=face" 
                                 class="rounded-circle border" width="50" height="50" alt="${this.isJapanese ? '„Ç¨„Ç§„Éâ' : 'Guide'}${guideId}">
                        </div>
                        <div>
                            <h6 class="mb-1 fw-bold">${this.isJapanese ? '„Ç¨„Ç§„Éâ' : 'Guide'} ${guideId}</h6>
                            <small class="text-muted">${t.location}</small>
                        </div>
                    </div>
                    <button class="btn btn-outline-danger btn-sm remove-guide-btn" 
                            data-guide-id="${guideId}" data-type="${type}">
                        <i class="bi bi-x-circle me-1"></i>${t.removeBtn}
                    </button>
                </div>
            `;
        });
        
        modal.innerHTML = `
            <div class="modal-dialog modal-lg">
                <div class="modal-content shadow-lg border-0">
                    <div class="modal-header bg-light border-bottom">
                        <h5 class="modal-title fw-bold" id="${modalId}-title">
                            <i class="bi bi-${isBookmark ? 'bookmark-star text-warning' : 'list-check text-primary'} me-2"></i>${title}
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <div class="alert alert-info border-0 bg-light">
                                <i class="bi bi-info-circle me-2"></i>${info}
                            </div>
                        </div>
                        <div id="${type}-guide-list" class="border rounded">
                            ${guides.length > 0 ? guideListHTML : `<div class="text-center py-4 text-muted">${emptyMessage}</div>`}
                        </div>
                    </div>
                    <div class="modal-footer bg-light border-top">
                        <button type="button" class="btn btn-outline-danger" id="clear-all-${type}">
                            <i class="bi bi-trash me-1"></i>${t.clearAllBtn}
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-lg me-1"></i>${t.closeBtn}
                        </button>
                        ${!isBookmark ? `<button type="button" class="btn btn-primary" id="start-comparison">
                            <i class="bi bi-play-circle me-1"></i>${t.startComparisonBtn}
                        </button>` : ''}
                    </div>
                </div>
            </div>
        `;
        
        return modal;
    }
    
    setupModalEvents(modal, type, bsModal, instance, t) {
        const isBookmark = type === 'bookmark';
        const typeText = isBookmark ? (this.isJapanese ? '„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ' : 'bookmarks') : (this.isJapanese ? 'ÊØîËºÉÂØæË±°' : 'comparison');
        
        // ÂÄãÂà•ÂâäÈô§„Éú„Çø„É≥
        modal.addEventListener('click', (e) => {
            if (e.target.closest('.remove-guide-btn')) {
                const btn = e.target.closest('.remove-guide-btn');
                const guideId = parseInt(btn.dataset.guideId);
                
                this.removeGuide(guideId, type, instance, t, typeText);
                
                // UIÊõ¥Êñ∞
                const item = btn.closest('.guide-management-item');
                item.remove();
                
                // „É™„Çπ„Éà„ÅåÁ©∫„Å´„Å™„Å£„ÅüÂ†¥Âêà
                const list = modal.querySelector(`#${type}-guide-list`);
                if (list.children.length === 0) {
                    const emptyMessage = isBookmark ? t.bookmarkEmpty : t.comparisonEmpty;
                    list.innerHTML = `<div class="text-center py-4 text-muted">${emptyMessage}</div>`;
                }
            }
        });
        
        // ÂÖ®„Å¶ÂâäÈô§„Éú„Çø„É≥
        const clearAllBtn = modal.querySelector(`#clear-all-${type}`);
        if (clearAllBtn) {
            clearAllBtn.addEventListener('click', () => {
                const confirmMessage = t.confirmClearAll.replace('{type}', typeText);
                if (confirm(confirmMessage)) {
                    this.clearAllGuides(type, instance, t, typeText);
                    bsModal.hide();
                }
            });
        }
        
        // ÊØîËºÉÈñãÂßã„Éú„Çø„É≥
        const startComparisonBtn = modal.querySelector('#start-comparison');
        if (startComparisonBtn) {
            startComparisonBtn.addEventListener('click', () => {
                instance.startComparison();
            });
        }
    }
    
    removeGuide(guideId, type, instance, t, typeText) {
        if (type === 'bookmark') {
            instance.removeFromBookmarks(guideId);
        } else {
            instance.removeFromComparison(guideId);
        }
        
        const message = t.removedAlert.replace('{id}', guideId).replace('{type}', typeText);
        instance.showAlert(message, 'success');
    }
    
    clearAllGuides(type, instance, t, typeText) {
        if (type === 'bookmark') {
            instance.clearAllBookmarks();
        } else {
            instance.clearAllComparisons();
        }
        
        const message = t.clearedAlert.replace('{type}', typeText);
        instance.showAlert(message, 'success');
    }
}

// Êó•Êú¨Ë™ûÁâàÁî®„Ç§„É≥„Çπ„Çø„É≥„Çπ
if (!window.location.pathname.includes('index-en')) {
    window.unifiedManagementModal = new UnifiedManagementModal('ja');
    console.log('üáØüáµ Êó•Êú¨Ë™ûÁâàÁµ±‰∏ÄÁÆ°ÁêÜ„É¢„Éº„ÉÄ„É´ÂàùÊúüÂåñÂÆå‰∫Ü');
} else {
    window.unifiedManagementModal = new UnifiedManagementModal('en');
    console.log('üá∫üá∏ Ëã±Ë™ûÁâàÁµ±‰∏ÄÁÆ°ÁêÜ„É¢„Éº„ÉÄ„É´ÂàùÊúüÂåñÂÆå‰∫Ü');
}

console.log('‚úÖ Unified Management Modal System Loaded');